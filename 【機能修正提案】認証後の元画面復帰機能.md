# 【機能修正提案】認証後の元画面復帰機能

- **サービス**: `account`
- **セクション**: `authentication`
- **関連ドキュメント**:
  - `develop/account/authentication/func-spec.md`
  - `app/specs/account/authentication-spec.yaml`
  - `app/specs/account/common-spec.yaml`

---

## 1. 提案概要

全認証パス（Google OAuth・メール/パスワードログイン・会員登録）で、認証完了後にユーザーが元いた画面に戻るようにし、固定の `/account` リダイレクトを廃止する。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- **メール/パスワードログイン・会員登録**: `redirect-url` パラメータを hidden フィールドで引き継ぎ、認証後にリダイレクト → **既に動作している**
- **Google OAuth**: ログインページの Google ボタンが `/auth/google` に直リンクしており `redirect-url` を渡さない → OAuth フローは常に `/account` にリダイレクト
- **ユーザー体験の問題**: ブログ記事閲覧中にログインすると、マイページに飛ばされ記事を再度探す必要がある

### 修正後 (To-Be)

- **Google OAuth ボタン**: `/auth/google?redirect-url={元のURL}` でリダイレクト先を伝搬
- **auth.google.tsx**: `redirect-url` を Cookie に保存してから Google へリダイレクト
- **auth.callback.google.tsx**: Cookie から `redirect-url` を読み取り、そこにリダイレクト（なければ `/account`）
- **全認証パスで統一的な元画面復帰**が実現

### 変更対象ファイルと影響範囲

| ファイル | 変更内容 |
|---------|---------|
| `app/routes/login.tsx` | Google ボタンの href に `redirect-url` を付与 |
| `app/routes/auth.google.tsx` | `redirect-url` を Cookie に保存 |
| `app/routes/auth.callback.google.tsx` | Cookie から `redirect-url` を読み取り、リダイレクト先を決定 |
| `app/specs/account/authentication-spec.yaml` | `oauth.google.redirect_cookie` 定義を追加 |
| `app/specs/account/types.ts` | `redirect_cookie` 型を追加 |
| `tests/routes/auth.google.test.tsx` | redirect-url Cookie テスト追加 |

## 3. 背景・目的

### 背景

Google OAuth フローが既存の `redirect-url` メカニズムに参加していないため、OAuth 認証後は常に `/account` にリダイレクトされる。メール/パスワード認証では既に redirect-url が機能しているが、OAuth だけが取り残されている。

### 目的

- **UX 向上**: 認証後に元の画面に自動復帰し、ユーザーの操作を中断しない
- **認証パスの統一**: OAuth もフォーム認証と同じ redirect-url メカニズムに参加させる
- **SSoT 原則の遵守**: Cookie 名・属性を spec.yaml で一元管理

## 4. 変更の妥当性 (Pros / Cons)

Pros (利点):

- OAuth フローがフォーム認証と同じ redirect-url メカニズムに統合される
- ユーザーが認証フローで文脈を失わない（特にブログ → 認証 → ブログの導線）
- 既存の `oauth_state` Cookie と同じパターンで実装でき、複雑性が低い
- Cookie 属性を spec.yaml で管理するため SSoT 原則を維持

Cons (懸念点):

- Cookie が1つ増える（`oauth_redirect`）→ ただし短命（10分）で自動削除
- オープンリダイレクト攻撃のリスク → redirect-url のバリデーション（同一オリジン制限）で対策

**総合評価**:
既存メカニズムの自然な拡張であり、OAuth フローの欠落を埋める修正として妥当性が高い。リダイレクト先のバリデーションを含めることでセキュリティも担保する。

## 5 設計フロー

*Phase 2 で記載*

## 6 TDD_WORK_FLOW.md 簡易版

*Phase 3 で記載*
