# 【機能修正提案】ブログ記事アクセス制御：割合ベースから見出しベースへの変更

- **サービス**: `blog`
- **セクション**: `post-detail`
- **関連ドキュメント**:
  - `blog記事アクセス制御機能追加.md` (既存実装)
  - `develop/blog/post-detail/func-spec.md`
  - `develop/blog/post-detail/uiux-spec.md`
  - `develop/blog/post-detail/file-list.md`
  - `develop/blog/post-detail/data-flow-diagram.md`
  - `scripts/lint-blog-metadata/` (リントシステム)

---

## 1. 提案概要

ブログ記事の公開範囲指定を「割合ベース（`freeContentPercentage`）」から「見出しベース（`freeContentHeading`）」に変更し、より直感的でnote型ペイウォールに近いUXを実現します。また、メタデータの妥当性を保証するため、blog-metadata-lint-systemに見出し検証ルールを追加します。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- 記事のfrontmatterで`freeContentPercentage`（0-100の数値）を指定
- システムが文字数ベースで指定割合までのコンテンツを自動抽出
- 文章の途中で切れる可能性があり、UXが不自然

```yaml
---
slug: "example"
title: "サンプル記事"
freeContentPercentage: 30  # 最初の30%まで公開
---

## はじめに
この部分は公開される可能性が高い

## 本編
ここは30%に入るか入らないか不明確
途中の段落で切れる可能性がある  ← 👈 不自然な切れ方
```

**問題点**:
- 編集時に公開範囲が予測しにくい（文章を追加すると割合が変わる）
- 意味的な区切りではなく、機械的な区切りになる
- noteやMediumのような自然なペイウォール体験と異なる

### 修正後 (To-Be)

- 記事のfrontmatterで`freeContentHeading`（見出し名）を指定
- 指定された見出しの**終わりまで**を公開範囲とする
- 意味的な区切りで自然にペイウォールを配置

```yaml
---
slug: "example"
title: "サンプル記事"
freeContentHeading: "## 概要"  # この見出しの終わりまで公開
---

## はじめに
この部分は公開

## 概要
この部分も公開
（この見出しの終わりまで公開）

## 本編  ← 👈 ここからペイウォール
ここからは有料会員のみ
```

**改善点**:
- 編集しても公開範囲が明確（見出し構造は変わりにくい）
- 意味的な区切りで自然なペイウォール体験
- noteやMediumと同じUX

**リント追加**:
- `freeContentHeading`で指定した見出しが実際に記事内に存在するかチェック
- 見出しのタイポや重複を検出
- 見出しレベル（`##`）の妥当性を検証

## 3. 背景・目的

### 背景

既存実装（割合ベース）には以下の課題がありました：

1. **編集時の予測困難性**: 記事を編集する度に、どこまで公開されるか再計算が必要
2. **不自然な切れ方**: 文章の途中でペイウォールが出現し、読者体験が悪い
3. **業界標準との乖離**: note、Medium、Substackなど主要なコンテンツプラットフォームは見出しベースを採用

さらに、割合ベースの実装では「メタデータの妥当性検証」が困難でした。数値が0-100の範囲内であればリント通過してしまうため、意図しない公開範囲になるリスクがありました。

### 目的

- **目的1**: **UXの向上** - note型ペイウォールの標準的な体験を提供し、読者が自然に「続きを読みたい」と思えるポイントでペイウォールを配置
- **目的2**: **編集者の認知負荷軽減** - 「この見出しまで公開」という直感的な指定で、編集中も公開範囲を容易に把握
- **目的3**: **品質保証の強化** - リントシステムで見出しの存在を検証し、設定ミスによる意図しない公開/非公開を防止
- **目的4**: **業界標準への準拠** - 主要コンテンツプラットフォームと同じUXパターンを採用し、ユーザーの学習コストを削減

## 4. 変更の妥当性 (Pros / Cons)

Pros (利点):

- **UX品質の大幅向上**: 文章の意味的な区切りで自然にペイウォールを配置でき、読者体験が向上
- **編集者フレンドリー**: 「どの見出しまで公開するか」という直感的な指定で、編集中も公開範囲が明確
- **リント可能**: メタデータで指定した見出しが実際に存在するか自動検証でき、品質保証が強化される
- **業界標準との整合性**: note、Medium、Substackと同じUXパターンで、ユーザーの学習コストが低い
- **保守性向上**: 見出し構造は記事の骨格なので変わりにくく、長期的に安定した運用が可能
- **プレビルド思想との親和性**: 見出しはMarkdown解析で一度抽出すれば良く、実装がシンプル

Cons (懸念点):

- **実装変更コスト**: 既存の割合ベース実装を見直す必要がある
  - `determineContentVisibility.ts`のシグネチャ変更
  - Markdown解析ロジックの追加
  - テストの全面的な修正
- **リントシステムの拡張が必須**: 見出し検証ルールを追加しないと、設定ミスを検出できない
- **後方互換性の考慮**: 既存の`freeContentPercentage`を使用している記事（現在0件だが将来的に）への対応方針が必要
- **Markdown解析の複雑性**: 見出しの抽出、次の見出しまでの範囲特定、エッジケース（見出しが存在しない等）への対応が必要
- **見出し構造への依存**: 記事に適切な見出し構造がないと機能しない（ただし、ブログ記事には通常見出しが存在）

**総合評価**:

Consは実装コストと複雑性の増加ですが、これらは一時的な課題です。一方、Prosは**長期的なUX品質、保守性、業界標準への準拠**という、プロダクトの本質的な価値を高めます。

特に重要なのは以下の3点です：

1. **プレビルド思想との親和性**: ClaudeMixは「エッジ環境での動的処理を避け、ビルド時に事前生成」という思想を採用しています。見出しベースの実装は、Markdown解析時に一度見出しを抽出すれば良く、この思想と完全に整合します。

2. **リント可能な設計**: ClaudeMixは「AIコーディングの品質をリントで担保」という方針を採用しています。見出しベースにすることで、メタデータの妥当性を自動検証でき、この方針を強化します。

3. **note型ペイウォールの実現**: プロダクトの目標である「コンテンツの収益化支援」において、業界標準のUXパターンを採用することは極めて重要です。

したがって、この変更は**非常に妥当性が高く、ClaudeMixのアーキテクチャ思想と完全に整合する**と判断します。実装コストは一時的ですが、得られる価値は長期的かつ本質的です。
