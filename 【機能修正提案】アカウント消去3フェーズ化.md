# 【機能修正提案】アカウント消去の3フェーズ化（論理削除 → 冬眠 → 物理抹消）

- **サービス**: `account`
- **セクション**: `profile`
- **関連ドキュメント**:
  - `アカウント消去機能 アップデート要件定義書.md`（要件定義書）
  - `develop/account/profile/func-spec.md`
  - `develop/account/profile/uiux-spec.md`
  - `app/specs/account/profile-spec.yaml`
  - `develop/account/profile/file-list.md`
  - `develop/account/profile/data-flow-diagram.md`
  - `develop/account/GUIDING_PRINCIPLES.md`

---

## 1. 提案概要

アカウント削除時の即時物理削除を廃止し、**論理削除（冬眠）→ 30日保持 → バッチ物理抹消**の3フェーズ制に移行することで、Stripe Webhookの着地先喪失を防ぎ、誤退会ユーザーへの復旧手段を確保する。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- ユーザーが「アカウント削除」を実行すると、以下が**即時**に行われる：
  1. Stripeサブスクリプション即時解約（`cancelStripeSubscription.server`）
  2. サブスクリプションレコード削除（D1）
  3. ユーザーデータ物理削除（D1 `DELETE FROM users`）
  4. 全セッション削除（Workers KV）
  5. `/login` へリダイレクト
- 削除後は一切の復旧手段がない
- Stripe按分決済（退会後に遅れて届くWebhook）の着地先が存在しなくなる
- `deleteUser.server.ts` は `DELETE FROM users WHERE id = ?` を実行

### 修正後 (To-Be)

#### ① 退会実行フェーズ（即時）

- `users` テーブルの `deleted_at` カラムに現在時刻を記録（論理削除）
- 全セッション無効化、以降のログイン拒否
- Stripeサブスクリプション停止（`Customer` オブジェクトは保持）
- ユーザーデータ・サブスクリプションレコードは**削除しない**

#### ② 冬眠フェーズ（1〜30日間）

- 同一メールアドレスでの新規登録をブロック（DB Unique制約を活用）
- Stripeからの遅延Webhookを既存 `user_id` で正しく受信・ログ出力
- （将来的にアカウント復旧UIを追加する余地を残す）

#### ③ 物理抹消フェーズ（31日目以降）

- バッチ処理（Cron / Scheduled Worker）で `deleted_at < NOW() - 30 days` のレコードを物理削除
- Stripe `Customer` オブジェクトの削除リクエスト送信
- 物理削除後は検索不可能

## 3. 背景・目的

### 背景

現在の即時物理削除には以下の問題がある：

1. **Stripe Webhookエラー**: 退会後に按分決済の完了通知が届いた際、対応するユーザーが存在せず404エラーが発生する。Stripeは繰り返しリトライを行い、最終的にアラートが発生する
2. **誤退会の不可逆性**: 操作ミスで退会したユーザーのデータ復旧手段が一切ない
3. **データ不整合**: 物理削除のタイミングでStripe API呼び出しが失敗した場合、「ユーザーは消えたがStripe課金は継続する」という致命的な不整合が発生しうる

### 目的

- **目的1**: Stripe Webhookの安全な着地先を冬眠期間中に確保し、決済エラーを根絶する
- **目的2**: 誤退会ユーザーに対する30日間の復旧猶予を提供する
- **目的3**: DB Unique制約を活用した最小コードでの再登録防止を実現する
- **目的4**: 物理削除の自動化により、個人情報の確実な抹消を保証する

## 4. 変更の妥当性 (Pros / Cons)

Pros (利点):

- **Stripe連携の堅牢性**: 冬眠中にWebhookの着地先が維持されるため、按分決済や遅延通知でエラーが発生しない
- **最小の実装コスト**: DB Unique制約を活用し、再登録防止に追加コードが不要。`deleted_at` カラム1つの追加で論理削除を実現
- **ユーザー保護**: 誤退会の復旧可能性を30日間維持（将来の復旧UI追加も容易）
- **プライバシー保護**: 30日後に物理削除が自動実行されるため、GDPR等のデータ削除要件にも対応可能
- **べき等なWebhook処理**: 物理削除後の遅延Webhookに対しても200を返す「枯れた設計」

Cons (懸念点):

- **バッチ処理の新規追加**: Cloudflare Workers Cron Triggerまたは Scheduled Workerの導入が必要。既存のアーキテクチャに新しいレイヤーが追加される
- **ログイン・登録フローへの影響**: 論理削除ユーザーの存在チェックが認証・登録ロジックに波及する
- **テスト範囲の拡大**: E2Eテストにバッチ処理のテストが追加される（ただしCronは統合テストで検証可能）
- **即時削除の期待とのギャップ**: ユーザーに「30日後に完全削除される」ことを適切に説明するUI変更が必要

**総合評価**:

Consはいずれも管理可能な範囲であり、特にStripe連携の堅牢性とデータ不整合の根絶は、サービスの信頼性に直結する重大な改善です。GUIDING_PRINCIPLES.mdで定義されたデータストレージ戦略（D1 + KVのハイブリッド）とも整合し、Cloudflare Workers Cron Triggerという既存エコシステム内の機能で実現可能なため、**妥当性は非常に高い**と判断します。

## 5 設計フロー

### 🗾GUIDING_PRINCIPLES.md

**変更あり** — 2箇所

1. **セクション 2.1「退会フロー」の更新**（L74-77付近）

   現在の記載:

   ```text
   退会フロー:
   1. アカウント削除要求 → D1でサブスクリプション確認・削除 → D1でユーザー削除 (CASCADE)
   2. KVからセッション削除 → Cookieクリア
   ```

   修正後:

   ```text
   退会フロー（3フェーズ制）:
   1. 退会実行: アカウント削除要求 → D1でサブスクリプション確認 → Stripeサブスクリプション停止（Customer保持）→ D1でusers.deleted_atに現在時刻を記録（論理削除）→ KVから全セッション削除 → Cookieクリア
   2. 冬眠（1〜30日間）: ログイン拒否、同一メール再登録ブロック（Unique制約）、Stripe Webhook受信継続
   3. 物理抹消（31日目〜）: Scheduled Workerがdeleted_at < 30日前のレコードを物理DELETE → Stripe Customer削除
   ```

2. **セクション 4「データフロー」項目6の更新**（L192付近）

   現在の記載:

   ```text
   6. **退会処理**: Route → data-io（アクティブなサブスクリプション確認）→ data-io（Stripeサブスクリプション即時解約）→ data-io（D1: subscriptionsテーブル削除）→ data-io（D1: usersテーブル削除）→ lib（全セッション破棄）→ /loginへリダイレクト
   ```

   修正後:

   ```text
   6. **退会処理（論理削除）**: Route → data-io（アクティブなサブスクリプション確認）→ data-io（Stripeサブスクリプション停止、Customer保持）→ data-io（D1: users.deleted_atに現在時刻を記録）→ lib（全セッション破棄）→ /loginへリダイレクト
   7. **物理抹消（バッチ）**: Scheduled Worker → data-io（deleted_at < 30日前のユーザー取得）→ data-io（Stripe Customer削除）→ data-io（D1: subscriptions物理DELETE）→ data-io（D1: users物理DELETE）→ ログ出力
   ```

---

### 📚️func-spec.md

**変更あり** — profileセクション + 他セクションへの波及

#### profile セクション: アカウント削除（セクション4）の全面改訂

**処理フロー**を以下に差し替え:

1. 削除確認ダイアログ表示
2. アクティブなサブスクリプションの確認（D1: subscriptionsテーブル）
3. サブスクリプション期間中の場合、強力な警告を表示（既存と同じ）
4. パスワード検証
5. サブスクリプションが存在する場合、Stripeサブスクリプション停止（`cancel_at_period_end = true` または即時停止。**Customer オブジェクトは削除しない**）
6. `users` テーブルの `deleted_at` に現在時刻を記録（**物理削除しない**）
7. すべてのセッション削除（Workers KV）
8. `/login`へリダイレクト + 「退会手続きを受け付けました。30日後にデータが完全に削除されます」メッセージ

**セキュリティ要件の更新**:

- ~~削除は取り消し不可能であることを明示~~ → 「30日間の冬眠期間後にデータが完全削除される」ことを明示
- 論理削除後は全セッション破棄、ログイン拒否

#### 新規機能: 物理抹消バッチ処理

- Cloudflare Workers Scheduled Handler（Cron Trigger）として実装
- 実行間隔: 1日1回（深夜帯推奨）
- 処理内容:
  1. `SELECT * FROM users WHERE deleted_at < datetime('now', '-30 days')` でレコード取得
  2. 各ユーザーに対して Stripe Customer 削除（`stripe.customers.del(stripe_customer_id)`）
  3. D1: `DELETE FROM subscriptions WHERE user_id = ?`
  4. D1: `DELETE FROM users WHERE id = ?`
  5. 実行結果をログ出力（成功件数、失敗件数）
  6. 失敗時はアラート（将来的にメール通知等）

#### 新規機能: アカウント復旧（冬眠中のみ）

冬眠中ユーザーがログインを試みた際に、アカウントを復旧できる「優しい防衛」導線。

- **トリガー**: ログインページでメール/パスワードを入力し、該当ユーザーの `deleted_at` が非NULL
- **UI**: ログインフォーム上に専用メッセージ「このアカウントは退会手続き中です。復旧しますか？」+ 「アカウントを復旧する」ボタンを表示
- **復旧処理フロー**:
  1. パスワード検証（ログイン時に既に入力済み）
  2. `restoreUser.server`（`UPDATE users SET deleted_at = NULL WHERE id = ?`）
  3. セッション生成 → `/account` へリダイレクト
- **Stripeサブスクリプション**: 自動再開はしない。ユーザーが必要であれば `/account/subscription` から再契約

#### authentication セクションへの波及（2箇所）

1. **ログイン処理** — `findUserByEmail` で取得したユーザーの `deleted_at` が非NULLの場合、通常のログインを拒否。専用メッセージ「このアカウントは退会手続き中です。復旧しますか？」を表示し、復旧ボタン（intent=`restore-account`）を提供

2. **会員登録処理** — `checkEmailExists` で取得したメールアドレスの `deleted_at` が非NULLの場合、「退会手続き中のアカウントが存在します」メッセージを表示し、ログインページへの導線を提供（復旧はログインページから行う）

#### subscription セクションへの波及（1箇所）

- **Webhook処理** — `user_id` で検索してユーザーが物理削除済み（レコード不在）の場合、404ではなく200を返し「対象ユーザー不在」をログに記録する（べき等性の確保）

---

### 🖼️uiux-spec.md

**変更あり** — アカウント削除UIの状態遷移・メッセージ更新

1. **警告メッセージの変更**

   - 現在: 「この操作は取り消しできません。すべてのデータが削除されます。」
   - 修正: 「退会すると即座にアクセスできなくなります。30日後にすべてのデータが完全に削除されます。」

2. **アカウント削除UIの状態遷移**

   `Success` 状態の動作を変更:
   - 現在: `/login` へリダイレクト（即時削除完了）
   - 修正: `/login` へリダイレクト + フラッシュメッセージ「退会手続きを受け付けました。30日後にデータが完全に削除されます。」

3. **インタラクション設計（アカウント削除フロー）のシーケンス図更新**

   ```text
   Server->>Server: users.deleted_atに現在時刻を記録（論理削除）
   ```

   に差し替え（「ユーザーデータ削除」を削除）

---

### 📋️spec.yaml

**変更あり** — メッセージ・設定値の追加・更新

1. **`forms.delete_account.warning_message` の更新**

   ```yaml
   warning_message: "退会すると即座にアクセスできなくなります。30日後にすべてのデータが完全に削除されます。"
   ```

2. **`success_messages.delete_account` の更新**

   ```yaml
   delete_account:
     completed: "退会手続きを受け付けました。30日後にデータが完全に削除されます。"
   ```

3. **`security.delete_account` の更新**

   ```yaml
   delete_account:
     delete_all_sessions: true
     soft_delete: true          # 追加: 論理削除フラグ
     hibernation_days: 30       # 追加: 冬眠期間（日数）
     redirect_after_delete: "/login"
   ```

4. **冬眠ユーザー向けメッセージの追加**

   ```yaml
   error_messages:
     # 既存のセクションに追加
     hibernation:
       login_blocked: "このアカウントは退会手続き中です"
       registration_blocked: "退会手続き中のアカウントが存在します"
   ```

---

### 🗂️file_list.md

**変更あり** — ファイルの差し替え・新規追加

1. **data-io層の変更**

   | 変更種別 | ファイル | パス | 備考 |
   | :--- | :--- | :--- | :--- |
   | **名称変更** | ~~deleteUser.server.ts~~ → `softDeleteUser.server.ts` | `app/data-io/account/profile/softDeleteUser.server.ts` | `UPDATE users SET deleted_at = NOW()` に変更 |
   | **名称変更** | ~~deleteUser.server.test.ts~~ → `softDeleteUser.server.test.ts` | `app/data-io/account/profile/softDeleteUser.server.test.ts` | テスト内容も論理削除に変更 |
   | **新規** | `purgeExpiredUsers.server.ts` | `app/data-io/account/profile/purgeExpiredUsers.server.ts` | 冬眠期間超過ユーザーの物理削除 + Stripe Customer削除 |
   | **新規** | `purgeExpiredUsers.server.test.ts` | `app/data-io/account/profile/purgeExpiredUsers.server.test.ts` | バッチ処理のテスト |

2. **Scheduled Worker（新規カテゴリ）**

   | 変更種別 | ファイル | パス | 備考 |
   | :--- | :--- | :--- | :--- |
   | **新規** | `scheduled.ts` | `app/scheduled.ts`（または `workers/scheduled.ts`） | Cloudflare Workers Cron Trigger エントリポイント。`purgeExpiredUsers.server` を呼び出す |

3. **lib層の変更**

   変更なし（`validateAccountDeletion.ts` のバリデーションロジック自体は不変。メッセージ変更は spec.yaml 側で吸収）

4. **依存関係サマリーの更新**

   Subscription セクションへの依存を以下に修正:
   - `getSubscriptionByUserId.server.ts`: ユーザーのアクティブなサブスクリプション取得（変更なし）
   - `cancelStripeSubscription.server.ts`: Stripeサブスクリプション停止（**Customer保持**に変更）
   - ~~`deleteSubscription.server.ts`~~: **退会実行時には呼び出さない**（物理抹消バッチで処理）

---

### 🧬data-flow-diagram.md

**変更あり** — アカウント削除フローの全面差し替え + バッチ処理フロー追加

1. **アカウント削除フロー（論理削除版）**

   ```mermaid
   graph TD
       User((ユーザー)) --> ProfileDisplay["ProfileDisplay"]
       ProfileDisplay -- "削除ボタンクリック" --> DeleteModal["Modal (common)"]
       DeleteModal -- "モーダル表示" --> CheckSub["サブスクリプション状態確認"]

       CheckSub -- "アクティブあり" --> ShowWarning["強力な警告表示"]
       CheckSub -- "なし" --> DeleteModal
       ShowWarning -- "期間放棄を確認" --> DeleteModal

       DeleteModal -- "削除確認" --> Action["account.settings action"]

       Action --> Validate["validateAccountDeletion (lib)"]
       Validate --> FindUser["findUserByEmail.server"]
       FindUser --> VerifyPwd["verifyPassword (lib/auth)"]
       VerifyPwd --> CheckSubAgain["サブスクリプション存在確認"]
       CheckSubAgain -- "あり" --> StopStripe["Stripeサブスクリプション停止<br/>(Customer保持)"]
       CheckSubAgain -- "なし" --> SoftDelete
       StopStripe --> SoftDelete["softDeleteUser.server<br/>(deleted_atに現在時刻を記録)"]
       SoftDelete --> DeleteSessions["deleteAllUserSessions.server"]
       DeleteSessions --> Redirect["/login へリダイレクト<br/>+ 冬眠開始メッセージ"]

       style DeleteModal fill:#ffcccc
       style SoftDelete fill:#fff4e1
       style Redirect fill:#ffcccc
   ```

2. **物理抹消バッチフロー（新規追加）**

   ```mermaid
   graph TD
       Cron["Scheduled Worker<br/>(Cron Trigger: 1日1回)"] --> Query["D1: deleted_at < 30日前<br/>のユーザー取得"]
       Query --> Loop["各ユーザーに対して"]
       Loop --> StripeDelete["Stripe Customer削除"]
       StripeDelete --> SubDelete["D1: subscriptions DELETE"]
       SubDelete --> UserDelete["D1: users 物理DELETE"]
       UserDelete --> Log["実行ログ出力"]

       StripeDelete -- "失敗" --> ErrorLog["エラーログ + アラート<br/>(ユーザー削除はスキップ)"]

       style Cron fill:#e8f5e9
       style ErrorLog fill:#ff6666
   ```

3. **セキュリティフロー「アカウント削除時の処理」の更新**

   現在の「即時削除」フローを以下に差し替え:

   ```text
   アカウント退会確認 → Stripeサブスクリプション停止(Customer保持) → softDeleteUser(論理削除) → deleteAllUserSessions → /login + 冬眠メッセージ
   ```

4. **コンポーネント責務テーブルの更新**

   `account.settings.tsx` の責務に「論理削除（softDeleteUser呼び出し）」を明記

## 6 TDD_WORK_FLOW.md 簡易版

Phase 3で記載します。

### 👁️e2e-screen-test

### 👁️e2e-section-test

### 🎨CSS実装 (layer2.css, layer3.ts, layer4.ts)

### 🪨route

### 🚧components.test

### 🪨components

### 🚧logic.test

### 🪨logic

### 🚧data-io.test

### 🪨data-io

### その他
