# ã€æ©Ÿèƒ½ä¿®æ­£ææ¡ˆã€‘ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¶ˆå»ã®3ãƒ•ã‚§ãƒ¼ã‚ºåŒ–ï¼ˆè«–ç†å‰Šé™¤ â†’ å†¬çœ  â†’ ç‰©ç†æŠ¹æ¶ˆï¼‰

- **ã‚µãƒ¼ãƒ“ã‚¹**: `account`
- **ã‚»ã‚¯ã‚·ãƒ§ãƒ³**: `profile`
- **é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**:
  - `ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¶ˆå»æ©Ÿèƒ½ ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆè¦ä»¶å®šç¾©æ›¸.md`ï¼ˆè¦ä»¶å®šç¾©æ›¸ï¼‰
  - `develop/account/profile/func-spec.md`
  - `develop/account/profile/uiux-spec.md`
  - `app/specs/account/profile-spec.yaml`
  - `develop/account/profile/file-list.md`
  - `develop/account/profile/data-flow-diagram.md`
  - `develop/account/GUIDING_PRINCIPLES.md`

---

## 1. ææ¡ˆæ¦‚è¦

ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ™‚ã®å³æ™‚ç‰©ç†å‰Šé™¤ã‚’å»ƒæ­¢ã—ã€**è«–ç†å‰Šé™¤ï¼ˆå†¬çœ ï¼‰â†’ 30æ—¥ä¿æŒ â†’ ãƒãƒƒãƒç‰©ç†æŠ¹æ¶ˆ**ã®3ãƒ•ã‚§ãƒ¼ã‚ºåˆ¶ã«ç§»è¡Œã™ã‚‹ã“ã¨ã§ã€Stripe Webhookã®ç€åœ°å…ˆå–ªå¤±ã‚’é˜²ãã€èª¤é€€ä¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å¾©æ—§æ‰‹æ®µã‚’ç¢ºä¿ã™ã‚‹ã€‚

## 2. å¤‰æ›´å†…å®¹ (As-Is / To-Be)

### ç¾çŠ¶ (As-Is)

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã€ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ä»¥ä¸‹ãŒ**å³æ™‚**ã«è¡Œã‚ã‚Œã‚‹ï¼š
  1. Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å³æ™‚è§£ç´„ï¼ˆ`cancelStripeSubscription.server`ï¼‰
  2. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ¬ã‚³ãƒ¼ãƒ‰å‰Šé™¤ï¼ˆD1ï¼‰
  3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ç‰©ç†å‰Šé™¤ï¼ˆD1 `DELETE FROM users`ï¼‰
  4. å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆWorkers KVï¼‰
  5. `/login` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- å‰Šé™¤å¾Œã¯ä¸€åˆ‡ã®å¾©æ—§æ‰‹æ®µãŒãªã„
- StripeæŒ‰åˆ†æ±ºæ¸ˆï¼ˆé€€ä¼šå¾Œã«é…ã‚Œã¦å±ŠãWebhookï¼‰ã®ç€åœ°å…ˆãŒå­˜åœ¨ã—ãªããªã‚‹
- `deleteUser.server.ts` ã¯ `DELETE FROM users WHERE id = ?` ã‚’å®Ÿè¡Œ

### ä¿®æ­£å¾Œ (To-Be)

#### â‘  é€€ä¼šå®Ÿè¡Œãƒ•ã‚§ãƒ¼ã‚ºï¼ˆå³æ™‚ï¼‰

- `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `deleted_at` ã‚«ãƒ©ãƒ ã«ç¾åœ¨æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆè«–ç†å‰Šé™¤ï¼‰
- å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–ã€ä»¥é™ã®ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦
- Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åœæ­¢ï¼ˆ`Customer` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä¿æŒï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ»ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ¬ã‚³ãƒ¼ãƒ‰ã¯**å‰Šé™¤ã—ãªã„**

#### â‘¡ å†¬çœ ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ1ã€œ30æ—¥é–“ï¼‰

- åŒä¸€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã®æ–°è¦ç™»éŒ²ã‚’ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆDB Uniqueåˆ¶ç´„ã‚’æ´»ç”¨ï¼‰
- Stripeã‹ã‚‰ã®é…å»¶Webhookã‚’æ—¢å­˜ `user_id` ã§æ­£ã—ãå—ä¿¡ãƒ»ãƒ­ã‚°å‡ºåŠ›
- ï¼ˆå°†æ¥çš„ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¾©æ—§UIã‚’è¿½åŠ ã™ã‚‹ä½™åœ°ã‚’æ®‹ã™ï¼‰

#### â‘¢ ç‰©ç†æŠ¹æ¶ˆãƒ•ã‚§ãƒ¼ã‚ºï¼ˆ31æ—¥ç›®ä»¥é™ï¼‰

- ãƒãƒƒãƒå‡¦ç†ï¼ˆCron / Scheduled Workerï¼‰ã§ `deleted_at < NOW() - 30 days` ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç‰©ç†å‰Šé™¤
- Stripe `Customer` ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
- ç‰©ç†å‰Šé™¤å¾Œã¯æ¤œç´¢ä¸å¯èƒ½

## 3. èƒŒæ™¯ãƒ»ç›®çš„

### èƒŒæ™¯

ç¾åœ¨ã®å³æ™‚ç‰©ç†å‰Šé™¤ã«ã¯ä»¥ä¸‹ã®å•é¡ŒãŒã‚ã‚‹ï¼š

1. **Stripe Webhookã‚¨ãƒ©ãƒ¼**: é€€ä¼šå¾Œã«æŒ‰åˆ†æ±ºæ¸ˆã®å®Œäº†é€šçŸ¥ãŒå±Šã„ãŸéš›ã€å¯¾å¿œã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã›ãš404ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã€‚Stripeã¯ç¹°ã‚Šè¿”ã—ãƒªãƒˆãƒ©ã‚¤ã‚’è¡Œã„ã€æœ€çµ‚çš„ã«ã‚¢ãƒ©ãƒ¼ãƒˆãŒç™ºç”Ÿã™ã‚‹
2. **èª¤é€€ä¼šã®ä¸å¯é€†æ€§**: æ“ä½œãƒŸã‚¹ã§é€€ä¼šã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿å¾©æ—§æ‰‹æ®µãŒä¸€åˆ‡ãªã„
3. **ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆ**: ç‰©ç†å‰Šé™¤ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§Stripe APIå‘¼ã³å‡ºã—ãŒå¤±æ•—ã—ãŸå ´åˆã€ã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æ¶ˆãˆãŸãŒStripeèª²é‡‘ã¯ç¶™ç¶šã™ã‚‹ã€ã¨ã„ã†è‡´å‘½çš„ãªä¸æ•´åˆãŒç™ºç”Ÿã—ã†ã‚‹

### ç›®çš„

- **ç›®çš„1**: Stripe Webhookã®å®‰å…¨ãªç€åœ°å…ˆã‚’å†¬çœ æœŸé–“ä¸­ã«ç¢ºä¿ã—ã€æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼ã‚’æ ¹çµ¶ã™ã‚‹
- **ç›®çš„2**: èª¤é€€ä¼šãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã™ã‚‹30æ—¥é–“ã®å¾©æ—§çŒ¶äºˆã‚’æä¾›ã™ã‚‹
- **ç›®çš„3**: DB Uniqueåˆ¶ç´„ã‚’æ´»ç”¨ã—ãŸæœ€å°ã‚³ãƒ¼ãƒ‰ã§ã®å†ç™»éŒ²é˜²æ­¢ã‚’å®Ÿç¾ã™ã‚‹
- **ç›®çš„4**: ç‰©ç†å‰Šé™¤ã®è‡ªå‹•åŒ–ã«ã‚ˆã‚Šã€å€‹äººæƒ…å ±ã®ç¢ºå®ŸãªæŠ¹æ¶ˆã‚’ä¿è¨¼ã™ã‚‹

## 4. å¤‰æ›´ã®å¦¥å½“æ€§ (Pros / Cons)

Pros (åˆ©ç‚¹):

- **Stripeé€£æºã®å …ç‰¢æ€§**: å†¬çœ ä¸­ã«Webhookã®ç€åœ°å…ˆãŒç¶­æŒã•ã‚Œã‚‹ãŸã‚ã€æŒ‰åˆ†æ±ºæ¸ˆã‚„é…å»¶é€šçŸ¥ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
- **æœ€å°ã®å®Ÿè£…ã‚³ã‚¹ãƒˆ**: DB Uniqueåˆ¶ç´„ã‚’æ´»ç”¨ã—ã€å†ç™»éŒ²é˜²æ­¢ã«è¿½åŠ ã‚³ãƒ¼ãƒ‰ãŒä¸è¦ã€‚`deleted_at` ã‚«ãƒ©ãƒ 1ã¤ã®è¿½åŠ ã§è«–ç†å‰Šé™¤ã‚’å®Ÿç¾
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¿è­·**: èª¤é€€ä¼šã®å¾©æ—§å¯èƒ½æ€§ã‚’30æ—¥é–“ç¶­æŒï¼ˆå°†æ¥ã®å¾©æ—§UIè¿½åŠ ã‚‚å®¹æ˜“ï¼‰
- **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·**: 30æ—¥å¾Œã«ç‰©ç†å‰Šé™¤ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€GDPRç­‰ã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤è¦ä»¶ã«ã‚‚å¯¾å¿œå¯èƒ½
- **ã¹ãç­‰ãªWebhookå‡¦ç†**: ç‰©ç†å‰Šé™¤å¾Œã®é…å»¶Webhookã«å¯¾ã—ã¦ã‚‚200ã‚’è¿”ã™ã€Œæ¯ã‚ŒãŸè¨­è¨ˆã€

Cons (æ‡¸å¿µç‚¹):

- **ãƒãƒƒãƒå‡¦ç†ã®æ–°è¦è¿½åŠ **: Cloudflare Workers Cron Triggerã¾ãŸã¯ Scheduled Workerã®å°å…¥ãŒå¿…è¦ã€‚æ—¢å­˜ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«æ–°ã—ã„ãƒ¬ã‚¤ãƒ¤ãƒ¼ãŒè¿½åŠ ã•ã‚Œã‚‹
- **ãƒ­ã‚°ã‚¤ãƒ³ãƒ»ç™»éŒ²ãƒ•ãƒ­ãƒ¼ã¸ã®å½±éŸ¿**: è«–ç†å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ãŒèªè¨¼ãƒ»ç™»éŒ²ãƒ­ã‚¸ãƒƒã‚¯ã«æ³¢åŠã™ã‚‹
- **ãƒ†ã‚¹ãƒˆç¯„å›²ã®æ‹¡å¤§**: E2Eãƒ†ã‚¹ãƒˆã«ãƒãƒƒãƒå‡¦ç†ã®ãƒ†ã‚¹ãƒˆãŒè¿½åŠ ã•ã‚Œã‚‹ï¼ˆãŸã ã—Cronã¯çµ±åˆãƒ†ã‚¹ãƒˆã§æ¤œè¨¼å¯èƒ½ï¼‰
- **å³æ™‚å‰Šé™¤ã®æœŸå¾…ã¨ã®ã‚®ãƒ£ãƒƒãƒ—**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã€Œ30æ—¥å¾Œã«å®Œå…¨å‰Šé™¤ã•ã‚Œã‚‹ã€ã“ã¨ã‚’é©åˆ‡ã«èª¬æ˜ã™ã‚‹UIå¤‰æ›´ãŒå¿…è¦

**ç·åˆè©•ä¾¡**:

Consã¯ã„ãšã‚Œã‚‚ç®¡ç†å¯èƒ½ãªç¯„å›²ã§ã‚ã‚Šã€ç‰¹ã«Stripeé€£æºã®å …ç‰¢æ€§ã¨ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã®æ ¹çµ¶ã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã®ä¿¡é ¼æ€§ã«ç›´çµã™ã‚‹é‡å¤§ãªæ”¹å–„ã§ã™ã€‚GUIDING_PRINCIPLES.mdã§å®šç¾©ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æˆ¦ç•¥ï¼ˆD1 + KVã®ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ï¼‰ã¨ã‚‚æ•´åˆã—ã€Cloudflare Workers Cron Triggerã¨ã„ã†æ—¢å­˜ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ å†…ã®æ©Ÿèƒ½ã§å®Ÿç¾å¯èƒ½ãªãŸã‚ã€**å¦¥å½“æ€§ã¯éå¸¸ã«é«˜ã„**ã¨åˆ¤æ–­ã—ã¾ã™ã€‚

## 5 è¨­è¨ˆãƒ•ãƒ­ãƒ¼

### ğŸ—¾GUIDING_PRINCIPLES.md

**å¤‰æ›´ã‚ã‚Š** â€” 2ç®‡æ‰€

1. **ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 2.1ã€Œé€€ä¼šãƒ•ãƒ­ãƒ¼ã€ã®æ›´æ–°**ï¼ˆL74-77ä»˜è¿‘ï¼‰

   ç¾åœ¨ã®è¨˜è¼‰:

   ```text
   é€€ä¼šãƒ•ãƒ­ãƒ¼:
   1. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤è¦æ±‚ â†’ D1ã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèªãƒ»å‰Šé™¤ â†’ D1ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ (CASCADE)
   2. KVã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ â†’ Cookieã‚¯ãƒªã‚¢
   ```

   ä¿®æ­£å¾Œ:

   ```text
   é€€ä¼šãƒ•ãƒ­ãƒ¼ï¼ˆ3ãƒ•ã‚§ãƒ¼ã‚ºåˆ¶ï¼‰:
   1. é€€ä¼šå®Ÿè¡Œ: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤è¦æ±‚ â†’ D1ã§ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèª â†’ Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åœæ­¢ï¼ˆCustomerä¿æŒï¼‰â†’ D1ã§users.deleted_atã«ç¾åœ¨æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆè«–ç†å‰Šé™¤ï¼‰â†’ KVã‹ã‚‰å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ â†’ Cookieã‚¯ãƒªã‚¢
   2. å†¬çœ ï¼ˆ1ã€œ30æ—¥é–“ï¼‰: ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦ã€åŒä¸€ãƒ¡ãƒ¼ãƒ«å†ç™»éŒ²ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆUniqueåˆ¶ç´„ï¼‰ã€Stripe Webhookå—ä¿¡ç¶™ç¶š
   3. ç‰©ç†æŠ¹æ¶ˆï¼ˆ31æ—¥ç›®ã€œï¼‰: Scheduled WorkerãŒdeleted_at < 30æ—¥å‰ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç‰©ç†DELETE â†’ Stripe Customerå‰Šé™¤
   ```

2. **ã‚»ã‚¯ã‚·ãƒ§ãƒ³ 4ã€Œãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã€é …ç›®6ã®æ›´æ–°**ï¼ˆL192ä»˜è¿‘ï¼‰

   ç¾åœ¨ã®è¨˜è¼‰:

   ```text
   6. **é€€ä¼šå‡¦ç†**: Route â†’ data-ioï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèªï¼‰â†’ data-ioï¼ˆStripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å³æ™‚è§£ç´„ï¼‰â†’ data-ioï¼ˆD1: subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ï¼‰â†’ data-ioï¼ˆD1: usersãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ï¼‰â†’ libï¼ˆå…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´æ£„ï¼‰â†’ /loginã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   ```

   ä¿®æ­£å¾Œ:

   ```text
   6. **é€€ä¼šå‡¦ç†ï¼ˆè«–ç†å‰Šé™¤ï¼‰**: Route â†’ data-ioï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ç¢ºèªï¼‰â†’ data-ioï¼ˆStripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åœæ­¢ã€Customerä¿æŒï¼‰â†’ data-ioï¼ˆD1: users.deleted_atã«ç¾åœ¨æ™‚åˆ»ã‚’è¨˜éŒ²ï¼‰â†’ libï¼ˆå…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´æ£„ï¼‰â†’ /loginã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
   7. **ç‰©ç†æŠ¹æ¶ˆï¼ˆãƒãƒƒãƒï¼‰**: Scheduled Worker â†’ data-ioï¼ˆdeleted_at < 30æ—¥å‰ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—ï¼‰â†’ data-ioï¼ˆStripe Customerå‰Šé™¤ï¼‰â†’ data-ioï¼ˆD1: subscriptionsç‰©ç†DELETEï¼‰â†’ data-ioï¼ˆD1: usersç‰©ç†DELETEï¼‰â†’ ãƒ­ã‚°å‡ºåŠ›
   ```

---

### ğŸ“šï¸func-spec.md

**å¤‰æ›´ã‚ã‚Š** â€” profileã‚»ã‚¯ã‚·ãƒ§ãƒ³ + ä»–ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®æ³¢åŠ

#### profile ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³4ï¼‰ã®å…¨é¢æ”¹è¨‚

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**ã‚’ä»¥ä¸‹ã«å·®ã—æ›¿ãˆ:

1. å‰Šé™¤ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
2. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ã®ç¢ºèªï¼ˆD1: subscriptionsãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
3. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³æœŸé–“ä¸­ã®å ´åˆã€å¼·åŠ›ãªè­¦å‘Šã‚’è¡¨ç¤ºï¼ˆæ—¢å­˜ã¨åŒã˜ï¼‰
4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
5. ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åœæ­¢ï¼ˆ`cancel_at_period_end = true` ã¾ãŸã¯å³æ™‚åœæ­¢ã€‚**Customer ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯å‰Šé™¤ã—ãªã„**ï¼‰
6. `users` ãƒ†ãƒ¼ãƒ–ãƒ«ã® `deleted_at` ã«ç¾åœ¨æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆ**ç‰©ç†å‰Šé™¤ã—ãªã„**ï¼‰
7. ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆWorkers KVï¼‰
8. `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ + ã€Œé€€ä¼šæ‰‹ç¶šãã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚30æ—¥å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã®æ›´æ–°**:

- ~~å‰Šé™¤ã¯å–ã‚Šæ¶ˆã—ä¸å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤º~~ â†’ ã€Œ30æ—¥é–“ã®å†¬çœ æœŸé–“å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨å‰Šé™¤ã•ã‚Œã‚‹ã€ã“ã¨ã‚’æ˜ç¤º
- è«–ç†å‰Šé™¤å¾Œã¯å…¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´æ£„ã€ãƒ­ã‚°ã‚¤ãƒ³æ‹’å¦

#### æ–°è¦æ©Ÿèƒ½: ç‰©ç†æŠ¹æ¶ˆãƒãƒƒãƒå‡¦ç†

- Cloudflare Workers Scheduled Handlerï¼ˆCron Triggerï¼‰ã¨ã—ã¦å®Ÿè£…
- å®Ÿè¡Œé–“éš”: 1æ—¥1å›ï¼ˆæ·±å¤œå¸¯æ¨å¥¨ï¼‰
- å‡¦ç†å†…å®¹:
  1. `SELECT * FROM users WHERE deleted_at < datetime('now', '-30 days')` ã§ãƒ¬ã‚³ãƒ¼ãƒ‰å–å¾—
  2. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦ Stripe Customer å‰Šé™¤ï¼ˆ`stripe.customers.del(stripe_customer_id)`ï¼‰
  3. D1: `DELETE FROM subscriptions WHERE user_id = ?`
  4. D1: `DELETE FROM users WHERE id = ?`
  5. å®Ÿè¡Œçµæœã‚’ãƒ­ã‚°å‡ºåŠ›ï¼ˆæˆåŠŸä»¶æ•°ã€å¤±æ•—ä»¶æ•°ï¼‰
  6. å¤±æ•—æ™‚ã¯ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå°†æ¥çš„ã«ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ç­‰ï¼‰

#### æ–°è¦æ©Ÿèƒ½: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå¾©æ—§ï¼ˆå†¬çœ ä¸­ã®ã¿ï¼‰

å†¬çœ ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã‚’è©¦ã¿ãŸéš›ã«ã€ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¾©æ—§ã§ãã‚‹ã€Œå„ªã—ã„é˜²è¡›ã€å°ç·šã€‚

- **ãƒˆãƒªã‚¬ãƒ¼**: ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã§ãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã€è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `deleted_at` ãŒéNULL
- **UI**: ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ä¸Šã«å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯é€€ä¼šæ‰‹ç¶šãä¸­ã§ã™ã€‚å¾©æ—§ã—ã¾ã™ã‹ï¼Ÿã€+ ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å¾©æ—§ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
- **å¾©æ—§å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
  1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«æ—¢ã«å…¥åŠ›æ¸ˆã¿ï¼‰
  2. `restoreUser.server`ï¼ˆ`UPDATE users SET deleted_at = NULL WHERE id = ?`ï¼‰
  3. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ â†’ `/account` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- **Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³**: è‡ªå‹•å†é–‹ã¯ã—ãªã„ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¿…è¦ã§ã‚ã‚Œã° `/account/subscription` ã‹ã‚‰å†å¥‘ç´„

#### authentication ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®æ³¢åŠï¼ˆ2ç®‡æ‰€ï¼‰

1. **ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†** â€” `findUserByEmail` ã§å–å¾—ã—ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `deleted_at` ãŒéNULLã®å ´åˆã€é€šå¸¸ã®ãƒ­ã‚°ã‚¤ãƒ³ã‚’æ‹’å¦ã€‚å°‚ç”¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯é€€ä¼šæ‰‹ç¶šãä¸­ã§ã™ã€‚å¾©æ—§ã—ã¾ã™ã‹ï¼Ÿã€ã‚’è¡¨ç¤ºã—ã€å¾©æ—§ãƒœã‚¿ãƒ³ï¼ˆintent=`restore-account`ï¼‰ã‚’æä¾›

2. **ä¼šå“¡ç™»éŒ²å‡¦ç†** â€” `checkEmailExists` ã§å–å¾—ã—ãŸãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã® `deleted_at` ãŒéNULLã®å ´åˆã€ã€Œé€€ä¼šæ‰‹ç¶šãä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã¸ã®å°ç·šã‚’æä¾›ï¼ˆå¾©æ—§ã¯ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‹ã‚‰è¡Œã†ï¼‰

#### subscription ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®æ³¢åŠï¼ˆ1ç®‡æ‰€ï¼‰

- **Webhookå‡¦ç†** â€” `user_id` ã§æ¤œç´¢ã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç‰©ç†å‰Šé™¤æ¸ˆã¿ï¼ˆãƒ¬ã‚³ãƒ¼ãƒ‰ä¸åœ¨ï¼‰ã®å ´åˆã€404ã§ã¯ãªã200ã‚’è¿”ã—ã€Œå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸åœ¨ã€ã‚’ãƒ­ã‚°ã«è¨˜éŒ²ã™ã‚‹ï¼ˆã¹ãç­‰æ€§ã®ç¢ºä¿ï¼‰

---

### ğŸ–¼ï¸uiux-spec.md

**å¤‰æ›´ã‚ã‚Š** â€” ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤UIã®çŠ¶æ…‹é·ç§»ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ›´æ–°

1. **è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å¤‰æ›´**

   - ç¾åœ¨: ã€Œã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã—ã§ãã¾ã›ã‚“ã€‚ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã€
   - ä¿®æ­£: ã€Œé€€ä¼šã™ã‚‹ã¨å³åº§ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚30æ—¥å¾Œã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã€

2. **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤UIã®çŠ¶æ…‹é·ç§»**

   `Success` çŠ¶æ…‹ã®å‹•ä½œã‚’å¤‰æ›´:
   - ç¾åœ¨: `/login` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆå³æ™‚å‰Šé™¤å®Œäº†ï¼‰
   - ä¿®æ­£: `/login` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ + ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œé€€ä¼šæ‰‹ç¶šãã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚30æ—¥å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã€

3. **ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆï¼ˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒ•ãƒ­ãƒ¼ï¼‰ã®ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³æ›´æ–°**

   ```text
   Server->>Server: users.deleted_atã«ç¾åœ¨æ™‚åˆ»ã‚’è¨˜éŒ²ï¼ˆè«–ç†å‰Šé™¤ï¼‰
   ```

   ã«å·®ã—æ›¿ãˆï¼ˆã€Œãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ã€ã‚’å‰Šé™¤ï¼‰

---

### ğŸ“‹ï¸spec.yaml

**å¤‰æ›´ã‚ã‚Š** â€” ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ»è¨­å®šå€¤ã®è¿½åŠ ãƒ»æ›´æ–°

1. **`forms.delete_account.warning_message` ã®æ›´æ–°**

   ```yaml
   warning_message: "é€€ä¼šã™ã‚‹ã¨å³åº§ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ããªããªã‚Šã¾ã™ã€‚30æ—¥å¾Œã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚"
   ```

2. **`success_messages.delete_account` ã®æ›´æ–°**

   ```yaml
   delete_account:
     completed: "é€€ä¼šæ‰‹ç¶šãã‚’å—ã‘ä»˜ã‘ã¾ã—ãŸã€‚30æ—¥å¾Œã«ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚"
   ```

3. **`security.delete_account` ã®æ›´æ–°**

   ```yaml
   delete_account:
     delete_all_sessions: true
     soft_delete: true          # è¿½åŠ : è«–ç†å‰Šé™¤ãƒ•ãƒ©ã‚°
     hibernation_days: 30       # è¿½åŠ : å†¬çœ æœŸé–“ï¼ˆæ—¥æ•°ï¼‰
     redirect_after_delete: "/login"
   ```

4. **å†¬çœ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¿½åŠ **

   ```yaml
   error_messages:
     # æ—¢å­˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
     hibernation:
       login_blocked: "ã“ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯é€€ä¼šæ‰‹ç¶šãä¸­ã§ã™"
       registration_blocked: "é€€ä¼šæ‰‹ç¶šãä¸­ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã™"
   ```

---

### ğŸ—‚ï¸file_list.md

**å¤‰æ›´ã‚ã‚Š** â€” ãƒ•ã‚¡ã‚¤ãƒ«ã®å·®ã—æ›¿ãˆãƒ»æ–°è¦è¿½åŠ 

1. **data-ioå±¤ã®å¤‰æ›´**

   | å¤‰æ›´ç¨®åˆ¥ | ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ‘ã‚¹ | å‚™è€ƒ |
   | :--- | :--- | :--- | :--- |
   | **åç§°å¤‰æ›´** | ~~deleteUser.server.ts~~ â†’ `softDeleteUser.server.ts` | `app/data-io/account/profile/softDeleteUser.server.ts` | `UPDATE users SET deleted_at = NOW()` ã«å¤‰æ›´ |
   | **åç§°å¤‰æ›´** | ~~deleteUser.server.test.ts~~ â†’ `softDeleteUser.server.test.ts` | `app/data-io/account/profile/softDeleteUser.server.test.ts` | ãƒ†ã‚¹ãƒˆå†…å®¹ã‚‚è«–ç†å‰Šé™¤ã«å¤‰æ›´ |
   | **æ–°è¦** | `purgeExpiredUsers.server.ts` | `app/data-io/account/profile/purgeExpiredUsers.server.ts` | å†¬çœ æœŸé–“è¶…éãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰©ç†å‰Šé™¤ + Stripe Customerå‰Šé™¤ |
   | **æ–°è¦** | `purgeExpiredUsers.server.test.ts` | `app/data-io/account/profile/purgeExpiredUsers.server.test.ts` | ãƒãƒƒãƒå‡¦ç†ã®ãƒ†ã‚¹ãƒˆ |

2. **Scheduled Workerï¼ˆæ–°è¦ã‚«ãƒ†ã‚´ãƒªï¼‰**

   | å¤‰æ›´ç¨®åˆ¥ | ãƒ•ã‚¡ã‚¤ãƒ« | ãƒ‘ã‚¹ | å‚™è€ƒ |
   | :--- | :--- | :--- | :--- |
   | **æ–°è¦** | `scheduled.ts` | `app/scheduled.ts`ï¼ˆã¾ãŸã¯ `workers/scheduled.ts`ï¼‰ | Cloudflare Workers Cron Trigger ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã€‚`purgeExpiredUsers.server` ã‚’å‘¼ã³å‡ºã™ |

3. **libå±¤ã®å¤‰æ›´**

   å¤‰æ›´ãªã—ï¼ˆ`validateAccountDeletion.ts` ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ã¯ä¸å¤‰ã€‚ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´ã¯ spec.yaml å´ã§å¸åï¼‰

4. **ä¾å­˜é–¢ä¿‚ã‚µãƒãƒªãƒ¼ã®æ›´æ–°**

   Subscription ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ä¾å­˜ã‚’ä»¥ä¸‹ã«ä¿®æ­£:
   - `getSubscriptionByUserId.server.ts`: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å–å¾—ï¼ˆå¤‰æ›´ãªã—ï¼‰
   - `cancelStripeSubscription.server.ts`: Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åœæ­¢ï¼ˆ**Customerä¿æŒ**ã«å¤‰æ›´ï¼‰
   - ~~`deleteSubscription.server.ts`~~: **é€€ä¼šå®Ÿè¡Œæ™‚ã«ã¯å‘¼ã³å‡ºã•ãªã„**ï¼ˆç‰©ç†æŠ¹æ¶ˆãƒãƒƒãƒã§å‡¦ç†ï¼‰

---

### ğŸ§¬data-flow-diagram.md

**å¤‰æ›´ã‚ã‚Š** â€” ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒ•ãƒ­ãƒ¼ã®å…¨é¢å·®ã—æ›¿ãˆ + ãƒãƒƒãƒå‡¦ç†ãƒ•ãƒ­ãƒ¼è¿½åŠ 

1. **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒ•ãƒ­ãƒ¼ï¼ˆè«–ç†å‰Šé™¤ç‰ˆï¼‰**

   ```mermaid
   graph TD
       User((ãƒ¦ãƒ¼ã‚¶ãƒ¼)) --> ProfileDisplay["ProfileDisplay"]
       ProfileDisplay -- "å‰Šé™¤ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯" --> DeleteModal["Modal (common)"]
       DeleteModal -- "ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º" --> CheckSub["ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª"]

       CheckSub -- "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚ã‚Š" --> ShowWarning["å¼·åŠ›ãªè­¦å‘Šè¡¨ç¤º"]
       CheckSub -- "ãªã—" --> DeleteModal
       ShowWarning -- "æœŸé–“æ”¾æ£„ã‚’ç¢ºèª" --> DeleteModal

       DeleteModal -- "å‰Šé™¤ç¢ºèª" --> Action["account.settings action"]

       Action --> Validate["validateAccountDeletion (lib)"]
       Validate --> FindUser["findUserByEmail.server"]
       FindUser --> VerifyPwd["verifyPassword (lib/auth)"]
       VerifyPwd --> CheckSubAgain["ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å­˜åœ¨ç¢ºèª"]
       CheckSubAgain -- "ã‚ã‚Š" --> StopStripe["Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åœæ­¢<br/>(Customerä¿æŒ)"]
       CheckSubAgain -- "ãªã—" --> SoftDelete
       StopStripe --> SoftDelete["softDeleteUser.server<br/>(deleted_atã«ç¾åœ¨æ™‚åˆ»ã‚’è¨˜éŒ²)"]
       SoftDelete --> DeleteSessions["deleteAllUserSessions.server"]
       DeleteSessions --> Redirect["/login ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ<br/>+ å†¬çœ é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸"]

       style DeleteModal fill:#ffcccc
       style SoftDelete fill:#fff4e1
       style Redirect fill:#ffcccc
   ```

2. **ç‰©ç†æŠ¹æ¶ˆãƒãƒƒãƒãƒ•ãƒ­ãƒ¼ï¼ˆæ–°è¦è¿½åŠ ï¼‰**

   ```mermaid
   graph TD
       Cron["Scheduled Worker<br/>(Cron Trigger: 1æ—¥1å›)"] --> Query["D1: deleted_at < 30æ—¥å‰<br/>ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—"]
       Query --> Loop["å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾ã—ã¦"]
       Loop --> StripeDelete["Stripe Customerå‰Šé™¤"]
       StripeDelete --> SubDelete["D1: subscriptions DELETE"]
       SubDelete --> UserDelete["D1: users ç‰©ç†DELETE"]
       UserDelete --> Log["å®Ÿè¡Œãƒ­ã‚°å‡ºåŠ›"]

       StripeDelete -- "å¤±æ•—" --> ErrorLog["ã‚¨ãƒ©ãƒ¼ãƒ­ã‚° + ã‚¢ãƒ©ãƒ¼ãƒˆ<br/>(ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤ã¯ã‚¹ã‚­ãƒƒãƒ—)"]

       style Cron fill:#e8f5e9
       style ErrorLog fill:#ff6666
   ```

3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒ­ãƒ¼ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ™‚ã®å‡¦ç†ã€ã®æ›´æ–°**

   ç¾åœ¨ã®ã€Œå³æ™‚å‰Šé™¤ã€ãƒ•ãƒ­ãƒ¼ã‚’ä»¥ä¸‹ã«å·®ã—æ›¿ãˆ:

   ```text
   ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€€ä¼šç¢ºèª â†’ Stripeã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³åœæ­¢(Customerä¿æŒ) â†’ softDeleteUser(è«–ç†å‰Šé™¤) â†’ deleteAllUserSessions â†’ /login + å†¬çœ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
   ```

4. **ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè²¬å‹™ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°**

   `account.settings.tsx` ã®è²¬å‹™ã«ã€Œè«–ç†å‰Šé™¤ï¼ˆsoftDeleteUserå‘¼ã³å‡ºã—ï¼‰ã€ã‚’æ˜è¨˜

## 6 TDD_WORK_FLOW.md ç°¡æ˜“ç‰ˆ

### ğŸ‘ï¸e2e-screen-test

å¤‰æ›´ãªã—

### ğŸ‘ï¸e2e-section-test

`tests/e2e/account/profile.spec.ts` â€” ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã‚·ãƒŠãƒªã‚ªã‚’è«–ç†å‰Šé™¤ç‰ˆã«æ”¹è¨‚ã€‚å¾©æ—§ã‚·ãƒŠãƒªã‚ªã‚’è¿½åŠ 

- æ—¢å­˜: ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ã®æˆåŠŸã‚·ãƒŠãƒªã‚ªã€â†’ è«–ç†å‰Šé™¤å¾Œ `/login` ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ + å†¬çœ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã«å¤‰æ›´
- **æ–°è¦**: å†¬çœ ä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ â†’ å¾©æ—§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º â†’ å¾©æ—§ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ â†’ `/account` ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- **æ–°è¦**: å†¬çœ ä¸­ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã®æ–°è¦ç™»éŒ² â†’ ãƒ–ãƒ­ãƒƒã‚¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

### ğŸ¨CSSå®Ÿè£… (layer2.css, layer3.ts, layer4.ts)

å¤‰æ›´ãªã—ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ–‡è¨€å¤‰æ›´ã®ã¿ã§æ§‹é€ çš„å¤‰æ›´ãªã—ï¼‰

### ğŸª¨route

`app/routes/account.settings.tsx` â€” action ã® `delete-account` intent ã‚’æ”¹è¨‚

- `deleteUser.server` â†’ `softDeleteUser.server` ã«å‘¼ã³å‡ºã—å…ˆå¤‰æ›´
- `deleteSubscription.server` ã®å‘¼ã³å‡ºã—ã‚’å‰Šé™¤ï¼ˆãƒãƒƒãƒå‡¦ç†ã«ç§»è¡Œï¼‰

`app/routes/login.tsx` â€” **æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´è¿½åŠ **

- action ã« `restore-account` intent ã‚’è¿½åŠ ï¼ˆ`restoreUser.server` å‘¼ã³å‡ºã—ï¼‰
- `deleted_at` éNULLãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å°‚ç”¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆ`{ hibernating: true }` ã‚’è¿”å´ï¼‰

### ğŸš§components.test

`app/components/account/profile/ProfileDisplay.test.tsx` â€” å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¤‰æ›´ãƒ†ã‚¹ãƒˆ

### ğŸª¨components

`app/components/account/profile/ProfileDisplay.tsx` â€” å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ spec.yaml ã‹ã‚‰å–å¾—ã™ã‚‹å€¤ã«å¤‰æ›´ï¼ˆæ§‹é€ å¤‰æ›´ãªã—ï¼‰

### ğŸš§logic.test

`app/lib/account/profile/validateAccountDeletion.test.ts` â€” å¤‰æ›´ãªã—ï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ã¯ä¸å¤‰ï¼‰

### ğŸª¨logic

`app/lib/account/profile/validateAccountDeletion.ts` â€” å¤‰æ›´ãªã—

### ğŸš§data-io.test

- `app/data-io/account/profile/softDeleteUser.server.test.ts` â€” **æ–°è¦**ï¼ˆ`deleteUser.server.test.ts` ã‹ã‚‰ãƒªãƒãƒ¼ãƒ ï¼‰ã€‚`UPDATE users SET deleted_at` ã®æ¤œè¨¼
- `app/data-io/account/profile/restoreUser.server.test.ts` â€” **æ–°è¦**ã€‚`UPDATE users SET deleted_at = NULL` ã®æ¤œè¨¼
- `app/data-io/account/profile/purgeExpiredUsers.server.test.ts` â€” **æ–°è¦**ã€‚30æ—¥è¶…éãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰©ç†å‰Šé™¤ + Stripe Customer å‰Šé™¤ã®æ¤œè¨¼

### ğŸª¨data-io

- `app/data-io/account/profile/softDeleteUser.server.ts` â€” **æ–°è¦**ï¼ˆ`deleteUser.server.ts` ã‹ã‚‰ãƒªãƒãƒ¼ãƒ ï¼‰ã€‚`UPDATE users SET deleted_at = datetime('now') WHERE id = ?`
- `app/data-io/account/profile/restoreUser.server.ts` â€” **æ–°è¦**ã€‚`UPDATE users SET deleted_at = NULL WHERE id = ?`
- `app/data-io/account/profile/purgeExpiredUsers.server.ts` â€” **æ–°è¦**ã€‚å†¬çœ æœŸé–“è¶…éãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰©ç†å‰Šé™¤ + Stripe Customer å‰Šé™¤

### ãã®ä»–

- `app/scheduled.ts` â€” **æ–°è¦**ã€‚Cloudflare Workers Cron Trigger ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆã€‚`purgeExpiredUsers.server` ã‚’å‘¼ã³å‡ºã™
- `wrangler.toml` â€” `[triggers]` ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã« `crons = ["0 3 * * *"]`ï¼ˆæ¯æ—¥UTC 3:00ï¼‰ã‚’è¿½åŠ 
