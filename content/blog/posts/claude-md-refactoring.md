---
slug: "claude-md-refactoring"
title: "CLAUDE.md最適化：公式ベストプラクティスでコンテキスト負荷を削減"
description: "CLAUDE.mdが毎回の会話で不要な情報をロードし、コンテキストを圧迫していた問題を、Anthropic公式ベストプラクティスに準拠した構成への全面リファクタリングで解決。スラッシュコマンド化と{section}-spec.yaml形式への統一により、Claude Codeとの協調開発効率を最大化。"
author: "ClaudeMix Team"
publishedAt: "2025-12-22"
category: "Claude Best Practices"
tags: ["Projects", "Prompts", "architecture"]
---

## はじめに

### Claude Code Projectsでこんなことありませんか？

Claude Code Projectsを使い始め、`CLAUDE.md`でプロジェクトの文脈を共有しようとしました。
しかし、公式ドキュメントには「何を書くべきか」の具体的な指針が少なく、手探りで独自形式のCLAUDE.mdを作成しました。
動作はするものの、「本当に効率的な構成なのか」「毎回の会話で必要な情報だけがロードされているのか」という不安が残りました。

### この記事をお勧めしない人

- CLAUDE.mdを使っていない、または使う予定がない人
- コンテキストウィンドウの使用量を全く気にしない人
- Anthropic公式の推奨に従う必要がないと考える人

もし一つでも当てはまらないなら、読み進める価値があるかもしれません。

### 最適化されていないCLAUDE.mdは危険です

☠ 毎回の会話で「フロー実行時のみ必要な指示」までロードされ、本来必要な「プロジェクト固有の常識」を圧迫する土壌ができあがります。

☠ やがて、複雑なリファクタリングや新機能実装のタスクで、コンテキストウィンドウの上限に近づき、重要な設計思想やアーキテクチャルールが削られるきっかけが発生します。

☠ ついに、AIが「アーキテクチャルール」や「設定管理の原則」といった重要なプロジェクト規範を見落とし、品質低下や手戻りが発生します。

### Anthropic公式準拠という明るい未来

✅ この記事を読めば、Claude Codeとの協調開発効率を最大化し、コンテキストを「毎回参照すべき情報」に集中できる明るい未来があります。

✅ 具体的には、Anthropic公式が推奨する5項目（共通コマンド、コアファイル、テスト指示、開発環境セットアップ、プロジェクト固有の警告）でCLAUDE.mdを最適化し、フロー特化の指示をスラッシュコマンドに分離する**設計図**を手に入れられます。

✅ この方法は、ClaudeMixプロジェクトで実証済みで、約1,600トークンのコンテキスト削減を実現し、AIがプロジェクト固有の常識により集中できるようになりました。

✅ この情報は、公式ベストプラクティスを実プロジェクトに適用した**実践知**であり、巷の情報では決して得られない具体的な改善プロセスです。

### このブログも同じでした

ClaudeMixプロジェクトも、「何を書くべきか」の基準がなく、独自形式のCLAUDE.mdで開発を進めていました。

この記事では、Anthropic公式ベストプラクティスへの全面移行プロセスと、具体的な改善効果（コンテキスト削減、検索性向上、責務の明確化）を持ち帰れるように書きました。

深掘りしたい方は、実際のコミット履歴と、変更前後のCLAUDE.mdの比較を確認できます。

## 開発の進捗

- **Before**: 独自形式のCLAUDE.mdで、フロー実行指示とプロジェクト固有の常識が混在していた状態
- **Current**: Anthropic公式ベストプラクティスに準拠したCLAUDE.mdに全面リファクタリング完了
- **Next**: 記事作成と、他のプロジェクトへの適用可能性の検証

## 具体的なタスク

### Before: 問題の発見

CLAUDE.mdを読み直したところ、「毎回の回答時に参照されるべき内容ではないもの」が大量に含まれていることに気づきました。
具体的には、特定の開発フロー実行時のみ必要な詳細な指示が、毎回の会話でロードされていました。
また、Anthropic公式が推奨する「共通bashコマンド」「開発環境セットアップ詳細」といった実践的な項目が欠けていました。

### Current: 全面リファクタリング

公式ベストプラクティス記事（`content/blog/posts/projects-guide.md`で要約済み）を参照し、以下の変更を実施しました：

1. **フロー関連指示のスラッシュコマンド化**: セクション1と2を`.claude/commands/tdd-flow.md`に移行
2. **公式推奨5項目の実装**: 共通コマンド、コアファイル構造、テスト指示、セットアップ詳細、プロジェクト固有の警告を追加
3. **設定ファイルの古い記述を修正**: 放置されていた命名規則の不統一を解消

### Next: 効果測定と展開

今後は、この最適化によるコンテキスト削減効果をモニタリングし、他のセクション（認証、決済など）にも適用していく予定です。

## 課題と解決策

### 工夫したこと

#### 1. 公式推奨の「具体性」を徹底

Anthropic公式が推奨するCLAUDE.mdは、「共通bashコマンドとその目的」のような実践的な項目を含んでいます。
単に「npm run dev」と書くのではなく、以下のように**目的と備考を明記**しました：

```markdown
| コマンド | 目的 | 備考 |
|:---|:---|:---|
| `npm run dev:wrangler` | 開発サーバー起動 | Wranglerでランタイム制約を反映した開発環境を起動（必須） |
| `npm test` | ユニットテスト実行 | Vitestを使用（E2Eはオペレーターが実行） |
```

この形式により、Claudeが「なぜこのコマンドを使うべきか」を理解し、自律的に正しい選択ができるようになりました。

#### 2. スラッシュコマンドへの分離基準を明確化

「毎回参照されるべき内容か？」という基準で、以下のように分類しました：

- **CLAUDE.mdに残す**: プロジェクト固有の「常識」（アーキテクチャルール、設定管理の原則、スタイル規則など）
- **スラッシュコマンドに移行**: 特定のフロー実行時のみ必要な指示（ステップ指定、進捗ファイル更新など）

この分離により、コンテキストの「信号対雑音比」が大幅に向上しました。

### ぶつかった壁

#### 1. 公式推奨との「言葉の温度差」

公式ドキュメントは「共通bashコマンドを含めよ」と推奨していますが、ClaudeMixでは「`npm run dev`は禁止、`npm run dev:wrangler`が必須」という独自ルールがありました。
この「プロジェクト固有の制約」を、どう公式推奨の形式に落とし込むかに悩みました。

#### 2. 「フロー関連指示」の切り分け

セクション1の「自律性の原則」には、「サブエージェント利用、ファイル生成、リント実行を自律的に判断」という記述があり、これは「一般的な指針」か「フロー特化の指示」かの判断が難しかったです。

最終的には、ステップ指定や進捗ファイル更新といった具体的なフロー固有の指示と一緒に記述されていたため、すべてスラッシュコマンドに移行しました。

### 解決方法

#### 1. 「備考」欄でプロジェクト固有の制約を明示

公式推奨の表形式を採用しつつ、「備考」欄にClaudeMix固有のルール（「ランタイム制約の確認を必須」「E2Eはオペレーターが実行」）を記載することで、公式形式とプロジェクト制約の両立を実現しました。

#### 2. 「フロー骨格」への参照があるかで判断

セクション1には「開発フローは`docs/boilerplate_architecture/開発フロー簡略図.md`で定義」という記述があり、これが「フロー実行時のみ必要」であることの明確な証拠となりました。
この基準で、関連するすべての指示をスラッシュコマンドに移行しました。

## コード抜粋

### 変更前のCLAUDE.md（問題のあった部分）

```markdown
## 🥇 1. 最上位行動原則 (マスター・ルール)

- **唯一の規範**: 開発フローは以下の2層で定義されています。
  - **Lv1: フロー骨格** (開発フロー簡略図)
  - **Lv2: フロー詳細** (各フロー定義書)
- **自律性の原則**: オペレーター（人間）からの指示は、フローのステップ指定のみです。
- **ドキュメントの更新**: 作業完了時、またはステータス変更時、必ず関連する進捗ログを正確に更新し、進捗を人間と共有してください。
```

**問題点**:

- 特定のフロー実行時のみ必要な詳細指示が含まれている
- 毎回の会話でロードされ、コンテキストを圧迫

### 変更後：スラッシュコマンド（.claude/commands/tdd-flow.md）

```markdown
# 開発フロー実行

あなたは、新規機能開発や改修の開発フローを実行します。以下の規範に従い、自律的にタスクを完了してください。

## 🥇 最上位行動原則（マスター・ルール）

- **唯一の規範**: 開発フローは以下の2層で定義されています。
  - **Lv1: フロー骨格** (開発フロー簡略図)
  - **Lv2: フロー詳細** (各フロー定義書)
- **自律性の原則**: オペレーター（人間）からの指示は、フローのステップ指定のみです。
```

**改善点**:

- フロー実行時のみ必要な指示を分離
- スラッシュコマンドで必要時のみロード
- 約1,600トークンのコンテキスト削減

### 変更後のCLAUDE.md（公式推奨形式）

```markdown
## 🔧 共通bashコマンドとその目的

開発時に頻繁に使用するコマンド一覧：

| コマンド | 目的 | 備考 |
|:---|:---|:---|
| `npm run dev:wrangler` | 開発サーバー起動 | Wranglerでランタイム制約を反映した開発環境を起動（必須） |
| `npm test` | ユニットテスト実行 | Vitestを使用（E2Eはオペレーターが実行） |
| `npm run typecheck` | 型チェック | すべてのTypeScriptファイルを検証 |
| `npm run lint:all` | 全リント実行 | テンプレート、CSS、ブログメタデータを検証 |
```

**改善点**:

- Anthropic公式推奨の「共通コマンドとその目的」形式に準拠
- 「備考」欄でプロジェクト固有のルール（「必須」「オペレーターが実行」）を明示
- Claudeが自律的に正しいコマンドを選択可能に

## 今回の学びと感想

### 学び1: 「公式推奨」は「具体的なユースケース」を含む

Anthropic公式のベストプラクティスは、単なる「何を書くべきか」のリストではなく、「開発時に頻繁に使用するコマンド一覧」のような**実践的なユースケース**を含んでいました。
この「具体性」が、AIが自律的に判断できる鍵だと実感しました。

### 学び2: スラッシュコマンドの「適用基準」を明確にする重要性

「何をスラッシュコマンドに移行すべきか」の基準（「毎回参照されるべき内容か？」）を明確にすることで、判断に迷わず一貫した設計ができました。
この基準は、他のプロジェクトにも適用できる汎用的な指針だと考えています。

## 感想

CLAUDE.mdの最適化は、単なる「ドキュメント整理」ではなく、**AIとの協調開発の効率を左右する重要な設計判断**だと実感しました。
Anthropic公式のベストプラクティスを「そのまま適用」するのではなく、プロジェクト固有の制約（「npm run dev:wranglerが必須」など）を「備考」欄で明示する工夫により、公式形式とプロジェクトルールの両立を実現できました。

同じような課題で悩んだ方はいませんか？
もっと良い最適化方法があれば教えてください！
