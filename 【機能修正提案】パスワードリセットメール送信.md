# 【機能修正提案】パスワードリセットメール送信の本実装

- **サービス**: `account`
- **セクション**: `authentication`
- **関連ドキュメント**:
  - `develop/account/authentication/func-spec.md` (§4 パスワードリセット要求)
  - `develop/account/authentication/data-flow-diagram.md` (パスワードリセットメール送信フロー)
  - `develop/account/authentication/file-list.md`
  - `develop/account/authentication/TDD_WORK_FLOW.md` (§3.3.3, §7)

---

## 1. 提案概要

パスワードリセット要求時のメール送信を、MVPスタブ（console.log）から Resend API を使った本実装に切り替え、リセットリンクURLをリクエストオリジンから動的に生成する。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- `forgot-password.tsx` の action で、リセットリンクを `console.log` に出力しているだけ（メール未送信）
- リセットリンクURL が `http://localhost:8788` にハードコード
- `sendAuthEmail.server.ts` の型定義が `'magic-link' | 'otp'` のみ対応

```typescript
// forgot-password.tsx L133-141（現状）
// TODO: Send email with reset link
const resetLink = `http://localhost:8788/reset-password/${token}`;
console.log('PASSWORD RESET LINK (MVP - Check console):');
```

### 修正後 (To-Be)

- `sendAuthEmail.server.ts` に `'password-reset'` タイプを追加し、Resend API 経由でリセットメールを送信
- リセットリンクURL を `request.url` のオリジンから動的に生成
- `forgot-password.tsx` の action で実際にメール送信を実行

```typescript
// forgot-password.tsx action（修正後イメージ）
const origin = new URL(request.url).origin;
const resetLink = `${origin}/reset-password/${token}`;
await sendAuthEmail({
  to: sanitizedEmail,
  type: 'password-reset',
  payload: resetLink,
  resendApiKey: context.env.RESEND_API_KEY,
});
```

## 3. 背景・目的

### 背景

Preview環境（`425d5a1b.claudemix.pages.dev`）でパスワードリセットをテストしたところ、メールが届かなかった。ログ確認の結果、メール送信が未実装（console.logのみ）であり、リセットリンクURLもlocalhostにハードコードされていることが判明した。

func-spec.md では「パスワードリセットメール送信」が明確に仕様として定義されており、TDD_WORK_FLOW.md の「将来実装」注記に基づいてMVPスタブのまま残されていた。

### 目的

- **目的1**: func-spec.md の仕様通りにメール送信を実装する
- **目的2**: リセットリンクURLを環境に依存しない動的生成に変更する
- **目的3**: 既存の `sendAuthEmail.server.ts` を拡張し、コードの重複を防ぐ

## 4. 変更の妥当性 (Pros / Cons)

Pros (利点):

- func-spec.md の仕様に完全に準拠する
- 既存の `sendAuthEmail.server.ts`（Resend API基盤）を再利用し、DRY原則を維持
- OTP認証で実績のある Resend API パターンをそのまま適用できる
- リクエストオリジンからURL生成するため、dev/preview/production 全環境で動作

Cons (懸念点):

- `RESEND_API_KEY` が Cloudflare Pages の環境変数に設定されていない場合、メール送信が失敗する（ただしセキュリティ上、成功メッセージは返す）
- data-flow-diagram.md では `sendPasswordResetEmail.server` という別関数名が参照されているが、本提案では既存の `sendAuthEmail.server.ts` を拡張する（関数名の不一致）

**総合評価**:
既存の Resend API インフラを再利用するアプローチは、3大層分離アーキテクチャの原則（副作用層の共通化）に合致しており、**妥当性が高い**と判断する。data-flow-diagram.md の関数名不一致は、実装完了後にドキュメントを更新して解消する。

## 5. 設計フロー

### GUIDING_PRINCIPLES.md

変更なし（パスワードリセットのデータフロー記載は既に正確）

### func-spec.md

変更なし（§4 パスワードリセット要求の仕様が既に正確に記載済み）

### uiux-spec.md

変更なし（UIの変更なし）

### spec.yaml

**追記**: `password_reset_email` セクションを新設。メール件名・本文テンプレートを定義。

```yaml
# ==========================================
# パスワードリセットメール設定
# ==========================================
password_reset_email:
  subject: "パスワードリセットのご案内"
  body_template: |
    以下のリンクをクリックしてパスワードをリセットしてください：

    {reset_link}

    このリンクは1時間有効です。
    心当たりのない場合は、このメールを無視してください。
  from: "ClaudeMix <onboarding@resend.dev>"
  ttl_display: "1時間"
```

### file_list.md

変更なし（`sendAuthEmail.server.ts` は既に記載済み。新規ファイルなし）

### data-flow-diagram.md

**修正**: `sendPasswordResetEmail.server` → `sendAuthEmail.server`（関数名を実態に合わせる）

## 6. TDD_WORK_FLOW.md 簡易版

### e2e-screen-test

変更なし

### e2e-section-test

- `tests/e2e/account/password-reset.spec.ts` — メール送信成功後の成功メッセージ表示テストは既存。実際のメール到達はE2Eスコープ外。

### CSS実装 (layer2.css, layer3.ts, layer4.ts)

変更なし

### route

- **[既存修正]** `app/routes/forgot-password.tsx` — action 内の console.log を `sendAuthEmail` 呼び出しに置換。リセットリンクURLを `new URL(request.url).origin` から動的生成。

### components.test

変更なし

### components

変更なし

### logic.test

変更なし

### logic

変更なし

### data-io.test

- **[既存修正]** `app/data-io/account/authentication/sendAuthEmail.server.test.ts` — `'password-reset'` タイプの送信テストを追加。

### data-io

- **[既存修正]** `app/data-io/account/authentication/sendAuthEmail.server.ts` — type に `'password-reset'` を追加。件名・本文を spec.yaml から取得。

### その他

- **[既存修正]** `app/specs/account/authentication-spec.yaml` — `password_reset_email` セクション追加
- **[確認]** Cloudflare Pages 環境変数に `RESEND_API_KEY` が設定されていること
- **[既存修正]** `develop/account/authentication/data-flow-diagram.md` — 関数名修正（実装後）
- **[既存修正]** `develop/account/authentication/file-list.md` — `sendAuthEmail.server.ts` の責務説明を更新（OTP + パスワードリセット）
