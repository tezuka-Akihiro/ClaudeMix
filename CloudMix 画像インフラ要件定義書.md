# 📄 CloudMix 画像インフラ要件定義書

## 1. ストレージ・管理要件（Backend / Image Repository）

### A. 保存構造と役割の分離

- **配信領域（R2 Bucket）**: `claudemix-assets/blog/[slug]/[filename].[size].avif`
  - **役割**: ブラウザへの高速配信のみ。
  - **構造**: フラット。フォルダ分けなし。

- **管理領域（Local Repository）**: `image-repo/masters/blog/[slug]/[filename].[ext]`
  - **役割**: 高画質マスターの永続管理。
  - **運用**: このマスターを元に、Jules（変換ロジック）がR2へ配信用のバリアントを生成・出力する。

### B. 画像バリエーション定義（R2へ出力）

| 識別子 (size) | 横幅 (Width) | 圧縮設定 |
| :--- | :--- | :--- |
| `lg` | 1200px | quality: 60, effort: 9 |
| `sm` | 600px | quality: 50, effort: 9 |

### C. 命名・連番規則

- **サムネイル**: `lg.avif` / `sm.avif`
- **本文内画像**: `1.lg.avif` 〜 `9.lg.avif`（最大9枚）
  - リポジトリ内のマスターも、この連番で管理することで、配信ファイルとの紐付けを直感的にする。

## 2. 表示・配信要件（Frontend / Remix）※変更なし

- **物理的レスポンシブ**: `srcset` を活用し、スマホでは `sm.avif` を強制。
- **キャッシュ**: `immutable` 設定で1年間のキャッシュを付与。

## 3. 非機能要件（管理哲学）

- **マスターの尊厳**: R2上のファイルはいつでも破棄・再生成可能とする。本質的な価値はリポジトリ内のマスター画像に集約する。
- **運用の規律**: 1〜9の連番制を維持することで、記事あたりのアセット量を物理的に制限し、長期的なパフォーマンス劣化を防ぐ。
