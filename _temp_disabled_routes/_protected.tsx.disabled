/**
 * セッション保護用Layout Route
 * 認証が必要なページはこのRouteの配下に配置
 *
 * 使用例:
 * - app/routes/_protected.dashboard.tsx → /dashboard (要認証)
 * - app/routes/_protected.settings.tsx → /settings (要認証)
 */

import { redirect } from "@remix-run/node";
import type { LoaderFunctionArgs } from "@remix-run/node";
import { Outlet } from "@remix-run/react";
import { getUserFromSession } from "~/lib/session/session.server";

export async function loader({ request }: LoaderFunctionArgs) {
  const user = await getUserFromSession(request);

  // 未認証の場合はログインページへリダイレクト
  if (!user) {
    const url = new URL(request.url);
    const redirectTo = url.pathname + url.search;
    const searchParams = new URLSearchParams([["redirectTo", redirectTo]]);
    throw redirect(`/login?${searchParams}`);
  }

  return null;
}

export default function ProtectedLayout() {
  return <Outlet />;
}
