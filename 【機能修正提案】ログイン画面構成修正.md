# 【機能修正提案】ログイン画面構成をワイヤーフレームに準拠させる

- **サービス**: `account`
- **セクション**: `authentication`
- **関連ドキュメント**:
  - `develop/account/authentication/loginワイヤーフレーム.png`
  - `develop/account/authentication/func-spec.md`
  - `develop/account/authentication/uiux-spec.md`
  - `app/specs/account/authentication-spec.yaml`
  - `app/routes/login.tsx`

---

## 1. 提案概要

ログイン画面（`/login`）の構成要素の順序・配置をワイヤーフレームに準拠するよう修正し、OTPフォームをログインページから削除して「パスワードをお忘れですか？」リンク経由のフローに統合する。また、利用規約・プライバシーポリシーへの同意文言をカード最下部に追加する。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

```
┌─────────────────────────┐
│  h1: ログイン            │
│  subtitle: ClaudeMixに   │
│           ログイン       │
│                         │
│  [Flash Message]        │
│  [Error Message]        │
│                         │
│  ┌─ Password Login ───┐ │
│  │ Email              │ │
│  │ Password           │ │
│  │ [ログイン]          │ │
│  └────────────────────┘ │
│                         │
│  ───── or ─────         │
│                         │
│  ┌─ OTP Form ────────┐ │
│  │ Email              │ │
│  │ [次へ]             │ │
│  └────────────────────┘ │
│                         │
│  [Google でログイン]     │
│                         │
│  パスワードをお忘れですか？│
│                         │
│  アカウントをお持ちでない？│
│  [新規登録]              │
└─────────────────────────┘
```

**問題点**:
- Google loginがページ下部に配置されており、視認性が低い
- OTPフォームがログインページ内に直接配置されており、フォームが2つ並ぶ煩雑なUI
- ワイヤーフレームで定義された構成順序と乖離している

### 修正後 (To-Be)

```
┌─────────────────────────┐
│        [icon]           │
│                         │
│  ClaudeMixへログイン     │
│  アカウントをお持ちで     │
│  ないですか？            │
│                         │
│  [Flash Message]        │
│  [Error Message]        │
│                         │
│  [Google でログイン]     │
│                         │
│  ───── or ─────         │
│                         │
│  Email                  │
│  [          ]           │
│                         │
│  Password  お忘れですか？ │
│  [          ]           │
│                         │
│  [log in]               │
│                         │
│  ログインにより、利用規約 │
│  と個人情報の取り扱いに   │
│  同意したことになります。 │
└─────────────────────────┘
```

**変更ポイント**:

| # | 変更内容 | 詳細 |
|---|---------|------|
| 1 | アイコン追加 | カード上部にブランドアイコンを配置 |
| 2 | タイトル統合 | h1を「ClaudeMixへログイン」に変更（現在の title + subtitle を統合） |
| 3 | 登録案内をサブタイトル化 | 「アカウントをお持ちでないですか？」をタイトル直下に移動し、クリックで`/register`遷移 |
| 4 | Google loginを上部に移動 | OAuthボタンをフォームより上（タイトル直下）に配置 |
| 5 | or区切り線の位置変更 | Google login と Email/Passwordフォームの間に配置 |
| 6 | OTPフォーム削除 | ログインページからOTPフォームを完全に削除 |
| 7 | パスワード忘れリンク移動 | Passwordラベルの横に「パスワードをお忘れですか？」を配置、`/forgot-password`へリンク |
| 8 | 下部の登録セクション削除 | サブタイトル位置に移動したため不要 |
| 9 | 利用規約同意文言追加 | カード最下部に小さいフォントで「ログインにより、利用規約と個人情報の取り扱いに同意したことになります。」を表示。「利用規約」と「個人情報の取り扱い」はそれぞれリンク付き |

## 3. 背景・目的

### 背景

ワイヤーフレーム（`loginワイヤーフレーム.png`）で定義されたログイン画面の構成と、現在の実装が大きく乖離している。特にGoogle loginの配置が低い位置にあり、OTPフォームが直接配置されることでフォームが2つ並ぶ煩雑なUIになっている。

### 目的

- **目的1**: ワイヤーフレームへの準拠 — 設計と実装の一致を確保する
- **目的2**: UI簡素化 — OTPフォームを削除し、シンプルな1フォーム構成にする
- **目的3**: Google loginの視認性向上 — 最も簡単な認証方法を上部に配置する

## 4. 変更の妥当性 (Pros / Cons)

Pros (利点):

- ワイヤーフレームとの整合性が確保され、設計と実装の乖離が解消される
- Google loginが上部に移動し、最も手軽な認証方法の発見性が向上する
- OTPフォーム削除により、ログインページがシンプルになりUXが向上する
- 「パスワードをお忘れですか？」リンクが直感的な位置（Password横）に配置される
- 利用規約・プライバシーポリシーへの同意文言の追加により、トラブル防止の法的基盤が強化される

Cons (懸念点):

- OTPフォームがログインページから消えるため、OTPでの直接ログインまでの導線が1ステップ増える（`/forgot-password`経由）
- login.tsx内のOTP関連サーバーコード（action内のsend-otp intent）が未使用になる可能性

**総合評価**:
Consは軽微であり、ワイヤーフレーム準拠とUI簡素化というメリットが大きく上回る。OTP機能は`/forgot-password`経由で引き続きアクセス可能であるため、機能的な欠損はない。この変更は**妥当性が高い**と判断する。

## 5 設計フロー

### GUIDING_PRINCIPLES.md

**変更なし**。今回の変更はログイン画面のUI構成のみであり、アーキテクチャ原則・データストレージ戦略・ルーティング規約への影響はない。OTP機能自体はシステムから削除されず、`/forgot-password` → `/auth/otp` の導線で引き続き利用可能。

### func-spec.md

**変更あり** — 以下を編集：

- **「2. ログイン (Login)」セクション**: ログインページの主要なUI要素の記述を更新。OTPフォームがログインページから削除され、Google loginが上部に移動したことを反映
- **「6. OTPコード送信 (Send OTP)」セクション**: URL説明を修正。OTP送信はログインページのUIからではなく、`/forgot-password` 経由で開始される旨を追記。ただしlogin.txの action 内の `send-otp` intent コードは OtpVerifyForm の「コードを再送信」機能で引き続き使用されるため、サーバーサイドコードは維持

### uiux-spec.md

**変更あり** — 以下を編集：

- **Login Page 構造図（Mermaid）**: 現在の「OTPメインストリーム」構造図を、ワイヤーフレーム準拠の新構造に全面書き換え：
  - Icon → Title → RegisterLink(subtitle) → GoogleButton → Divider → LoginForm(Email + Password + ForgotLink) → SubmitButton → TermsText
- **「2. LoginForm」コンポーネント設計規範**: 子コンポーネント構成を更新
  - 追加: Icon、TermsText（利用規約同意文言）
  - 追加: `パスワードをお忘れですか？` リンクをPasswordフィールド横に配置
  - 削除: OTPフォーム関連の記述をLogin Page構造から削除（OtpVerifyFormは auth.otp.tsx から引き続き利用）

### spec.yaml

**変更あり** — `app/specs/account/authentication-spec.yaml` に以下を追加：

- `routes.login` に `terms_text` を追加:
  ```yaml
  terms_text: "ログインにより、{terms_link}と{privacy_link}に同意したことになります。"
  terms_link_label: "利用規約"
  terms_link_path: "/terms"
  privacy_link_label: "個人情報の取り扱い"
  privacy_link_path: "/privacy"
  ```
- `routes.login` に `subtitle` を追加:
  ```yaml
  subtitle: "アカウントをお持ちでないですか？"
  ```

### file_list.md

**変更なし**。新規ファイルの追加・既存ファイルの削除はない。OTP関連ファイルは `/auth/otp` ルートで引き続き使用されるため維持。

### data-flow-diagram.md

**軽微な変更** — 以下を編集：

- **「OTPコード送信フロー」**: ユーザー起点の説明を「/login アクセス → OTP送信フォーム」から「/forgot-password 経由でOTP送信」に修正
- **「ログインフロー」のClient セクション**: LoginForm の子要素リストを新構造に合わせて更新（Google Button 追加、RegisterLink 位置変更、TermsText 追加）

## 6 TDD_WORK_FLOW.md 簡易版

> 新規ファイルなし。全て既存ファイルの編集のみ。

### e2e-screen-test

- 該当なし（画面レベルE2Eテストは未作成）

### e2e-section-test

- `tests/e2e/account/authentication.spec.ts` — 「should display login form」テストケースを更新。Google loginボタン・利用規約文言・新構成要素の存在確認を追加。OTP送信フォームの検証があれば削除

### CSS実装 (layer2.css, layer3.css)

- `app/styles/account/layer2-authentication.css` — 利用規約同意文言用のスキン（`.auth-terms-text`）、Passwordラベル行用のスキン（`.auth-password-label-row`）を追加
- `app/styles/account/layer3-authentication.css` — 利用規約同意文言の構造（`.auth-terms-text-structure`）、Passwordラベル行の横並び構造（`.auth-password-label-row-structure`）を追加

### route

- `app/routes/login.tsx` — JSXの構成要素を全面的に再配置（ワイヤーフレーム準拠）。loader の `uiSpec` に `subtitle`、`terms` 関連フィールドを追加。OTPフォームのJSXを削除。action 側の `send-otp` intent コードは維持（OtpVerifyForm の再送信で使用）

### components.test

- 該当なし（LoginForm コンポーネントは現在 route 内に直接記述されており、独立コンポーネントとして分離されていない）

### components

- 該当なし（同上。route 内のJSXを直接編集する）

### logic.test

- 該当なし（UI構成変更のみ。純粋ロジックへの変更なし）

### logic

- 該当なし

### data-io.test

- 該当なし（サーバーサイドロジックへの変更なし）

### data-io

- 該当なし

### その他

- `app/specs/account/authentication-spec.yaml` — 反映済み（`routes.login` に `subtitle`、`terms_*` フィールド追加）
- `app/specs/account/authentication-schema.ts` — spec.yaml に新しいフィールドを追加したため、型定義の確認・更新が必要になる可能性あり
