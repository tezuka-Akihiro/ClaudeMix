# 【機能修正提案】ブログ画像機能追加（R2連携）

- **サービス**: `blog`
- **セクション**: `posts`, `post-detail`, `common`（複数セクションに関与）
- **関連ドキュメント**:
  - `develop/blog/posts/func-spec.md`
  - `develop/blog/post-detail/func-spec.md`
  - `develop/blog/common/func-spec.md`
  - `app/specs/blog/posts-spec.yaml`
  - `app/specs/blog/post-detail-spec.yaml`
  - `app/specs/blog/common-spec.yaml`

---

## 1. 提案概要

Cloudflare R2で管理される画像をブログシステムに統合します。**「ゼロ設定」方式**を採用し、フロントマターへの記述不要で、スラグベースの規約によりシステムが自動でサムネイルをルーティングします。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- **記事一覧（posts）**: タイトル、日付、カテゴリ、タグのみ表示。画像なし。
- **記事詳細（post-detail）**: タイトル、本文のみ。サムネイル画像なし。
- **OGP（common）**: テキストのみの動的OGP画像生成。カスタムサムネイル未対応。
- **画像管理**: R2との連携なし。

### 修正後 (To-Be)

- **記事一覧（posts）**: R2にサムネイルが存在する場合、記事カードに自動表示。
- **記事詳細（post-detail）**: R2にサムネイルが存在する場合、記事冒頭に自動表示。
- **OGP（common）**: R2にサムネイルが存在すればそれを使用、なければ従来のテキストベースOGP。
- **画像管理**: スラグベースの規約によりR2から自動取得。**フロントマター記述不要**。

### R2バケット構造（フラット設計）

```
claudemix-assets/
└─ blog/
   └─ [slug]/                    # 記事のスラグ名でフォルダ作成
      ├─ thumbnail.webp          # 固定名：サムネイル（1200x630px）
      ├─ 1.webp                  # 記事内画像：登場順
      ├─ 2.webp
      └─ ...                     # 最大9枚まで（1〜9）
```

### R2画像仕様

| 項目 | サムネイル | 記事内画像 |
|------|-----------|-----------|
| フォーマット | WebP (.webp) | WebP (.webp) |
| 解像度 | 1200 × 630 px | 任意 |
| アスペクト比 | 1.91 : 1 | 任意 |
| ファイル名 | `thumbnail.webp`（固定） | `1.webp` 〜 `9.webp` |
| 目標容量 | 100KB以下 | 200KB以下 |
| 品質設定 | 75% 〜 80% | 75% 〜 80% |

### URL構造

| 用途 | URL |
|------|-----|
| サムネイル | `https://assets.claudemix.dev/blog/{slug}/thumbnail.webp` |
| 記事内画像 | `https://assets.claudemix.dev/blog/{slug}/1.webp` |

例: `https://assets.claudemix.dev/blog/stripe-integration/thumbnail.webp`

### 「ゼロ設定」表示ロジック

```
┌─────────────────────────────────────────────────────────┐
│  R2に /blog/{slug}/thumbnail.webp が存在するか？        │
└─────────────────────────────────────────────────────────┘
              │
    ┌─────────┴─────────┐
    │                   │
  存在する            存在しない
    │                   │
    ▼                   ▼
サムネイル表示      テキストベース
（記事一覧/詳細/OGP）  動的OGP生成
```

**メリット**:
- Markdownにパスを書き込む手間を排除
- パスの打ち間違い（見えないエラー）を物理的に防止
- ファイル命名に迷う時間をゼロに
- 10枚以上の画像肥大化を抑制

## 3. 背景・目的

### 背景

- SNSでのシェア時に視覚的な訴求力が不足している
- 記事一覧ページがテキストのみで視覚的な区別がつきにくい
- R2は既にCloudflare環境で利用可能であり、画像配信に最適

### 目的

- **目的1**: SNSシェア時の視覚的訴求力向上（カスタムOGP画像）
- **目的2**: 記事一覧ページのUX向上（サムネイル表示による視認性向上）
- **目的3**: 記事詳細ページの表現力向上（アイキャッチ画像）
- **目的4**: R2による画像アセット管理の一元化
- **目的5**: 運用負荷の最小化（ゼロ設定方式）

## 4. 変更の妥当性 (Pros / Cons)

### Pros (利点)

- **運用負荷ゼロ**: フロントマター記述不要、規約ベースの自動ルーティング
- **エラー防止**: パス指定ミスが物理的に発生しない
- **SNS訴求力向上**: カスタムOGP画像により、シェア時のクリック率向上が期待できる
- **UX改善**: 記事一覧・詳細ページの視覚的な魅力向上
- **既存インフラ活用**: Cloudflare R2を使用するため追加コストが最小限
- **後方互換性**: サムネイルがなければ従来動作、既存記事への影響なし
- **シンプルなURL構造**: `blog/{slug}/thumbnail.webp` の予測可能な設計
- **肥大化抑制**: 記事内画像は最大9枚に制限

### Cons (懸念点)

- **複数セクションへの変更**: posts, post-detail, commonの3セクションに変更が及ぶ
- **画像存在確認**: R2への問い合わせが発生（キャッシュで軽減可能）
- **画像アップロード運用**: R2への画像アップロードは別途手動/スクリプト対応が必要

### 総合評価

Consは存在するものの、いずれも管理可能な範囲内です。特に「ゼロ設定」方式により運用負荷を最小化し、エラーを物理的に排除できる点が大きなメリットです。SNS訴求力とUX向上という明確な価値があるため、この変更は**妥当性が高い**と判断します。

---

## 5 設計フロー

以下の設計ドキュメントを上から順に確認し、編集内容を追記。

### 🗾GUIDING_PRINCIPLES.md

変更なし（原則への影響なし）

### 📚️func-spec.md

#### blog/posts/func-spec.md
- R2からサムネイルURL自動解決機能を追加
- サムネイル未存在時のフォールバック動作を定義

#### blog/post-detail/func-spec.md
- R2からサムネイルURL自動解決機能を追加
- サムネイル未存在時の動作（非表示）を定義

#### blog/common/func-spec.md
- OGP画像生成時のR2サムネイル利用ロジックを追加
- サムネイル存在時は画像URLを直接返却、未存在時は動的OGP生成

### 🖼️uiux-spec.md

#### blog/posts/uiux-spec.md
- PostCardコンポーネントにサムネイル画像表示領域を追加
- アスペクト比1.91:1の画像コンテナ仕様
- サムネイル未存在時の表示仕様

#### blog/post-detail/uiux-spec.md
- ArticleHeaderにサムネイル画像表示を追加
- レスポンシブ対応の画像表示仕様

### 📋️spec.yaml

#### blog/posts-spec.yaml
- R2画像設定セクション追加（ベースURL、ファイル名規約）

#### blog/post-detail-spec.yaml
- R2画像設定セクション追加

#### blog/common-spec.yaml
- R2アセットベースURL設定を追加
- OGPセクションにサムネイルフォールバック設定を追加

### 🗂️file_list.md

- `app/lib/blog/common/buildThumbnailUrl.ts` - サムネイルURL生成ロジック（新規）

### 🧬data-flow-diagram.md

#### blog/posts/data-flow-diagram.md
- R2からのサムネイルURL解決フローを追加

#### blog/post-detail/data-flow-diagram.md
- R2からのサムネイルURL解決フローを追加

---

## 6 TDD_WORK_FLOW.md 簡易版

### 👁️e2e-screen-test

- `tests/e2e/blog/posts.spec.ts` - サムネイル表示確認テスト追加
- `tests/e2e/blog/post-detail.spec.ts` - サムネイル表示確認テスト追加

### 👁️e2e-section-test

変更なし

### 🎨CSS実装 (layer2.css, layer3.ts, layer4.ts)

- `app/styles/layer2-sections/blog.css` - サムネイル画像のスタイル追加

### 🪨route

- `app/routes/blog._index.tsx` - thumbnailUrlをloaderから返却
- `app/routes/blog.$slug.tsx` - thumbnailUrlをloaderから返却
- `app/routes/blog.$slug.ogp[.png].tsx` - R2サムネイル対応ロジック追加

### 🚧components.test

- `app/components/blog/posts/PostCard.test.tsx` - サムネイル表示テスト追加
- `app/components/blog/post-detail/ArticleHeader.test.tsx` - サムネイル表示テスト追加

### 🪨components

- `app/components/blog/posts/PostCard.tsx` - サムネイル画像表示追加
- `app/components/blog/post-detail/ArticleHeader.tsx` - サムネイル画像表示追加

### 🚧logic.test

- `app/lib/blog/common/buildThumbnailUrl.test.ts` - URL生成ロジックテスト（新規）

### 🪨logic

- `app/lib/blog/common/buildThumbnailUrl.ts` - サムネイルURL生成関数（新規）

### 🚧data-io.test

- `app/data-io/blog/posts/fetchPosts.server.test.ts` - thumbnailUrl追加テスト
- `app/data-io/blog/post-detail/fetchPostBySlug.server.test.ts` - thumbnailUrl追加テスト

### 🪨data-io

- `app/data-io/blog/posts/fetchPosts.server.ts` - thumbnailUrlをPostSummaryに追加
- `app/data-io/blog/post-detail/fetchPostBySlug.server.ts` - thumbnailUrlを返却

### その他

- `app/specs/blog/types.ts` - PostSummary型にthumbnailUrl?: stringを追加

---

## 確認事項

Phase 1完了（ユーザーフィードバック反映済み）。以下についてご確認ください：

1. **「ゼロ設定」方式**: フロントマター不要、スラグベースの自動ルーティングで問題ないか
2. **R2 URL構造**: `https://assets.claudemix.dev/blog/{slug}/thumbnail.webp` で問題ないか
3. **記事内画像**: `1.webp` 〜 `9.webp` の命名規約で問題ないか
4. **Pros/Cons**: 評価が妥当か

確認が取れ次第、Phase 2（設計ドキュメント反映）に進みます。
