# 【機能修正提案】ライトモード・ダークモードのテーマ切り替え機能追加

- **サービス**: `blog`
- **セクション**: `common`, `posts`, `post-detail`
- **関連ドキュメント**:
  - `docs\CSS_structure\STYLING_CHARTER.md`

---

## 1. 提案概要

> ブログサービスにライトモードとダークモードのテーマ切り替え機能を追加し、ユーザーが自身の閲覧環境や好みに合わせて表示スタイルを選択できるようにすることで、可読性とUXを向上させます。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- 現在のブログサービスはダークモードのテーマのみで提供されています。
- ユーザーが表示モードを切り替える機能は存在しません。

### 修正後 (To-Be)

- ヘッダーにライト/ダークモードを切り替えるためのテーマ変更ボタンを設置します。
- ユーザーがボタンをクリックすることで、サイト全体のカラースキームがライトモードとダークモードで即座に切り替わります。
- 影響範囲のコンポーネント（ヘッダー、フッター、記事一覧、記事詳細など）のスタイルが、選択されたテーマに応じて動的に変更されます。
- ユーザーの選択したテーマ設定は、ブラウザに保存され、次回以降のアクセス時にも維持されます。

## 3. 背景・目的

### 背景

現在のブログサービスはダークモードのテーマしか提供しておらず、ユーザーの閲覧環境（例：日中の明るい場所）や個人の好みによっては、コンテンツが読みにくい場合があります。ユーザーに表示モードの選択肢を提供することは、アクセシビリティとユーザー体験を向上させる上で不可欠です。

### 目的

- **目的1**: ユーザーにテーマ選択の自由を提供し、UXを向上させる。
- **目的2**: ライトモードを追加することで、特に明るい環境下でのテキストの可読性を高める。
- **目的3**: ユーザーが自身にとって最適なコントラストを選択できるようにし、アクセシビリティを向上させる。

## 4. 変更の妥当性 (Pros / Cons)

`@ArchitectureGuardian` の視点に基づき、この変更がプロジェクトの設計思想に合致するかを評価します。

Pros (利点):

- **`STYLING_CHARTER.md`への準拠**: テーマ（ライト/ダーク）のカラースキームをLayer 1（`globals.css`）のCSSカスタムプロパティ（デザイントークン）で一元管理するため、アーキテクチャの原則を完全に遵守します。
- **高い保守性と拡張性**: コンポーネントのスタイル（Layer 2以降）は、具体的な色コードではなく意味的なCSS変数を参照します。これにより、新しいコンポーネントを追加する際にテーマを意識する必要がなく、将来的な配色の変更も`globals.css`の修正のみで完結します。
- **関心の分離**: 「テーマの定義（CSS変数）」「スタイルの適用（コンポーネントCSS）」「テーマの切り替え（TSXのボタン操作）」が明確に分離され、各レイヤーの責務が守られます。TSXファイルにスタイルに関する複雑なロジック（クラス名の動的変更など）が混入するのを防ぎます。

Cons (懸念点):

- **初期のトークン設計コスト**: ライトモードとダークモードの両方で意味が通じる、一貫性のあるデザイントークン（CSS変数名）をLayer 1で網羅的に設計する必要があります。
- **FOUC (Flash of Unstyled Content) 対策**: ページ読み込み時に一瞬デフォルトテーマが表示されるのを防ぐため、`<html>`タグにテーマを適用するスクリプトを早い段階で実行するなどの対策が必要になります。

**総合評価**:
*Pros/Consを踏まえ、この変更の妥当性について総合的な評価を記述します。*

> Consとして挙げた項目は、堅牢な設計を行う上での健全なコストです。CSSカスタムプロパティを基盤とする本アプローチは、`STYLING_CHARTER.md`の設計思想に完全に合致しており、プロジェクト全体の保守性と拡張性を大幅に向上させます。したがって、この変更は**非常に妥当性が高い**と判断します。

## 5 設計フロー

以下の設計ドキュメントを上から順に確認し、編集内容を追記して。

### 🗾 GUIDING_PRINCIPLES.md

- **変更箇所**: `develop/blog/GUIDING_PRINCIPLES.md`
- **変更内容**:
  - 「4. 用語集 (Glossary)」に `Theme`, `Light Mode`, `Dark Mode` を追加する。
  - 「4. セクション間連携と共通化方針」の `common` セクションの責務に「テーマ切り替え機能の提供」を追記する。

### 📚️ func-spec.md

- **変更箇所**: `develop/blog/common/func-spec.md`, `develop/blog/posts/func-spec.md`, `develop/blog/post-detail/func-spec.md`
- **変更内容**:
  - **`common/func-spec.md`**:
    - **app/components要件**: ヘッダーにテーマ（ライト/ダーク）切り替えボタンを実装する。ボタンは現在のテーマ状態を視覚的に示す。
    - **副作用要件**: ユーザーが選択したテーマ設定を `localStorage` に保存し、次回アクセス時に復元する。
  - **`posts/func-spec.md`, `post-detail/func-spec.md`**:
    - **app/components要件**: `common` セクションで管理されるテーマ状態に応じて、コンポーネントの配色が自動的に切り替わること。

### ️ uiux-spec.md

- **変更箇所**: `develop/blog/common/uiux-spec.md`, `develop/blog/posts/uiux-spec.md`, `develop/blog/post-detail/uiux-spec.md`
- **変更内容**:
  - **`common/uiux-spec.md`**:
    - **Component責務**:
      - `Header` コンポーネントの構成図に `ThemeToggleButton` を追加する。
      - `ThemeToggleButton` の仕様を新規追加：
        - **UI**: 太陽（ライトモード時）と月（ダークモード時）のアイコンを持つボタン。
        - **インタラクション**: クリック時に `<html>` タグの `data-theme` 属性を `light`/`dark` に切り替え、設定を `localStorage` に保存する。
        - **FOUC対策**: ページ読み込み時のちらつきを防ぐため、インラインスクリプトを `<head>` に挿入する責務を持つ。
  - **`posts/uiux-spec.md`, `post-detail/uiux-spec.md`**:
    - **UIコンポーネント構成**: 各コンポーネント（記事カード、記事本文など）のワイヤーフレームに、ライトモードとダークモード両方の配色パターンを明記する。

### 📋️ spec.yaml

- **変更箇所**: なし
- **変更内容**: テーマの配色は `globals.css` のデザイントークンで管理するため、`spec.yaml` への変更は不要。

### 🗂️ file-list.md

- **変更箇所**: `develop/blog/common/file-list.md`
- **変更内容**:
  - **UI層**: `app/components/blog/common/ThemeToggleButton.tsx` (新規), `app/components/blog/common/ThemeToggleButton.test.tsx` (新規) を追加。`app/components/blog/common/Header.tsx` を修正対象とする。
  - **CSS**: `app/styles/globals.css` と `app/styles/blog/layer2.css` を修正対象として明記する。

### 🧬 data-flow-diagram.md

- **変更箇所**: `develop/blog/common/data-flow-diagram.md`
- **変更内容**:
  - `Header` コンポーネントの子要素として `ThemeToggleButton` を図に追加する。
  - `ThemeToggleButton` から `localStorage` へのデータ書き込み/読み込みがあることを注記として追記する。

## 6 TDD_WORK_FLOW.md 簡易版

以下の全項目に対して、実際のパスと編集内容を1行で記載して。
完全な計画ではなく、大枠がわかればよい。
特に、新規ファイルに関して把握したい。

### 👁️e2e-screen-test

- `tests/e2e/screen/blog.screen.spec.ts` (修正): 新しいテストグループ「E2E Screen Test for blog - Theme Toggle」を追加。ThemeToggleButtonの表示、クリックでdata-theme属性が切り替わること、localStorageに保存されること、ページリロード後もテーマが維持されることを検証

### 👁️e2e-section-test

- `tests/e2e/section/blog/common.spec.ts` (修正): commonセクションのE2Eテストにテーマ切り替えシナリオを追加

### 🎨CSS実装 (セクション別CSS, layer3.ts, layer4.ts)

- `app/styles/globals.css` (修正): ライトモード/ダークモード用のCSSカスタムプロパティ（デザイントークン）を定義。`html[data-theme="light"]`, `html[data-theme="dark"]`セレクタで配色を管理
- `app/styles/blog/common.css` (修正): common層の既存カスタムクラスをCSS変数ベースに変更（ハードコードされた色をトークンに置換）
- `app/styles/blog/posts.css` (修正): posts層の既存カスタムクラスをCSS変数ベースに変更
- `app/styles/blog/post-detail.css` (修正): post-detail層の既存カスタムクラスをCSS変数ベースに変更
- `app/styles/blog/layer3.ts` (確認): Tailwindクラスの組み合わせでテーマ対応のスタイルを定義（必要に応じて修正）

### 🪨route

- `app/routes/blog.tsx` (修正): ThemeToggleButtonのFOUC対策用インラインスクリプトを`<head>`に挿入（`<script>`タグでlocalStorageからテーマを読み込み、`<html>`タグに適用）

### 🚧components.test

- `app/components/blog/common/ThemeToggleButton.test.tsx` (新規): ThemeToggleButtonの単体テスト（クリックでdata-theme属性が切り替わること、localStorageに保存されることを検証）
- `app/components/blog/common/BlogHeader.test.tsx` (修正): HeaderにThemeToggleButtonが含まれることを検証

### 🪨components

- `app/components/blog/common/ThemeToggleButton.tsx` (新規): テーマ切り替えボタンコンポーネント。クリックで`<html data-theme>`を切り替え、localStorageに保存
- `app/components/blog/common/BlogHeader.tsx` (修正): HeaderActionsエリアを追加し、ThemeToggleButtonとmenuボタンを横並び配置

### 🚧logic.test

- なし（純粋ロジック層の変更なし）

### 🪨logic

- なし（純粋ロジック層の変更なし）

### 🚧data-io.test

- なし（副作用層の変更なし）

### 🪨data-io

- なし（副作用層の変更なし）

### その他

- `app/root.tsx` (確認): Remixのルートファイルに既存のインラインスクリプト実装があれば確認し、必要に応じて調整
