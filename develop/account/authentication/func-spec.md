# authentication - æ©Ÿèƒ½è¨­è¨ˆæ›¸

## ğŸ“‹ æ©Ÿèƒ½æ¦‚è¦

### æ©Ÿèƒ½å

Authentication (èªè¨¼)

### æ‰€å±ã‚µãƒ¼ãƒ“ã‚¹

**account** ã® **authentication** ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«é…ç½®

### æ©Ÿèƒ½ã®ç›®çš„ãƒ»ä¾¡å€¤

- **è§£æ±ºã™ã‚‹èª²é¡Œ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ¬äººç¢ºèªã¨ã€ã‚»ã‚­ãƒ¥ã‚¢ãªã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã‚’å®Ÿç¾ã™ã‚‹
- **æä¾›ã™ã‚‹ä¾¡å€¤**:
  - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å®‰å…¨ãªä¼šå“¡ç™»éŒ²ãƒ»ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼çŠ¶æ…‹ç®¡ç†
  - ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
- **ãƒ“ã‚¸ãƒã‚¹åŠ¹æœ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä¿è­·ã€ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

### å®Ÿè£…å„ªå…ˆåº¦

**HIGH** - `common`ã‚»ã‚¯ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã€æœ€å„ªå…ˆã§å®Ÿè£…ï¼ˆprofileã€subscriptionãŒä¾å­˜ï¼‰

## ğŸ¯ æ©Ÿèƒ½è¦ä»¶

### åŸºæœ¬æ©Ÿèƒ½

#### 1. ä¼šå“¡ç™»éŒ² (Registration)

**URL**: `/register`

**æ©Ÿèƒ½**:

- æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹ç™»éŒ²
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–ã¨å®‰å…¨ãªä¿å­˜
- ç™»éŒ²æˆåŠŸæ™‚ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³è‡ªå‹•ç”Ÿæˆã¨ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã¸ã®é·ç§»

**å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªï¼ˆå†å…¥åŠ›ï¼‰

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«å½¢å¼ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯ï¼‰
2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯
3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰ã®ä½œæˆï¼ˆD1 Databaseï¼‰
5. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆcommonã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ä½¿ç”¨ï¼‰
6. Cookieè¨­å®šã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆ`/account`ã¸ï¼‰

**å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿**:

- æˆåŠŸæ™‚: ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã‚’ç™ºè¡Œã—ã€`/account`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆãƒ•ã‚©ãƒ¼ãƒ ä¸Šï¼‰

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡: ã€Œã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯æ—¢ã«ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ã€
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—: å„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

#### 2. ãƒ­ã‚°ã‚¤ãƒ³ (Login)

**URL**: `/login`

**æ©Ÿèƒ½**:

- æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èªè¨¼ã¨ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹èªè¨¼
- ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLå¯¾å¿œï¼ˆ`?redirect-url=/account/settings`å½¢å¼ï¼‰

**å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
- ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã€ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç…§ä¼šï¼‰
3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ï¼ˆãƒãƒƒã‚·ãƒ¥æ¯”è¼ƒï¼‰
4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆcommonã®ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ä½¿ç”¨ï¼‰
5. Cookieè¨­å®šã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆæŒ‡å®šURLã¾ãŸã¯`/account`ã¸ï¼‰

**å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿**:

- æˆåŠŸæ™‚: ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã‚’ç™ºè¡Œã—ã€æŒ‡å®šURLã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- èªè¨¼å¤±æ•—: ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€
  - **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡**: ã©ã¡ã‚‰ãŒé–“é•ã£ã¦ã„ã‚‹ã‹ç‰¹å®šã•ã›ãªã„ï¼ˆåˆ—æŒ™æ”»æ’ƒå¯¾ç­–ï¼‰
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ï¼ˆå°†æ¥å®Ÿè£…ï¼‰: ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ã¾ã™ã€

#### 3. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ (Logout)

**URL**: `/logout`ï¼ˆactionã®ã¿ã€ç”»é¢ãªã—ï¼‰

**æ©Ÿèƒ½**:

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ç ´æ£„ã¨ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
- Cookieç„¡åŠ¹åŒ–

**å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:

- ãªã—ï¼ˆç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã‚’ä½¿ç”¨ï¼‰

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå–å¾—ï¼ˆCookieï¼‰
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆCloudflare Workers KVï¼‰
3. Cookieç„¡åŠ¹åŒ–ï¼ˆ`Max-Age=0`è¨­å®šï¼‰
4. `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿**:

- Cookieå‰Šé™¤ãƒ˜ãƒƒãƒ€ãƒ¼
- `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

#### 4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ (Forgot Password)

**URL**: `/forgot-password`

**æ©Ÿèƒ½**:

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”¨ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç”Ÿæˆã—ã€ãƒ¡ãƒ¼ãƒ«ã§é€ä¿¡
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸéš›ã®æ•‘æ¸ˆæ‰‹æ®µ

**å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼‰
2. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç…§ä¼šï¼‰
3. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ã®ç”Ÿæˆï¼ˆUUIDï¼‰
4. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’KVã«ä¿å­˜ï¼ˆTTL: 1æ™‚é–“ï¼‰
5. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆãƒˆãƒ¼ã‚¯ãƒ³ä»˜ããƒªãƒ³ã‚¯ï¼‰
6. æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

**å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿**:

- æˆåŠŸæ™‚: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚ãƒ¡ãƒ¼ãƒ«ã‚’ã”ç¢ºèªãã ã•ã„ã€‚ã€
- å¤±æ•—æ™‚: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚ã€

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªç™»éŒ²: **æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º**ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åŸå‰‡: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ã‚’å¤–éƒ¨ã«æ¼ã‚‰ã•ãªã„ï¼‰
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶**:

- ãƒˆãƒ¼ã‚¯ãƒ³ã¯1å›é™ã‚Šæœ‰åŠ¹ï¼ˆä½¿ç”¨å¾Œã«å‰Šé™¤ï¼‰
- ãƒˆãƒ¼ã‚¯ãƒ³ã®TTLã¯1æ™‚é–“
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­˜åœ¨ç¢ºèªã‚’ã•ã›ãªã„ï¼ˆå­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã‚‚æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿”ã™ï¼‰

#### 5. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œ (Reset Password)

**URL**: `/reset-password/:token`

**æ©Ÿèƒ½**:

- ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã€æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‹ã‚‰é·ç§»

**å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:

- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª
- ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆKVã‹ã‚‰å–å¾—ã€æœŸé™ãƒã‚§ãƒƒã‚¯ï¼‰
2. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯ï¼‰
3. æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–
4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ï¼ˆD1 Databaseï¼‰
5. ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼ˆKVï¼‰
6. ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼‰
7. æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º + `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿**:

- æˆåŠŸæ™‚: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚ã€+ `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ãŒç„¡åŠ¹ã§ã™ã€‚ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚ã€
- ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚ã€
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒä¸€è‡´ã—ã¾ã›ã‚“ã€
- å¼±ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤§æ–‡å­—ã€å°æ–‡å­—ã€æ•°å­—ã‚’å«ã‚€å¿…è¦ãŒã‚ã‚Šã¾ã™ã€

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶**:

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå¾Œã€ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
- ãƒˆãƒ¼ã‚¯ãƒ³ã¯1å›é™ã‚Šæœ‰åŠ¹ï¼ˆä½¿ç”¨å¾Œã«å‰Šé™¤ï¼‰
- ãƒˆãƒ¼ã‚¯ãƒ³ã®TTLã¯1æ™‚é–“

#### 6. OTPã‚³ãƒ¼ãƒ‰é€ä¿¡ (Send OTP)

**URL**: `/login` (actionã€intent: `send-otp`)

**æ©Ÿèƒ½**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å—ã‘å–ã‚Šã€6æ¡OTPã‚’ç”Ÿæˆã—ã¦Resend APIçµŒç”±ã§é€ä¿¡
- OTPã‚’KVã«JSONå½¢å¼ã§ä¿å­˜ï¼ˆTTL: 10åˆ†ï¼‰

**å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ¡ãƒ¼ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼‰
2. ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ï¼ˆKVã€ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å˜ä½ã€5åˆ†é–“ã«3å›ã¾ã§ï¼‰
3. OTPã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆ`generateOtp()` â€” libå±¤ï¼‰
4. KVã«OTPãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆJSON: `{ code, email, attempts: 0 }`ã€TTL: 10åˆ†ï¼‰
5. Resend APIã§OTPãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆ`sendAuthEmail.server.ts` â€” data-ioå±¤ï¼‰
6. `/auth/otp?email=xxx` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿**:

- æˆåŠŸæ™‚: `/auth/otp?email=xxx` ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…éæ™‚: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€Œã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- ãƒ¬ãƒ¼ãƒˆåˆ¶é™è¶…é: ã€Œèªè¨¼ã‚³ãƒ¼ãƒ‰ã®é€ä¿¡å›æ•°ãŒä¸Šé™ã«é”ã—ã¾ã—ãŸã€‚ã—ã°ã‚‰ãæ™‚é–“ã‚’ãŠã„ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€
- ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: ã€Œèªè¨¼ã‚³ãƒ¼ãƒ‰ã®é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶**:

- ãƒ¦ãƒ¼ã‚¶ãƒ¼æœªç™»éŒ²ã§ã‚‚åŒä¸€ç”»é¢é·ç§»ã‚’è¡Œã†ï¼ˆåˆ—æŒ™æ”»æ’ƒå¯¾ç­–ï¼‰
- ãƒ¬ãƒ¼ãƒˆåˆ¶é™: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å˜ä½ã€5åˆ†é–“ã«3å›ã¾ã§

#### 7. OTPæ¤œè¨¼ãƒ»ãƒ­ã‚°ã‚¤ãƒ³ (Verify OTP)

**URL**: `/auth/otp`ï¼ˆæ–°è¦ãƒ«ãƒ¼ãƒˆï¼‰

**æ©Ÿèƒ½**:

- 6æ¡ã‚³ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ã—ã€æˆåŠŸæ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç™ºè¡Œ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°æ–°è¦ä½œæˆï¼ˆåå¯„ã›: OAuthæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ç´ä»˜ã‘ï¼‰

**å…¥åŠ›ãƒ‡ãƒ¼ã‚¿**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆhiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
- 6æ¡OTPã‚³ãƒ¼ãƒ‰

**loaderå‡¦ç†**:

- emailãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœªæŒ‡å®šã®å ´åˆ: `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹å¯¾ç­–ï¼‰
- KVã«OTPãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆ: `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:

1. OTPã‚³ãƒ¼ãƒ‰å½¢å¼ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ6æ¡æ•°å­—ãƒã‚§ãƒƒã‚¯ï¼‰
2. KVã‹ã‚‰OTPãƒ‡ãƒ¼ã‚¿å–å¾—
3. ã‚³ãƒ¼ãƒ‰ç…§åˆ
4. å¤±æ•—æ™‚: attempts+1ã§KVæ›´æ–°ã€‚3å›å¤±æ•—ã§KVã‹ã‚‰ã‚­ãƒ¼å‰Šé™¤ï¼ˆãƒ–ãƒ«ãƒ¼ãƒˆãƒ•ã‚©ãƒ¼ã‚¹å¯¾ç­–ï¼‰
5. æˆåŠŸæ™‚: KVã‹ã‚‰OTPãƒ‡ãƒ¼ã‚¿å‰Šé™¤
6. ãƒ¦ãƒ¼ã‚¶ãƒ¼upsertï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ä»˜ã‘ or æ–°è¦ä½œæˆ â€” `upsertUserByEmail.server.ts`ï¼‰
7. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆï¼ˆ`createSessionData` â€” lib/commonï¼‰
8. ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜ï¼ˆ`saveSession.server` â€” data-io/commonï¼‰
9. Cookieè¨­å®šã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆ`/account`ã¸ï¼‰

**å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿**:

- æˆåŠŸæ™‚: ã‚»ãƒƒã‚·ãƒ§ãƒ³Cookieã‚’ç™ºè¡Œã—ã€`/account`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- ã‚³ãƒ¼ãƒ‰ä¸ä¸€è‡´: ã€Œèªè¨¼ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€
- æœŸé™åˆ‡ã‚Œ: ã€Œèªè¨¼ã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€
- è©¦è¡Œå›æ•°è¶…é: ã€Œèªè¨¼ã‚³ãƒ¼ãƒ‰ãŒç„¡åŠ¹ã«ãªã‚Šã¾ã—ãŸã€‚ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶**:

- OTPã‚³ãƒ¼ãƒ‰ã¯1å›é™ã‚Šæœ‰åŠ¹ï¼ˆæ¤œè¨¼æˆåŠŸå¾Œã«KVã‹ã‚‰å³æ™‚å‰Šé™¤ï¼‰
- è©¦è¡Œå›æ•°åˆ¶é™: æœ€å¤§3å›ã€‚è¶…éã§KVã‹ã‚‰ã‚­ãƒ¼å‰Šé™¤
- æœ‰åŠ¹æœŸé™: 10åˆ†ï¼ˆKV TTLï¼‰

## ğŸ“‚ app/componentsè¦ä»¶

### UI Components

#### 1. RegisterForm

**é…ç½®**: `app/components/account/authentication/RegisterForm.tsx`

**è²¬å‹™**:

- ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤º
- é€ä¿¡å‡¦ç†

**ä¸»è¦ãªUIè¦ç´ **:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ï¼ˆFormFieldä½¿ç”¨ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆFormFieldä½¿ç”¨ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªå…¥åŠ›ï¼ˆFormFieldä½¿ç”¨ï¼‰
- ç™»éŒ²ãƒœã‚¿ãƒ³ï¼ˆButtonä½¿ç”¨ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆErrorMessageä½¿ç”¨ï¼‰
- ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ï¼ˆæ—¢å­˜ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚‹å ´åˆï¼‰

**çŠ¶æ…‹ç®¡ç†**:

- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ä¸­ãƒ•ãƒ©ã‚°ï¼ˆãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹åˆ¶å¾¡ï¼‰
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

#### 2. LoginForm

**é…ç½®**: `app/components/account/authentication/LoginForm.tsx`

**è²¬å‹™**:

- ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤º
- é€ä¿¡å‡¦ç†

**ä¸»è¦ãªUIè¦ç´ **:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ï¼ˆFormFieldä½¿ç”¨ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆFormFieldä½¿ç”¨ï¼‰
- ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ï¼ˆButtonä½¿ç”¨ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆErrorMessageä½¿ç”¨ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒªãƒ³ã‚¯ï¼ˆ`/forgot-password`ã¸ã®ãƒªãƒ³ã‚¯ï¼‰
- ä¼šå“¡ç™»éŒ²ãƒªãƒ³ã‚¯

**çŠ¶æ…‹ç®¡ç†**:

- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ä¸­ãƒ•ãƒ©ã‚°
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

#### 3. ForgotPasswordForm

**é…ç½®**: `app/components/account/authentication/ForgotPasswordForm.tsx`

**è²¬å‹™**:

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›
- é€ä¿¡å‡¦ç†

**ä¸»è¦ãªUIè¦ç´ **:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›ï¼ˆFormFieldä½¿ç”¨ï¼‰
- é€ä¿¡ãƒœã‚¿ãƒ³ï¼ˆButtonä½¿ç”¨ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆErrorMessageä½¿ç”¨ï¼‰
- ãƒ­ã‚°ã‚¤ãƒ³ãƒªãƒ³ã‚¯ï¼ˆæˆ»ã‚‹ï¼‰

**çŠ¶æ…‹ç®¡ç†**:

- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ä¸­ãƒ•ãƒ©ã‚°
- æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†æ™‚ï¼‰

#### 4. ResetPasswordForm

**é…ç½®**: `app/components/account/authentication/ResetPasswordForm.tsx`

**è²¬å‹™**:

- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤º
- é€ä¿¡å‡¦ç†

**ä¸»è¦ãªUIè¦ç´ **:

- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆFormFieldä½¿ç”¨ï¼‰
- æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèªå…¥åŠ›ï¼ˆFormFieldä½¿ç”¨ï¼‰
- ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆButtonä½¿ç”¨ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆErrorMessageä½¿ç”¨ï¼‰

**çŠ¶æ…‹ç®¡ç†**:

- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ä¸­ãƒ•ãƒ©ã‚°
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

### Routes

#### 1. register.tsx

**é…ç½®**: `app/routes/register.tsx`

**è²¬å‹™**:

- ä¼šå“¡ç™»éŒ²ãƒšãƒ¼ã‚¸ã®Routeå®šç¾©
- loader: æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯`/account`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- action: ä¼šå“¡ç™»éŒ²å‡¦ç†ã®å®Ÿè¡Œ

**loaderå‡¦ç†**:

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
- èªè¨¼æ¸ˆã¿ãªã‚‰`/account`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- æœªèªè¨¼ãªã‚‰nullè¿”å´ï¼ˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼‰

**actionå‡¦ç†**:

1. FormDataã‹ã‚‰å…¥åŠ›å€¤å–å¾—
2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ãƒã‚§ãƒƒã‚¯
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
5. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
6. Cookieè¨­å®šã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

#### 2. login.tsx

**é…ç½®**: `app/routes/login.tsx`

**è²¬å‹™**:

- ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®Routeå®šç¾©
- loader: æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯`/account`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- action: ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã®å®Ÿè¡Œ

**loaderå‡¦ç†**:

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
- èªè¨¼æ¸ˆã¿ãªã‚‰`/account`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- æœªèªè¨¼ãªã‚‰nullè¿”å´ï¼ˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼‰

**actionå‡¦ç†**:

1. FormDataã‹ã‚‰å…¥åŠ›å€¤å–å¾—
2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
3. èªè¨¼å‡¦ç†ï¼ˆãƒ¡ãƒ¼ãƒ«/ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼ï¼‰
4. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
5. Cookieè¨­å®šã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆredirect-urlãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å„ªå…ˆï¼‰

#### 3. logout.tsx

**é…ç½®**: `app/routes/logout.tsx`

**è²¬å‹™**:

- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†å°‚ç”¨Routeï¼ˆç”»é¢ãªã—ï¼‰
- action: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç ´æ£„ã¨ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**actionå‡¦ç†**:

1. ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå–å¾—
2. ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆKVï¼‰
3. Cookieç„¡åŠ¹åŒ–
4. `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

#### 4. forgot-password.tsx

**é…ç½®**: `app/routes/forgot-password.tsx`

**è²¬å‹™**:

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆè¦æ±‚ãƒšãƒ¼ã‚¸ã®Routeå®šç¾©
- loader: æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆã¯`/account`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- action: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡å‡¦ç†

**loaderå‡¦ç†**:

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèª
- èªè¨¼æ¸ˆã¿ãªã‚‰`/account`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- æœªèªè¨¼ãªã‚‰nullè¿”å´ï¼ˆãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤ºï¼‰

**actionå‡¦ç†**:

1. FormDataã‹ã‚‰å…¥åŠ›å€¤å–å¾—ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç…§ä¼šï¼‰
4. ãƒªã‚»ãƒƒãƒˆãƒˆãƒ¼ã‚¯ãƒ³ç”Ÿæˆï¼ˆUUIDï¼‰
5. ãƒˆãƒ¼ã‚¯ãƒ³ã‚’KVã«ä¿å­˜ï¼ˆTTL: 1æ™‚é–“ã€key: `password-reset:${token}`, value: `${userId}`ï¼‰
6. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆ`/reset-password/${token}`ã¸ã®ãƒªãƒ³ã‚¯ï¼‰
7. æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**:

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã‚‚æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆåˆ—æŒ™æ”»æ’ƒå¯¾ç­–ï¼‰

#### 5. reset-password.$token.tsx

**é…ç½®**: `app/routes/reset-password.$token.tsx`

**è²¬å‹™**:

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå®Ÿè¡Œãƒšãƒ¼ã‚¸ã®Routeå®šç¾©
- loader: ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
- action: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°å‡¦ç†

**loaderå‡¦ç†**:

1. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—
2. ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ï¼ˆKVã‹ã‚‰å–å¾—ï¼‰
3. ãƒˆãƒ¼ã‚¯ãƒ³ç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œã®å ´åˆã€ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
4. æœ‰åŠ¹ãªå ´åˆã€ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º

**actionå‡¦ç†**:

1. FormDataã‹ã‚‰å…¥åŠ›å€¤å–å¾—ï¼ˆæ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ç¢ºèªï¼‰
2. ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
3. ãƒˆãƒ¼ã‚¯ãƒ³å†æ¤œè¨¼ï¼ˆäºŒé‡ãƒã‚§ãƒƒã‚¯ï¼‰
4. ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ï¼ˆKVã®ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ï¼‰
5. æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–
6. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ›´æ–°ï¼ˆD1 Databaseï¼‰
7. ãƒˆãƒ¼ã‚¯ãƒ³å‰Šé™¤ï¼ˆKVï¼‰
8. ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ï¼‰
9. æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º + `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

**ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**:

- ãƒˆãƒ¼ã‚¯ãƒ³ã¯1å›é™ã‚Šæœ‰åŠ¹ï¼ˆä½¿ç”¨å¾Œã«å‰Šé™¤ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆå¾Œã€ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç ´æ£„

## ğŸ§  ç´”ç²‹ãƒ­ã‚¸ãƒƒã‚¯è¦ä»¶

### libå±¤ã®é–¢æ•°

#### 1. hashPassword

**é…ç½®**: `app/lib/account/authentication/hashPassword.ts`

**è²¬å‹™**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥åŒ–

**å…¥åŠ›**: å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆstringï¼‰

**å‡¦ç†**: bcryptã‚’ä½¿ç”¨ã—ã¦ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆsalt rounds: 10ï¼‰

**å‡ºåŠ›**: ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆstringï¼‰

#### 2. verifyPassword

**é…ç½®**: `app/lib/account/authentication/verifyPassword.ts`

**è²¬å‹™**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®æ¤œè¨¼

**å…¥åŠ›**:

- å¹³æ–‡ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆstringï¼‰
- ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆstringï¼‰

**å‡¦ç†**: bcrypt.compareã‚’ä½¿ç”¨ã—ã¦æ¯”è¼ƒ

**å‡ºåŠ›**: booleanï¼ˆä¸€è‡´/ä¸ä¸€è‡´ï¼‰

#### 3. validateRegistration

**é…ç½®**: `app/lib/account/authentication/validateRegistration.ts`

**è²¬å‹™**: ä¼šå“¡ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

**å…¥åŠ›**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ç¢ºèª

**å‡¦ç†**:

- ãƒ¡ãƒ¼ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯ï¼ˆæ­£è¦è¡¨ç¾ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åº¦ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å°é•·ã€å¤§æ–‡å­—å°æ–‡å­—æ•°å­—å«ã‚€ï¼‰
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ãƒã‚§ãƒƒã‚¯
- å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯

**å‡ºåŠ›**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®é…åˆ—ï¼ˆã‚¨ãƒ©ãƒ¼ãŒãªã„å ´åˆã¯ç©ºé…åˆ—ï¼‰

#### 4. validateLogin

**é…ç½®**: `app/lib/account/authentication/validateLogin.ts`

**è²¬å‹™**: ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

**å…¥åŠ›**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

**å‡¦ç†**:

- ãƒ¡ãƒ¼ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
- å¿…é ˆé …ç›®ãƒã‚§ãƒƒã‚¯

**å‡ºåŠ›**: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®é…åˆ—

### 3.3 OTPèªè¨¼

#### 5. generateOtp

**é…ç½®**: `app/lib/account/authentication/generateAuthToken.ts`ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

**è²¬å‹™**: 6æ¡æ•°å­—OTPã‚³ãƒ¼ãƒ‰ã®ç”Ÿæˆ

**å…¥åŠ›**: ãªã—

**å‡¦ç†**: `crypto.getRandomValues` ã‚’ä½¿ç”¨ã—ã¦ã‚»ã‚­ãƒ¥ã‚¢ãª6æ¡æ•°å­—ã‚’ç”Ÿæˆ

**å‡ºåŠ›**: 6æ¡æ•°å­—æ–‡å­—åˆ—ï¼ˆä¾‹: "042871"ï¼‰

#### 6. validateOtpFormat

**é…ç½®**: `app/lib/account/authentication/validateOtpFormat.ts`

**è²¬å‹™**: OTPã‚³ãƒ¼ãƒ‰ã®å½¢å¼ãƒã‚§ãƒƒã‚¯

**å…¥åŠ›**: OTPã‚³ãƒ¼ãƒ‰æ–‡å­—åˆ—

**å‡¦ç†**: 6æ¡æ•°å­—ï¼ˆ`/^\d{6}$/`ï¼‰ã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼

**å‡ºåŠ›**: booleanï¼ˆæœ‰åŠ¹/ç„¡åŠ¹ï¼‰

#### 5. OtpVerifyForm

**é…ç½®**: `app/components/account/authentication/OtpVerifyForm.tsx`

**è²¬å‹™**:

- OTPã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤º
- 6æ¡ã‚³ãƒ¼ãƒ‰å…¥åŠ›ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤º
- é€ä¿¡å‡¦ç†ã€å†é€ä¿¡ãƒªãƒ³ã‚¯

**ä¸»è¦ãªUIè¦ç´ **:

- OTPã‚³ãƒ¼ãƒ‰å…¥åŠ›ï¼ˆ6æ¡ã€inputmode: numericï¼‰
- èªè¨¼ãƒœã‚¿ãƒ³ï¼ˆButtonä½¿ç”¨ï¼‰
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆErrorMessageä½¿ç”¨ï¼‰
- ã€Œã‚³ãƒ¼ãƒ‰ã‚’å†é€ä¿¡ã€ãƒªãƒ³ã‚¯
- ã€Œãƒ­ã‚°ã‚¤ãƒ³ã«æˆ»ã‚‹ã€ãƒªãƒ³ã‚¯

**çŠ¶æ…‹ç®¡ç†**:

- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ä¸­ãƒ•ãƒ©ã‚°ï¼ˆãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹åˆ¶å¾¡ï¼‰
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

#### 6. auth.otp.tsx

**é…ç½®**: `app/routes/auth.otp.tsx`

**è²¬å‹™**:

- OTPã‚³ãƒ¼ãƒ‰å…¥åŠ›ãƒšãƒ¼ã‚¸ã®Routeå®šç¾©
- loader: emailãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ»KVãƒ‡ãƒ¼ã‚¿å­˜åœ¨ãƒã‚§ãƒƒã‚¯ï¼ˆé˜²è¡›ï¼‰
- action: OTPã‚³ãƒ¼ãƒ‰æ¤œè¨¼ãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ç™ºè¡Œå‡¦ç†

**loaderå‡¦ç†**:

- emailã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æœªæŒ‡å®šæ™‚: `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- KVã«OTPãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆ: `/login`ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- æœ‰åŠ¹ãªå ´åˆ: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«æ¸¡ã™

**actionå‡¦ç†**:

1. FormDataã‹ã‚‰å…¥åŠ›å€¤å–å¾—ï¼ˆemail, otpCodeï¼‰
2. OTPã‚³ãƒ¼ãƒ‰å½¢å¼ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ6æ¡æ•°å­—ï¼‰
3. KVã‹ã‚‰OTPãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ã‚³ãƒ¼ãƒ‰ç…§åˆ
4. å¤±æ•—æ™‚: attemptsæ›´æ–°ã€3å›è¶…éã§KVå‰Šé™¤
5. æˆåŠŸæ™‚: KVã‹ã‚‰OTPãƒ‡ãƒ¼ã‚¿å‰Šé™¤
6. ãƒ¦ãƒ¼ã‚¶ãƒ¼upsertï¼ˆåå¯„ã›ï¼‰
7. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆãƒ»ä¿å­˜
8. Cookieè¨­å®šã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

## ğŸ”Œ å‰¯ä½œç”¨è¦ä»¶

### data-ioå±¤ã®é–¢æ•°

#### 1. createUser.server.ts

**é…ç½®**: `app/data-io/account/authentication/createUser.server.ts`

**è²¬å‹™**: æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®DBç™»éŒ²

**å…¥åŠ›**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰

**å‡¦ç†**:

1. D1 Databaseã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¬ã‚³ãƒ¼ãƒ‰æŒ¿å…¥
2. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤è¨­å®šï¼ˆsubscriptionStatus: 'inactive', createdAt, updatedAtï¼‰

**å‡ºåŠ›**: ä½œæˆã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆUserå‹ï¼‰

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**:

- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡æ™‚: UNIQUEåˆ¶ç´„ã‚¨ãƒ©ãƒ¼ã‚’ã‚­ãƒ£ãƒƒãƒ

#### 2. findUserByEmail.server.ts

**é…ç½®**: `app/data-io/account/authentication/findUserByEmail.server.ts`

**è²¬å‹™**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢

**å…¥åŠ›**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

**å‡¦ç†**: D1 Databaseã§SELECTæ–‡å®Ÿè¡Œ

**å‡ºåŠ›**: ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆUserå‹ï¼‰ã¾ãŸã¯null

#### 3. checkEmailExists.server.ts

**é…ç½®**: `app/data-io/account/authentication/checkEmailExists.server.ts`

**è²¬å‹™**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®å­˜åœ¨ç¢ºèª

**å…¥åŠ›**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹

**å‡¦ç†**: D1 Databaseã§COUNTæ–‡å®Ÿè¡Œ

**å‡ºåŠ›**: booleanï¼ˆå­˜åœ¨ã™ã‚‹/ã—ãªã„ï¼‰

### 4.3 OTPèªè¨¼

| ãƒ•ã‚¡ã‚¤ãƒ«å | ãƒ‘ã‚¹ | è²¬å‹™ |
| :--- | :--- | :--- |
| sendAuthEmail.server.ts | app/data-io/account/authentication/sendAuthEmail.server.ts | Resend APIçµŒç”±ã®OTPãƒ¡ãƒ¼ãƒ«é€ä¿¡ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰ |
| saveOtpToken.server.ts | app/data-io/account/authentication/saveOtpToken.server.ts | KVã«OTPãƒ‡ãƒ¼ã‚¿ã‚’JSONä¿å­˜ï¼ˆTTL: 10åˆ†ï¼‰ |
| verifyOtpToken.server.ts | app/data-io/account/authentication/verifyOtpToken.server.ts | KVã‹ã‚‰OTPãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ç…§åˆãƒ»attemptsæ›´æ–° |
| upsertUserByEmail.server.ts | app/data-io/account/authentication/upsertUserByEmail.server.ts | ãƒ¡ãƒ¼ãƒ«ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢ã€å­˜åœ¨ã™ã‚Œã°è¿”å´ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆï¼ˆåå¯„ã›ï¼‰ |
| checkOtpRateLimit.server.ts | app/data-io/account/authentication/checkOtpRateLimit.server.ts | KVã§ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å˜ä½ã®ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯ |

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### ä¼šå“¡ç™»éŒ²ãƒ•ãƒ­ãƒ¼

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
    â†“
RegisterForm (UI)
    â†“
register.tsx action
    â†“
validateRegistration (lib) - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    â†“
checkEmailExists.server (data-io) - é‡è¤‡ãƒã‚§ãƒƒã‚¯
    â†“
hashPassword (lib) - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–
    â†“
createUser.server (data-io) - DBç™»éŒ²
    â†“
createSessionData (lib/common) - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
    â†“
saveSession.server (data-io/common) - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜
    â†“
Cookieè¨­å®š + /account ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
    â†“
LoginForm (UI)
    â†“
login.tsx action
    â†“
validateLogin (lib) - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    â†“
findUserByEmail.server (data-io) - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
    â†“
verifyPassword (lib) - ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰æ¤œè¨¼
    â†“
createSessionData (lib/common) - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
    â†“
saveSession.server (data-io/common) - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜
    â†“
Cookieè¨­å®š + ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒ•ãƒ­ãƒ¼

ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    â†“
logout.tsx action
    â†“
getSession.server (data-io/common) - ã‚»ãƒƒã‚·ãƒ§ãƒ³IDå–å¾—
    â†“
destroySession.server (data-io/common) - ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
    â†“
Cookieç„¡åŠ¹åŒ– + /login ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### OTPãƒ¡ãƒ¼ãƒ«èªè¨¼ãƒ•ãƒ­ãƒ¼

ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼‰
    â†“
login.tsx action (intent: send-otp)
    â†“
checkOtpRateLimit.server (data-io) - ãƒ¬ãƒ¼ãƒˆåˆ¶é™ãƒã‚§ãƒƒã‚¯
    â†“
generateOtp (lib) - 6æ¡OTPç”Ÿæˆ
    â†“
saveOtpToken.server (data-io) - KVä¿å­˜ï¼ˆJSON, TTL: 10åˆ†ï¼‰
    â†“
sendAuthEmail.server (data-io) - Resend APIã§ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    â†“
/auth/otp?email=xxx ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    â†“
ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆ6æ¡OTPã‚³ãƒ¼ãƒ‰ï¼‰
    â†“
auth.otp.tsx action
    â†“
verifyOtpToken.server (data-io) - KVã‹ã‚‰OTPãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»ç…§åˆ
    â†“
upsertUserByEmail.server (data-io) - ãƒ¦ãƒ¼ã‚¶ãƒ¼upsertï¼ˆåå¯„ã›ï¼‰
    â†“
createSessionData (lib/common) - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
    â†“
saveSession.server (data-io/common) - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜
    â†“
Cookieè¨­å®š + /account ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶

### 1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- **ãƒãƒƒã‚·ãƒ¥åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **: bcryptï¼ˆ`common-spec.yaml`ã§å®šç¾©ï¼‰
- **Salt Rounds**: 10
- **å¹³æ–‡ä¿å­˜ç¦æ­¢**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¿…ãšãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‹ã‚‰ä¿å­˜

### 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

- **Cookieè¨­å®š**:
  - HttpOnly: trueï¼ˆJavaScriptã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯ï¼‰
  - Secure: trueï¼ˆHTTPSå¿…é ˆï¼‰
  - SameSite: Laxï¼ˆCSRFå¯¾ç­–ï¼‰
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³æœŸé™**: 7æ—¥é–“ï¼ˆ`common-spec.yaml`ã§å®šç¾©ï¼‰

### 3. èªè¨¼ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

- **åŸå‰‡**: å…·ä½“çš„ãªå¤±æ•—ç†ç”±ã‚’é–‹ç¤ºã—ãªã„
- **NG**: ã€Œãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã¾ã™ã€ã€Œã“ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€
- **OK**: ã€Œãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¾ãŸã¯ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“ã€

### 4. CSRFå¯¾ç­–ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

- CSRFãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼ï¼ˆ`common-spec.yaml`ã®`security.csrf`è¨­å®šã«å¾“ã†ï¼‰

## ğŸ§ª ãƒ†ã‚¹ãƒˆè¦ä»¶

### E2Eãƒ†ã‚¹ãƒˆ

**é…ç½®**: `tests/e2e/section/account/authentication.spec.ts`

**ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹**:

- ä¼šå“¡ç™»éŒ²ã®æˆåŠŸã‚·ãƒŠãƒªã‚ª
- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡æ™‚ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
- ãƒ­ã‚°ã‚¤ãƒ³ã®æˆåŠŸã‚·ãƒŠãƒªã‚ª
- èªè¨¼å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã®æˆåŠŸã‚·ãƒŠãƒªã‚ª

### å˜ä½“ãƒ†ã‚¹ãƒˆ

å„é–¢æ•°ã”ã¨ã«ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆï¼š

- `hashPassword.test.ts`
- `verifyPassword.test.ts`
- `validateRegistration.test.ts`
- `validateLogin.test.ts`
- `createUser.server.test.ts`ï¼ˆDBãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰
- `findUserByEmail.server.test.ts`ï¼ˆDBãƒ¢ãƒƒã‚¯ä½¿ç”¨ï¼‰

## ğŸš€ å®Ÿè£…ã®å„ªå…ˆé †ä½

**Phase 1**: åŸºæœ¬èªè¨¼æ©Ÿèƒ½

1. ä¼šå“¡ç™»éŒ²ï¼ˆregister.tsx, RegisterFormï¼‰
2. ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆlogin.tsx, LoginFormï¼‰
3. ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆlogout.tsxï¼‰

**Phase 2**: ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆæ©Ÿèƒ½ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
- OTPãƒ¡ãƒ¼ãƒ«èªè¨¼ï¼ˆResend APIã€KVãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã€åå¯„ã›ï¼‰
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ­ãƒƒã‚¯ï¼ˆãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œå›æ•°åˆ¶é™ï¼‰ï¼ˆå°†æ¥å®Ÿè£…ï¼‰

**Phase 3**: OAuthé€£æºï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

- Google OAuthï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
- èªè¨¼å¾Œã®å…ƒç”»é¢å¾©å¸°: `redirect-url` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ `oauth_redirect` Cookie çµŒç”±ã§ OAuth ãƒ•ãƒ­ãƒ¼ã«ä¼æ¬ã—ã€èªè¨¼å®Œäº†å¾Œã«å…ƒç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `/account`ï¼‰

## ğŸ“ å‚™è€ƒ

### ä¾å­˜é–¢ä¿‚

- **commonã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸ã®ä¾å­˜**:
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ï¼ˆcreateSessionData, saveSession.server, destroySession.server, deleteAllUserSessions.serverï¼‰
  - å…±é€šUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆFormField, Button, ErrorMessageï¼‰
  - spec.yamlã®è¨­å®šå€¤ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®šã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ï¼‰

### å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª

- **bcrypt**: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆ`npm install bcrypt`ã€å‹å®šç¾©: `@types/bcrypt`ï¼‰

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒï¼ˆD1ï¼‰

**usersãƒ†ãƒ¼ãƒ–ãƒ«**:

| ã‚«ãƒ©ãƒ å | å‹ | åˆ¶ç´„ | èª¬æ˜ |
| :--- | :--- | :--- | :--- |
| id | TEXT | PRIMARY KEY | ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆUUIDï¼‰ |
| email | TEXT | UNIQUE, NOT NULL | ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ |
| password | TEXT | NOT NULL | ãƒãƒƒã‚·ãƒ¥åŒ–ã•ã‚ŒãŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ |
| subscriptionStatus | TEXT | NOT NULL | 'active', 'inactive', 'trial' |
| createdAt | TEXT | NOT NULL | ä½œæˆæ—¥æ™‚ï¼ˆISO 8601ï¼‰ |
| updatedAt | TEXT | NOT NULL | æ›´æ–°æ—¥æ™‚ï¼ˆISO 8601ï¼‰ |

> **æ³¨**: å…·ä½“çš„ãªå‹å®šç¾©ã¯ `app/specs/account/types.ts` ã§å®šç¾©ã—ã¾ã™ã€‚

---

**æœ€çµ‚æ›´æ–°**: 2025-12-23
