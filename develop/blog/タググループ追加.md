# 【機能修正提案】ブログフィルタパネルのタググループ化によるUX向上

- **サービス**: `blog`
- **セクション**: `posts`
- **関連ドキュメント**:
  - `develop/blog/posts/spec.yaml`
  - `develop/blog/posts/uiux-spec.md`
  - `app/components/blog/posts/FilterPanel.tsx`

---

## 1. 提案概要

ブログ記事一覧のフィルタパネルにおいて、タグを主要技術グループ（Remix, Cloudflare, Claude Code）ごとに整理して表示し、サイト訪問者がブログの技術的な全体像を把握しやすくすることで、UXとコンテンツの発見性を向上させます。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- **UIの問題**: フィルタパネルのタグが、グループ分けされずに一列にごちゃ混ぜで表示されています。これにより、どのタグがどの技術領域に属するのかが分かりにくくなっています。
- **データ構造の問題**: `spec.yaml`では、タグのグループがコメントでしか表現されておらず、プログラムからUIを構造的に構築することができません。

```yaml
# spec.yaml の現状
tags:
  current:
    # Remix関連  <- コメントのためプログラムから解釈不可
    - name: "SSR"
      category: "technical"
    # ...
```

### 修正後 (To-Be)

- **UIの改善**: フィルタパネル内で、タグが「Remix」「Cloudflare」「Claude Code」「その他」のグループに分かれて表示されます。これにより、訪問者はこのブログがどの技術領域をカバーしているかを一目で理解できます。

**UI構想図:**
app\styles\blog\ワイヤーフレーム (1).jpg

```
[カテゴリーセレクタ]

[Remix]
[SSR][Vite][Vitest]...

[Cloudflare]
[Workers][Pages][KV][D1]...

[Claude Code]
[MCP][Skills][Prompts]...

[その他]
[troubleshooting][refactoring]...

[フィルタ適用ボタン]
```

- **データ構造の改善**: `spec.yaml`の各タグ定義に`group`プロパティを追加し、所属グループを明示的に管理します。これにより、UIは`spec.yaml`のデータに基づいて動的にグループ表示を構築できます。

```yaml
# spec.yaml の修正後
tags:
  current:
    - name: "SSR"
      category: "technical"
      group: "Remix" # <- groupプロパティを追加
      description: "Server-Side Rendering"
    # ...
```

## 3. 背景・目的

### 背景
現在のフィルタパネルでは、タグがアルファベット順などで無秩序に並んでおり、ユーザーが目的の技術を探しにくい状態です。また、このブログが持つ技術的な強みやカバー範囲（Remix, Cloudflare, Claude Code）が、UIから直感的に伝わりません。

### 目的
- **目的1: UXの向上**: タグを論理的なグループに分類することで、ユーザーの認知負荷を下げ、目的の技術タグを発見しやすくします。
- **目的2: 技術ブランディングの強化**: フィルタパネルを「技術マップ」として機能させ、このブログがどの技術領域に強みを持つかを視覚的にアピールします。
- **目的3: 保守性の向上**: タグのグループ情報を`spec.yaml`で一元管理し、UIの表示ロジックをデータ駆動にすることで、将来的なグループ変更や追加を容易にします。

## 4. 変更の妥当性 (Pros / Cons)

`@ArchitectureGuardian` の視点に基づき、この変更がプロジェクトの設計思想に合致するかを評価します。

**👍 Pros (利点)**
- **SSoTの強化**: UIの表示構造（タグのグループ分け）を`spec.yaml`という単一の情報源で制御でき、設計思想に合致します。
- **ユーザー体験の向上**: 目的のタグを探しやすくなり、ブログのコンテンツ全体像も把握しやすくなります。
- **コンポーネントの責務分離**: `FilterPanel`は`group`プロパティに従って表示するだけでよく、UIコンポーネントが「どのタグがどのグループか」という知識を持つ必要がなくなります。

**👎 Cons (懸念点)**
- **UI実装の変更**: `FilterPanel`コンポーネントがタグをグループ化してレンダリングするよう、ロジックの修正が必要になります。

**総合評価**:
ConsはUI実装の範囲内に収まり、限定的です。一方で、SSoTの原則を強化し、UXを大幅に向上させるという点で、この変更は**非常に妥当性が高い**と判断します。

## 5 設計フロー
以下の設計ドキュメントを上から順に確認し、編集内容を追記して。
「TAG_CATEGORY_SPEC.md（削除予定）」も移植して。

### 🗾GUIDING_PRINCIPLES.md
**パス**: `develop/blog/GUIDING_PRINCIPLES.md`

**編集内容**:
- **用語集（セクション4）**: Tag Groupの定義を追加
  - `Tag Group` | タググループ | タグを技術領域（Remix, Cloudflare, Claude Code）ごとに分類したグループ。フィルタパネルでグループ別に表示し、UXを向上させる
- **セクション間連携（セクション4）**: FilterPanelの目的を更新
  - タググループ化によるコンテンツの発見性向上を明記

### 📚️func-spec.md
**パス**: `develop/blog/posts/func-spec.md`

**編集内容**:
- **基本機能（セクション「🎯 機能要件」）**: FilterPanelの説明を更新
  - タグフィルタが「技術グループ（Remix, Cloudflare, Claude Code, その他）ごとにグループ分けされて表示」されることを追記
- **出力データ（FilterData型定義）**: `tagGroups`フィールドを追加
  ```typescript
  interface FilterData {
    availableCategories: string[]
    availableTags: string[]
    tagGroups: { group: string; tags: string[] }[] // 追加
    selectedCategory?: string
    selectedTags?: string[]
  }
  ```
- **app/components要件（FilterPanel.tsx）**: TagGridの構成を更新
  - TagGridがグループヘッダー（例: "Remix"）とそのグループに属するタグボタンを表示することを明記
- **副作用要件（fetchAvailableFilters.server.ts）**: 出力データに`tagGroups`を追加
  - `tagGroups: { group: string; tags: string[] }[]` （グループ名とそのグループに属するタグの配列）

### 🖼️uiux-spec.md
**パス**: `develop/blog/posts/uiux-spec.md`

**編集内容**:
- **レイアウトのコンポーネント構造規範（セクション「🧩 レイアウトのコンポーネント構造規範」）**: TagGrid配下にTagGroupHeaderを追加
  ```mermaid
  J["TagGrid (タググリッド: 列数調整可能)"] --> J1["TagGroupHeader × N (グループ見出し)"]
  J --> J2["TagButton × N (タグボタン)"]
  ```
- **認定済み並列配置（セクション5）**: TagGrid内のグループ別タグ配置を更新
  - **対象アイテム**: `TagGroupHeader`（グループ見出し）+ `TagButton × N`（各グループのタグボタン）
  - **レイアウトの意図**: `縦方向の繰り返し構造。各グループは見出し + グリッドレイアウトのタグボタン群で構成。グループ間にマージンを設ける`
- **FilterPanel（セクション「⚡ インタラクションと状態遷移の設計」）**: UI構想図を追記
  ```
  [Remix]
  [SSR][Vite][Vitest]...

  [Cloudflare]
  [Workers][Pages][KV]...

  [Claude Code]
  [MCP][Skills][Prompts]...

  [その他]
  [troubleshooting][refactoring]...
  ```

### 📋️spec.yaml
**パス**: `develop/blog/posts/spec.yaml`

**編集内容**:
- **すでに`group`プロパティが各タグに追加されているため、構造的な変更は不要**
- **TAG_CATEGORY_SPEC.mdからの移植内容**:
  - `tags`セクションのコメントに、グループ化の目的とUI表示方針を追記
  ```yaml
  # タググループ化方針:
  # - UIでは、タグを技術グループ（Remix, Cloudflare, Claude Code, その他）ごとに表示
  # - 各タグの`group`プロパティに基づいて動的にグループ表示を構築
  # - グループ順序: 1) Remix, 2) Cloudflare, 3) Claude Code, 4) other
  ```
  - `ui_selectors`セクションに`tag_group_header`を追加
  ```yaml
  tag_group_header: "[data-testid='tag-group-header']"
  ```

### 🗂️file_list.md
**パス**: `develop/blog/posts/file-list.md`

**編集内容**:
- **純粋ロジック層（セクション4）**: groupTagsByCategory.tsを追加
  ```
  | groupTagsByCategory.ts | app/lib/blog/posts/groupTagsByCategory.ts | タグをグループごとに分類する純粋関数。availableTagsとspec.yamlのタグ定義から、{ group: string; tags: string[] }[]を生成 |
  | groupTagsByCategory.test.ts | app/lib/blog/posts/groupTagsByCategory.test.ts | ユニットテスト |
  ```
- **副作用層（セクション5）**: fetchAvailableFilters.server.tsの説明を更新
  - 「タググループ情報（tagGroups）も生成して返す」ことを追記

### 🧬data-flow-diagram.md
**パス**: `develop/blog/posts/data-flow-diagram.md`

**編集内容**:
- **副作用層（data-io）テーブル**: fetchAvailableFilters.serverの説明を更新
  - 責務: 「利用可能なフィルタ情報の取得。すべての記事から利用可能なカテゴリとタグを抽出し、**タググループ情報も生成**して返す。AvailableFilters（categories: string[], tags: string[], **tagGroups: { group: string; tags: string[] }[]**）を返す」
- **純粋ロジック層（lib）テーブル**: groupTagsByCategoryを追加
  ```
  | groupTagsByCategory | タググループ化処理。利用可能なタグリストとspec.yamlのタグ定義から、グループ別タグ情報を生成する純粋関数 | - |
  ```
- **Mermaid図**: groupTagsByCategoryノードを追加し、データフローを更新

## 6 TDD_WORK_FLOW.md 簡易版
以下の全項目に対して、実際のパスと編集内容を1行で記載して。
完全な計画ではなく、大枠がわかればよい。
特に、新規ファイルに関して把握したい。

### 👁️e2e-screen-test
**パス**: `tests/e2e/screen/blog.screen.spec.ts`
**編集内容**: タググループ化の表示確認テストを追加（グループヘッダーが表示されること、各グループのタグが正しく表示されること）

### 👁️e2e-section-test
**パス**: `tests/e2e/section/blog/posts.spec.ts`
**編集内容**: FilterPanel内のタググループ表示とグループ別タグ選択のインタラクションテストを追加

### 🎨CSS実装 (layer2.css, layer3.ts, layer4.ts)
**パス**:
- `app/styles/blog/layer2.css`: `.tag-group-header`の見た目（色、フォントサイズ、font-weight）を追加
- `app/styles/blog/layer3.ts`: **flex/grid指定を変更・追加**
  - `.tag-grid`: grid → flex (column) に変更
  - `.tag-group-container`: 新規追加（flex (column)）
  - `.tag-group-grid`: 新規追加（grid、既存の`.tag-grid`のgrid指定を継承）
- `app/styles/blog/layer4.ts`: 変更なし（例外的な構造は不要）

### 🪨route
**パス**: `app/routes/blog._index.tsx`
**編集内容**: loaderでfetchAvailableFilters.serverから取得したtagGroupsをFilterPanelに渡すよう更新

### 🚧components.test
**パス**:
- `app/components/blog/posts/TagGrid.test.tsx`: グループ化されたタグの表示テストを追加
- `app/components/blog/posts/FilterPanel.test.tsx`: tagGroupsプロパティを受け取るテストケースを追加

### 🪨components
**パス**:
- `app/components/blog/posts/TagGrid.tsx`: tagGroupsプロパティを受け取り、グループヘッダー + タグボタンの形式で表示するよう実装を変更
- `app/components/blog/posts/FilterPanel.tsx`: tagGroupsをTagGridに渡すよう更新

### 🚧logic.test
**パス**: `app/lib/blog/posts/groupTagsByCategory.test.ts` **【新規】**
**編集内容**: availableTagsとspec.yamlのタグ定義から、グループ別タグ配列を生成するロジックのユニットテスト

### 🪨logic
**パス**: `app/lib/blog/posts/groupTagsByCategory.ts` **【新規】**
**編集内容**: タググループ化処理の純粋関数を実装（入力: availableTags[], tagsSpec、出力: { group: string; tags: string[] }[]）

### 🚧data-io.test
**パス**: `app/data-io/blog/posts/fetchAvailableFilters.server.test.ts`
**編集内容**: tagGroupsフィールドが正しく返されることを検証するテストを追加

### 🪨data-io
**パス**: `app/data-io/blog/posts/fetchAvailableFilters.server.ts`
**編集内容**: groupTagsByCategoryを呼び出し、tagGroups情報を含むAvailableFiltersオブジェクトを返すよう実装を変更

### その他
**パス**:
- `develop/blog/posts/spec.yaml`: `ui_selectors.filter.tag_group_header`セレクタを追加、tagsセクションにグループ化方針のコメントを追加
- `TAG_CATEGORY_SPEC.md`: 削除（spec.yamlに統合済み）
- `develop/blog/タググループ追加.md`: 実装完了後、実装ログを追記してクローズ
- **重要**: 新規ファイル作成時は `scripts/generate/README.md` を厳守すること

---

## 7. Flex/Grid レイアウト設計の詳細

### 7.1 現状のレイアウト構造（As-Is）

**TagGrid (現在)**:
```tsx
<div className="tag-grid"> {/* Grid: 列数可変、行自動生成 */}
  <button>SSR</button>
  <button>Vite</button>
  <button>Workers</button>
  <button>MCP</button>
  {/* すべてのタグが同一階層でグリッド配置 */}
</div>
```

**CSS指定（現状）**:
- **TagGrid**: `display: grid`、列数は`grid-template-columns`で指定（spec.yamlのresponsive.tag_grid_columnsから取得）
- **タグボタン**: グリッドアイテムとして配置

### 7.2 変更後のレイアウト構造（To-Be）

**TagGrid (変更後)**:
```tsx
<div className="tag-grid"> {/* Flex: 縦方向、グループを縦に並べる */}

  <div className="tag-group-container"> {/* Flex: 縦方向 */}
    <h3 className="tag-group-header">Remix</h3>
    <div className="tag-group-grid"> {/* Grid: 列数可変 */}
      <button>SSR</button>
      <button>Vite</button>
      <button>React</button>
    </div>
  </div>

  <div className="tag-group-container">
    <h3 className="tag-group-header">Cloudflare</h3>
    <div className="tag-group-grid">
      <button>Workers</button>
    </div>
  </div>

  <div className="tag-group-container">
    <h3 className="tag-group-header">Claude Code</h3>
    <div className="tag-group-grid">
      <button>MCP</button>
      <button>Skills</button>
      <button>Prompts</button>
      <button>Projects</button>
    </div>
  </div>

  <div className="tag-group-container">
    <h3 className="tag-group-header">その他</h3>
    <div className="tag-group-grid">
      <button>troubleshooting</button>
      <button>refactoring</button>
      <button>testing</button>
      <button>architecture</button>
    </div>
  </div>

</div>
```

### 7.3 Flex/Grid 変更マトリクス

| 要素 | 現状（As-Is） | 変更後（To-Be） | 変更理由 |
|:---|:---|:---|:---|
| **TagGrid** | `display: grid`<br/>列数: spec.yaml管理<br/>すべてのタグを直接配置 | `display: flex`<br/>`flex-direction: column`<br/>グループコンテナを縦に並べる | グループごとの縦配置が必要になったため |
| **TagGroupContainer**<br/>（新規） | - | `display: flex`<br/>`flex-direction: column`<br/>グループヘッダー + グリッドを縦配置 | グループヘッダーとタググリッドを縦に並べるため |
| **TagGroupGrid**<br/>（新規） | - | `display: grid`<br/>`grid-template-columns: repeat(N, 1fr)`<br/>列数: spec.yaml管理 | **既存のTagGridのグリッド指定を継承**。各グループ内でタグをグリッド配置 |
| **TagGroupHeader**<br/>（新規） | - | ブロック要素（デフォルト） | グループ名を表示するだけ |
| **タグボタン** | グリッドアイテム（TagGrid直下） | グリッドアイテム（TagGroupGrid直下） | 親要素が変わるが、グリッドアイテムとしての性質は同じ |

### 7.4 削除するCSS指定

**app/styles/blog/layer3.ts**:
```typescript
// 削除対象: TagGrid自体のグリッド指定
'.tag-grid': {
  display: 'grid',
  gridTemplateColumns: 'repeat(var(--tag-grid-columns), 1fr)',
  gap: '0.5rem', // ← この値は変更して保持（グループ間のマージンとして使用）
}
```

### 7.5 追加するCSS指定

#### Layer 2: 見た目の定義

**app/styles/blog/layer2.css**:
```css
/* TagGroupHeader: グループ見出しの見た目 */
.tag-group-header {
  font-size: 0.875rem; /* 14px */
  font-weight: 600;
  color: var(--color-text-secondary);
}
```

**注意**: `.tag-group-header`は見た目のみを定義します。レイアウト（margin-bottom）は定義しません。

#### Layer 3: Flex/Gridレイアウトの定義

**app/styles/blog/layer3.ts**:
```typescript
// TagGrid: グループを縦に並べるFlexコンテナ（grid → flexに変更）
'.tag-grid': {
  display: 'flex',
  flexDirection: 'column',
  gap: 'var(--spacing-4)', // グループ間のマージン（Layer 1トークンを参照）
}

// TagGroupContainer: 各グループのコンテナ（新規追加）
'.tag-group-container': {
  display: 'flex',
  flexDirection: 'column',
  gap: 'var(--spacing-2)', // ヘッダーとグリッドの間隔（Layer 1トークンを参照）
}

// TagGroupGrid: 各グループ内のタググリッド（既存のTagGridのグリッド指定を継承）
'.tag-group-grid': {
  display: 'grid',
  gridTemplateColumns: 'repeat(var(--tag-grid-columns), 1fr)',
  gap: 'var(--spacing-2)', // タグボタン間の間隔（Layer 1トークンを参照）
}
```

**重要**: Layer 3ではgapに限り、Layer 1の`var(--spacing-*)`トークンを直接参照可能です。具体的な値（`1rem`, `0.5rem`）は使用せず、必ずLayer 1トークンを参照してください。

### 7.6 実装時の注意点

1. **Layer分離の厳守**:
   - **Layer 2**: 見た目のみ（色、フォントサイズ、font-weight）
   - **Layer 3**: Flex/Gridレイアウトのみ（display, flex-direction, grid-template-columns, gap）
   - **margin-bottom等の余白**: Layer 3のgapで統一すること（Layer 2でmarginを使用しない）

2. **Layer 1トークンの使用**:
   - Layer 3のgapでは、`var(--spacing-*)`トークンを直接参照すること
   - 具体的な値（`1rem`, `0.5rem`, `16px`等）の直接指定は禁止
   - 例: `gap: 'var(--spacing-4)'` ← 正しい、`gap: '1rem'` ← 誤り

3. **列数の管理**: `--tag-grid-columns` CSS変数は、TagGroupGrid（各グループ内のグリッド）に適用されることを明確にする

4. **レスポンシブ対応**: `--tag-grid-columns`の値はブレークポイントごとに変更可能（spec.yamlで管理）

5. **既存のタグボタンスタイル**: 変更不要（グリッドアイテムとしての性質は同じ）

6. **globals.cssの確認**: `--spacing-2`, `--spacing-4`トークンが`app/styles/globals.css`に定義されているか確認すること。未定義の場合は追加が必要

7. **新規ファイル作成時の規範**: 新規ファイル（`groupTagsByCategory.ts`等）を作成する際は、**必ず `scripts/generate/README.md` の規範を厳守**すること。テンプレートから生成し、手動でファイルを作成しないこと

### 7.7 uiux-spec.md への追記内容（修正版）

**認定済み並列配置（セクション5）の「5. TagGrid内のタグボタン配置」を以下に置き換え**:

---

#### 5-1. TagGrid内のグループコンテナ配置（新規）

| 設計項目 | 定義 | 備考 |
| :--- | :--- | :--- |
| **対象コンテナ** | `TagGrid` | タググリッド全体のコンテナ |
| **対象アイテム** | `TagGroupContainer × N` | 各技術グループのコンテナ（Remix, Cloudflare, Claude Code, その他） |
| **想定アイテム数** | `固定: 4個` | グループ数は4つ（Remix, Cloudflare, Claude Code, その他） |
| **レイアウトの意図** | `縦方向のFlexbox配置、グループ間にマージンを設ける` | グループを上から下へ順番に配置。グループ間の視覚的な分離を明確にする |
| **Layer 3 CSS指定** | `display: flex; flex-direction: column; gap: var(--spacing-4);` | **既存のgrid指定を削除し、flex指定に変更**。gapはLayer 1トークンを参照 |

---

#### 5-2. TagGroupContainer内の構造（新規）

| 設計項目 | 定義 | 備考 |
| :--- | :--- | :--- |
| **対象コンテナ** | `TagGroupContainer` | 各技術グループのコンテナ |
| **対象アイテム** | `TagGroupHeader`（見出し）+ `TagGroupGrid`（タググリッド） | 固定2要素 |
| **想定アイテム数** | `固定: 2個` | ヘッダー1つ + グリッド1つ |
| **レイアウトの意図** | `縦方向のFlexbox配置、ヘッダーとグリッドを縦に並べる` | グループ名を表示した後、そのグループのタグを表示 |
| **Layer 3 CSS指定** | `display: flex; flex-direction: column; gap: var(--spacing-2);` | gapはLayer 1トークンを参照 |

---

#### 5-3. TagGroupGrid内のタグボタン配置（既存の「5」を移動・名称変更）

| 設計項目 | 定義 | 備考 |
| :--- | :--- | :--- |
| **対象コンテナ** | `TagGroupGrid` | 各グループ内のタググリッド |
| **対象アイテム** | タグボタン（`button × N`） | 各グループに属するタグ |
| **想定アイテム数** | `可変: グループごとに異なる` | Remix: 3個、Cloudflare: 1個、Claude Code: 4個、その他: 4個（現状） |
| **レイアウトの意図** | `グリッドレイアウト、列数は調整可能、行は自動生成` | **既存のTagGridのグリッド指定を継承**。タグをグリッドで表示。選択時は視覚的にハイライト。列数はCSS変数（`--tag-grid-columns`）で柔軟に調整可能。**具体的な列数はspec.yamlで管理** |
| **Layer 3 CSS指定** | `display: grid; grid-template-columns: repeat(var(--tag-grid-columns), 1fr); gap: var(--spacing-2);` | **既存のTagGridから移動**。gapはLayer 1トークンを参照 |

---