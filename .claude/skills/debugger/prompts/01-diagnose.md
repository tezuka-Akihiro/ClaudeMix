# エラー診断プロンプト

## AI役割定義

あなたはエラー診断の専門家です。
エラー情報を収集し、影響レイヤーを判定し、優先度を決定してください。

## 前提条件

ClaudeMixプロジェクトの3大層アーキテクチャ：

- **UI層** (`app/routes/`, `app/components/`): ユーザーインターフェース
- **lib層** (`app/lib/`): 純粋ロジック（ビジネスロジック、バリデーション）
- **data-io層** (`app/data-io/`): 副作用（API呼び出し、DB操作）

## 思考プロセス（CoT）

以下の順序で段階的に診断してください：

```text
Step 1: エラー情報の収集
  → エラーメッセージ、スタックトレース、再現手順は何か？

Step 2: エラータイプの特定
  → runtime-error / test-failure / type-error / build-error / logic-error / integration-error / performance-issue

Step 3: 影響レイヤーの判定
  → ui / lib / data-io / test / config のどこか？

Step 4: 優先度の判定
  → P0 (Critical) / P1 (Error) / P2 (Warning)

Step 5: 影響範囲の特定
  → どのファイル・コンポーネントに影響するか？
```

## 実行手順

### 1. エラー情報の収集

以下の情報を収集：

#### 必須情報

- **エラーメッセージ**: 完全なエラーメッセージ
- **スタックトレース**: エラーが発生した場所
- **再現手順**: どのような操作で発生するか
- **期待される動作**: 本来どうあるべきか
- **実際の動作**: 何が起きているか

#### オプション情報

- **環境情報**: Node.jsバージョン、ブラウザ、OS
- **発生頻度**: 毎回 / 時々 / 稀
- **関連する変更**: 最近の変更内容

### 2. エラータイプの特定

| エラータイプ | 定義 | 例 |
| :--- | :--- | :--- |
| **runtime-error** | 実行時エラー | TypeError, ReferenceError |
| **test-failure** | テスト失敗 | E2E失敗、ユニットテスト失敗 |
| **type-error** | TypeScriptエラー | 型不一致 |
| **build-error** | ビルドエラー | コンパイルエラー、依存関係エラー |
| **logic-error** | ロジックエラー | 期待値と異なる結果 |
| **integration-error** | 統合エラー | API通信エラー |
| **performance-issue** | パフォーマンス問題 | 遅いレンダリング |

### 3. 影響レイヤーの判定

スタックトレースやファイルパスから判定：

| ファイルパス | レイヤー |
| :--- | :--- |
| `app/routes/**` | ui |
| `app/components/**` | ui |
| `app/lib/**` | lib |
| `app/data-io/**` | data-io |
| `tests/e2e/**` | test |
| `tests/unit/**` | test |
| その他 | config |

### 4. 優先度の判定

| 優先度 | 判定基準 | マーク |
| :--- | :--- | :--- |
| **P0 (Critical)** | 本番環境エラー、ビルド失敗、Critical E2E失敗、セキュリティ問題 | 🔴 |
| **P1 (Error)** | 実行時エラー、ユニットテスト失敗、統合エラー | 🟡 |
| **P2 (Warning)** | パフォーマンス問題、コンソール警告、Lintエラー | 🔵 |

### 5. 影響範囲の特定

以下を確認：

- **直接影響**: エラーが発生しているファイル
- **間接影響**: 依存しているファイル・コンポーネント
- **波及範囲**: 修正によって影響を受ける可能性がある箇所

## 完了条件チェックリスト

- [ ] エラーメッセージとスタックトレースを収集した
- [ ] エラータイプを特定した
- [ ] 影響レイヤーを判定した
- [ ] 優先度を判定した
- [ ] 影響範囲を特定した

## Output形式

```markdown
## エラー診断結果

### 基本情報

**エラータイプ**: {error-type}
**影響レイヤー**: {ui / lib / data-io / test / config}
**優先度**: {🔴 P0 / 🟡 P1 / 🔵 P2}
**発生日時**: {timestamp}

### エラー詳細

**エラーメッセージ**:
```
{error-message}
```

**スタックトレース**:
```
{stack-trace}
```

**発生ファイル**: {file-path}:{line-number}

### 再現手順

1. {step1}
2. {step2}
3. {step3}

**発生頻度**: {毎回 / 時々 / 稀}

### 期待される動作 vs 実際の動作

**期待される動作**:
{expected-behavior}

**実際の動作**:
{actual-behavior}

### 影響範囲

**直接影響**:
- {file1}
- {file2}

**間接影響**:
- {file3}
- {file4}

**波及範囲**:
- {area1}
- {area2}

### 環境情報

- Node.js: {version}
- ブラウザ: {browser}（E2Eの場合）
- OS: {os}

---

**次のステップ**: prompts/02-analyze.md で根本原因分析を実行
```

## エラータイプ別の診断ポイント

### runtime-error

- **確認ポイント**:
  - null/undefined参照がないか
  - 型変換は正しいか
  - 配列の範囲外アクセスがないか

### test-failure

- **確認ポイント**:
  - テストケースが正しいか
  - モックが正確か
  - 実装とテストの不整合がないか

### type-error

- **確認ポイント**:
  - 型定義が正しいか
  - 型推論が期待通りか
  - any型を使用していないか

### build-error

- **確認ポイント**:
  - 依存関係が正しいか
  - import/exportが正しいか
  - 構文エラーがないか

### logic-error

- **確認ポイント**:
  - アルゴリズムが正しいか
  - エッジケースを考慮しているか
  - 境界値処理が正しいか

### integration-error

- **確認ポイント**:
  - API仕様が正しいか
  - エラーハンドリングがあるか
  - タイムアウト処理があるか

### performance-issue

- **確認ポイント**:
  - 不要な再レンダリングがないか
  - データ量が多すぎないか
  - 非効率なアルゴリズムがないか
