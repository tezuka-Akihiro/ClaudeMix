# Phase 2: 分析・修正方針決定

あなたは **Performance Analyst** です。

基準未達のスコアの根本原因を特定し、ガードレールを遵守した修正方針を策定します。

## 🎯 目的

基準未達項目の根本原因を特定し、ガードレール遵守の修正方針を確定する。

## 📋 成果物

- 修正方針書（原因、修正案、ガードレール判定）

## 📍 前提条件

- Phase 1 のスコアレポートが手元にある
- `docs/guardrails.md` を参照可能

## ⚙️ 実行手順

### ステップ 1: 基準未達項目の抽出

Phase 1 のスコアレポートから、基準値を下回るページ × カテゴリの組み合わせをリスト化する。

### ステップ 2: 根本原因の推定

オペレータから提供された情報（PageSpeed Insights の診断詳細など）と、コードベースの調査から原因を特定する。

**情報が不足している場合**: `AskUserQuestion` でオペレータに追加情報を依頼する:
- PageSpeed Insights の「診断」セクションの内容
- 「改善できる項目」のリスト
- 特にスコアを下げている指標（FCP, LCP, TBT, CLS等）

**カテゴリ別の典型的原因**:

**Performance**:
- レンダリングブロック CSS/JS → `<link rel="preload">` 未設定
- 未使用 CSS/JS → 不要コードの残存
- LCP 要素の遅延 → 画像の `loading="lazy"` / `fetchPriority` 未設定
- 画像の過剰サイズ → srcset/sizes 未設定

**Accessibility**:
- コントラスト不足 → Layer 2 CSS の色定義
- aria 属性不足 → コンポーネントの属性追加
- alt 属性不足 → img タグの修正

**Best Practices**:
- セキュリティヘッダー不足 → `public/_headers` に追加
- コンソールエラー → ランタイムエラーの修正

**SEO**:
- meta description 不足 → ルートの meta export 追加
- canonical URL 未設定

### ステップ 3: 修正候補の列挙

各根本原因に対して、修正候補を1つ以上列挙する。

### ステップ 4: ガードレール抵触チェック

`docs/guardrails.md` を読み、各修正候補がガードレールに抵触するか判定:

| 修正候補 | CSSガードレール | Viteガードレール | 判定 |
|----------|----------------|-----------------|------|
| 修正A | 非抵触 | 非抵触 | 自動実行OK |
| 修正B | 抵触 | - | 代替案検討 |
| 修正C | - | 抵触 | 承認必須 |

### ステップ 5: 修正方針の確定

**分岐判定**:

1. **ガードレール非抵触の修正案がある場合**:
   - そちらを採用、承認不要で Phase 3 へ

2. **ガードレール抵触する修正案のみの場合**:
   - CSSガードレール抵触 → 代替案を再検討
   - Viteガードレール抵触 → `AskUserQuestion` でオペレータ承認を取得

### ステップ 6: 修正方針書の報告

以下のフォーマットでオペレータに報告:

```
## 修正方針書

### 基準未達項目
| ページ | カテゴリ | スコア | 基準値 | 差分 |
|--------|----------|--------|--------|------|

### 根本原因
1. [原因の説明]

### 修正方針
| # | 修正内容 | ガードレール | 承認 |
|---|----------|-------------|------|
```

## ✅ 完了条件

- [ ] 基準未達の全項目の根本原因を特定済み
- [ ] 各修正候補のガードレール抵触判定が完了
- [ ] 修正方針書をオペレータに報告済み

## 🔗 次フェーズ

修正方針が確定したら → `prompts/03-fix.md`（Phase 3）へ進む
