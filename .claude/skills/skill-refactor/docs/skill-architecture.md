# スキルアーキテクチャ定義

スキルのフォルダ構成と参照ルールを定義する。

## フォルダ構成（4層）

```text
.claude/skills/{skill-name}/
├── SKILL.md             # 司令塔（Workflow）
├── prompts/             # 金型（Templates）
│   ├── 01-phase1.md
│   └── 02-phase2.md
├── scripts/             # 実行ラッパー（Actions）※必要な場合のみ
│   └── run-xxx.sh
└── docs/                # 辞書（Knowledge）
    ├── reference.md
    └── errors.md
```

## 各層の責務

| 層 | 役割 | 含めるもの | 含めないもの |
| :--- | :--- | :--- | :--- |
| SKILL.md | 司令塔 | フロー定義、参照先、When to Use | 詳細な指示、具体例 |
| prompts/ | 金型 | AI役割定義、実行手順、Output形式 | 設計思想の解説 |
| scripts/ | 実行 | 定型シェルコマンド、scriptsラッパー | ビジネスロジック |
| docs/ | 辞書 | 設計基準、失敗パターン、テンプレート | 実行フロー |

## 参照ルール

層間の参照方向を定義する。循環参照を防ぎ、依存関係を明確にする。

### 参照マトリクス

| 参照元 ↓ / 参照先 → | SKILL.md | prompts/ | scripts/ | docs/ |
| :--- | :--- | :--- | :--- | :--- |
| **SKILL.md** | - | OK | OK | OK |
| **prompts/** | NG | - | OK | OK |
| **scripts/** | NG | NG | - | OK |
| **docs/** | NG | NG | NG | - |

### 参照フロー図

```text
SKILL.md (司令塔)
    │
    ├──→ prompts/ (思考の金型)
    │        │
    │        ├──→ scripts/ (実行)
    │        │        │
    │        │        └──→ docs/ (参照のみ)
    │        │
    │        └──→ docs/ (参照)
    │
    ├──→ scripts/ (直接実行も可)
    │
    └──→ docs/ (直接参照も可)
```

### ルールの根拠

| ルール | 理由 |
| :--- | :--- |
| prompts/ → SKILL.md は NG | 循環参照の防止。司令塔は上位層 |
| scripts/ → prompts/ は NG | 実行層は思考層に依存しない |
| docs/ → 他層は全て NG | 辞書は参照されるのみ。能動的に他を呼ばない |

## scripts/ 層の設計指針

### 目的

- AIに「考えさせない」＝決定済みの作業を定型化
- 作業品質の安定化
- プロジェクト共通スクリプトのスキル用ラッパー

### プロジェクトスクリプトとの関係

```text
scripts/                         # プロジェクト共通（汎用）
    └── lint-template/
    └── generate/
        ↑
        参照・ラップ
        ↑
.claude/skills/{skill}/
    └── scripts/                 # スキル専用ラッパー（特化）
        └── run-lint.sh          # 引数を固定して呼び出し
```

### 命名規則

| パターン | 用途 | 例 |
| :--- | :--- | :--- |
| `run-{action}.sh` | 実行系 | `run-lint.sh`, `run-build.sh` |
| `check-{target}.sh` | 検証系 | `check-types.sh` |
| `setup-{resource}.sh` | 準備系 | `setup-env.sh` |

### allowed-tools との関係

scripts/ を持つスキルは `allowed-tools` に `Bash` を含める必要がある。

```yaml
---
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---
```

## 適用判断

### 3層で十分なケース

- プロンプト生成・分析が主目的
- シェル操作が不要または単発
- AI判断が主体で、定型処理が少ない

### 4層（scripts/追加）が必要なケース

- 定型的なシェル操作が複数回発生
- プロジェクト共通スクリプトをスキル用にカスタマイズしたい
- 実行手順を厳密に固定したい

## scripts/ 追加の検討プロセス

リファクタリング時に scripts/ を追加すべきか判断するためのプロセス。

### Step 1: 処理の洗い出し

prompts/ 内の実行手順から、シェルコマンドで実行可能な処理を抽出する。

```text
例:
- ファイル一覧の取得
- 行数カウント
- ディレクトリ作成
- テスト実行
- ビルド実行
```

### Step 2: 評価基準によるスコアリング

| 基準 | 説明 | 重み |
| :--- | :--- | :--- |
| 反復頻度 | 同じコマンドを複数回実行するか | 高 |
| 判断不要度 | AIに考えさせず固定したいか | 高 |
| 複雑度 | コマンドが複雑で間違いやすいか | 中 |
| ラップ必要性 | プロジェクトスクリプトをラップするか | 中 |

### Step 3: 判定マトリクス

| 反復頻度 | 判断不要度 | 判定 |
| :--- | :--- | :--- |
| 高 | 高 | scripts/ 追加 |
| 高 | 低 | 検討（AIが都度判断すべきか確認） |
| 低 | 高 | 不要（単発なら直接Bashで十分） |
| 低 | 低 | 不要（Claude Codeの標準ツールで十分） |

### Step 4: 代替手段との比較

scripts/ 追加前に、以下の代替手段で十分か確認する。

| 処理 | 代替手段 | scripts/が優位なケース |
| :--- | :--- | :--- |
| ファイル一覧 | `Glob` | なし（Globで十分） |
| 行数カウント | `Read`（行数表示あり） | なし |
| ディレクトリ作成 | `mkdir -p` 直接実行 | 複雑な構造を毎回作成する場合 |
| テスト実行 | `npm test` 直接実行 | 特定オプションを固定したい場合 |
| ビルド実行 | `npm run build` 直接実行 | 環境変数やフラグを固定したい場合 |

### 判定例

#### 例1: skill-refactor（判定: 不要）

| 処理 | 反復頻度 | 判断不要度 | 判定 |
| :--- | :--- | :--- | :--- |
| ファイル一覧取得 | 低（1回/セッション） | 低（Glob十分） | 不要 |
| 行数カウント | 低（1回/セッション） | 低（Read十分） | 不要 |
| 構成判定 | 低（1回/セッション） | 低（AI判断必要） | 不要 |

**結論**: 3層構成のまま

#### 例2: tdd-flow（判定: 追加推奨）

| 処理 | 反復頻度 | 判断不要度 | 判定 |
| :--- | :--- | :--- | :--- |
| テスト実行 | 高（Red/Green/Refactorで繰り返し） | 高（同じコマンド） | 追加 |
| カバレッジ取得 | 中（確認時に実行） | 高（オプション固定） | 追加 |

**結論**: scripts/ 追加

#### 例3: lp-manga（判定: 検討）

| 処理 | 反復頻度 | 判断不要度 | 判定 |
| :--- | :--- | :--- | :--- |
| 画像生成（Gemini） | 高（コマごとに実行） | 中（パラメータ変動あり） | 検討 |
| ファイル整理 | 中 | 高（命名規則固定） | 追加可 |

**結論**: 画像生成は外部ツール連携のため要検討

## チェック項目

| # | チェック項目 | 判定 |
| :--- | :--- | :--- |
| 1 | 参照ルールに違反していないか | [ ] |
| 2 | scripts/ の追加が妥当か（必要性の判断） | [ ] |
| 3 | scripts/ がある場合、allowed-tools に Bash があるか | [ ] |
| 4 | 各層の責務が守られているか | [ ] |
