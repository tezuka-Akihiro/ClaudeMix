# スキルアーキテクチャ定義

スキルのフォルダ構成と参照ルールを定義する。

## フォルダ構成（4層）

```text
.claude/skills/{skill-name}/
├── SKILL.md             # 司令塔（Workflow）
├── prompts/             # 金型（Templates）
│   ├── 01-phase1.md
│   └── 02-phase2.md
├── scripts/             # 実行ラッパー（Actions）※必要な場合のみ
│   └── run-xxx.sh
└── docs/                # 辞書（Knowledge）
    ├── reference.md
    └── errors.md
```

## 各層の責務

| 層 | 役割 | 含めるもの | 含めないもの |
| :--- | :--- | :--- | :--- |
| SKILL.md | 司令塔 | フロー定義、参照先、When to Use | 詳細な指示、具体例 |
| prompts/ | 金型 | AI役割定義、実行手順、Output形式 | 設計思想の解説 |
| scripts/ | 実行 | 定型シェルコマンド、scriptsラッパー | ビジネスロジック |
| docs/ | 辞書 | 設計基準、失敗パターン、テンプレート | 実行フロー |

## 参照ルール

層間の参照方向を定義する。循環参照を防ぎ、依存関係を明確にする。

### 参照マトリクス

| 参照元 ↓ / 参照先 → | SKILL.md | prompts/ | scripts/ | docs/ |
| :--- | :--- | :--- | :--- | :--- |
| **SKILL.md** | - | OK | OK | OK |
| **prompts/** | NG | - | OK | OK |
| **scripts/** | NG | NG | - | OK |
| **docs/** | NG | NG | NG | - |

### 参照フロー図

```text
SKILL.md (司令塔)
    │
    ├──→ prompts/ (思考の金型)
    │        │
    │        ├──→ scripts/ (実行)
    │        │        │
    │        │        └──→ docs/ (参照のみ)
    │        │
    │        └──→ docs/ (参照)
    │
    ├──→ scripts/ (直接実行も可)
    │
    └──→ docs/ (直接参照も可)
```

### ルールの根拠

| ルール | 理由 |
| :--- | :--- |
| prompts/ → SKILL.md は NG | 循環参照の防止。司令塔は上位層 |
| scripts/ → prompts/ は NG | 実行層は思考層に依存しない |
| docs/ → 他層は全て NG | 辞書は参照されるのみ。能動的に他を呼ばない |

## scripts/ 層の設計指針

### 目的

- AIに「考えさせない」＝決定済みの作業を定型化
- 作業品質の安定化
- プロジェクト共通スクリプトのスキル用ラッパー

### プロジェクトスクリプトとの関係

```text
scripts/                         # プロジェクト共通（汎用）
    └── lint-template/
    └── generate/
        ↑
        参照・ラップ
        ↑
.claude/skills/{skill}/
    └── scripts/                 # スキル専用ラッパー（特化）
        └── run-lint.sh          # 引数を固定して呼び出し
```

### 命名規則

| パターン | 用途 | 例 |
| :--- | :--- | :--- |
| `run-{action}.sh` | 実行系 | `run-lint.sh`, `run-build.sh` |
| `check-{target}.sh` | 検証系 | `check-types.sh` |
| `setup-{resource}.sh` | 準備系 | `setup-env.sh` |

### allowed-tools との関係

scripts/ を持つスキルは `allowed-tools` に `Bash` を含める必要がある。

```yaml
---
allowed-tools: Read, Write, Edit, Glob, Grep, Bash
---
```

### 典型的な allowed-tools パターン

| スキルタイプ | allowed-tools | 理由 |
| :--- | :--- | :--- |
| 読み取り専用調査 | Read, Grep, Glob | 安全性重視。コードベース探索のみ |
| コード生成 | Read, Write, Glob, Grep | ファイル作成が必要 |
| コード修正 | Read, Edit, Glob, Grep | 既存ファイル編集が必要 |
| 実行・検証 | Read, Bash, Glob | シェル実行が必要（テスト、ビルド等） |
| scripts付きスキル | Read, Write, Edit, Glob, Grep, Bash | scripts/の実行とファイル操作 |
| フルアクセス | 指定なし（全ツール） | 全ツール使用可能。慎重に使用 |

**ツールスコープ制限**:

特定のコマンドプレフィックスのみを許可する場合、スコープ構文を使用できます。

```yaml
---
allowed-tools: Bash(gh:*)
---
```

この例では、`gh` CLI（GitHub CLI）コマンドのみが許可されます。

## 適用判断

### 3層で十分なケース

- プロンプト生成・分析が主目的
- シェル操作が不要または単発
- AI判断が主体で、定型処理が少ない

### 4層（scripts/追加）が必要なケース

- 定型的なシェル操作が複数回発生
- プロジェクト共通スクリプトをスキル用にカスタマイズしたい
- 実行手順を厳密に固定したい

## scripts/ 追加の検討プロセス

リファクタリング時に scripts/ を追加すべきか判断するためのプロセス。

### Step 1: 処理の洗い出し

prompts/ 内の実行手順から、シェルコマンドで実行可能な処理を抽出する。

```text
例:
- ファイル一覧の取得
- 行数カウント
- ディレクトリ作成
- テスト実行
- ビルド実行
```

### Step 2: 評価基準によるスコアリング

| 基準 | 説明 | 重み |
| :--- | :--- | :--- |
| 反復頻度 | 同じコマンドを複数回実行するか | 高 |
| 判断不要度 | AIに考えさせず固定したいか | 高 |
| 複雑度 | コマンドが複雑で間違いやすいか | 中 |
| ラップ必要性 | プロジェクトスクリプトをラップするか | 中 |

### Step 3: 判定マトリクス

| 反復頻度 | 判断不要度 | 判定 |
| :--- | :--- | :--- |
| 高 | 高 | scripts/ 追加 |
| 高 | 低 | 検討（AIが都度判断すべきか確認） |
| 低 | 高 | 不要（単発なら直接Bashで十分） |
| 低 | 低 | 不要（Claude Codeの標準ツールで十分） |

### Step 4: 代替手段との比較

scripts/ 追加前に、以下の代替手段で十分か確認する。

| 処理 | 代替手段 | scripts/が優位なケース |
| :--- | :--- | :--- |
| ファイル一覧 | `Glob` | なし（Globで十分） |
| 行数カウント | `Read`（行数表示あり） | なし |
| ディレクトリ作成 | `mkdir -p` 直接実行 | 複雑な構造を毎回作成する場合 |
| テスト実行 | `npm test` 直接実行 | 特定オプションを固定したい場合 |
| ビルド実行 | `npm run build` 直接実行 | 環境変数やフラグを固定したい場合 |

### 判定例

#### 例1: skill-refactor（判定: 不要）

| 処理 | 反復頻度 | 判断不要度 | 判定 |
| :--- | :--- | :--- | :--- |
| ファイル一覧取得 | 低（1回/セッション） | 低（Glob十分） | 不要 |
| 行数カウント | 低（1回/セッション） | 低（Read十分） | 不要 |
| 構成判定 | 低（1回/セッション） | 低（AI判断必要） | 不要 |

**結論**: 3層構成のまま

#### 例2: tdd-flow（判定: 追加推奨）

| 処理 | 反復頻度 | 判断不要度 | 判定 |
| :--- | :--- | :--- | :--- |
| テスト実行 | 高（Red/Green/Refactorで繰り返し） | 高（同じコマンド） | 追加 |
| カバレッジ取得 | 中（確認時に実行） | 高（オプション固定） | 追加 |

**結論**: scripts/ 追加

#### 例3: lp-manga（判定: 検討）

| 処理 | 反復頻度 | 判断不要度 | 判定 |
| :--- | :--- | :--- | :--- |
| 画像生成（Gemini） | 高（コマごとに実行） | 中（パラメータ変動あり） | 検討 |
| ファイル整理 | 中 | 高（命名規則固定） | 追加可 |

**結論**: 画像生成は外部ツール連携のため要検討

## context フィールドの判断基準

スキルの実行コンテキストを決定する。

### 基本概念

| context値 | 実行方法 | 会話履歴へのアクセス | 用途 |
| :--- | :--- | :--- | :--- |
| `inline` | 現在の会話内で実行 | あり | ガイドライン、参考資料、対話型タスク |
| `fork` | 独立したサブエージェントで実行 | なし | 自己完結型の大規模タスク |

### 判断フロー

```text
スキルの性質を判断
  ↓
Q1: ガイドライン/参考資料か、タスク実行か？
  ├─ ガイドライン/参考資料 → context: inline (明示不要)
  └─ タスク実行 → Q2へ
      ↓
Q2: ユーザーとの対話が必要か？
  ├─ YES（確認、選択、段階的承認が必要） → context: inline
  └─ NO → Q3へ
      ↓
Q3: メインコンテキストを汚染する大量出力か？
  ├─ YES（大規模調査、ログ解析等） → context: fork
  └─ NO → context: inline
```

### inline が適切なケース（ClaudeMixの全スキル）

| 判断基準 | 説明 | 該当スキル例 |
| :--- | :--- | :--- |
| **フェーズごとの確認** | ユーザーの承認を得て次フェーズに進む | feature-revision, lp-manga, blog-planner |
| **対話型タスク** | AskUserQuestionで選択肢を提示 | architecture-guardian, generator-operator |
| **段階的な編集** | ユーザーがファイルを確認・編集してから次へ | lp-manga, skill-refactor |
| **ガイドライン提供** | 参考情報を会話内に展開 | architecture-guardian |

### fork が適切なケース（ClaudeMixでは未使用）

| 判断基準 | 説明 | 想定例 |
| :--- | :--- | :--- |
| **大規模調査** | 数百ファイルを横断的に調査 | 「プロジェクト全体の依存関係を可視化」 |
| **独立したレポート生成** | メインコンテキストに影響しない単独タスク | 「先月のコミット統計をレポート化」 |
| **隔離実行** | メインの会話履歴を参照する必要がない | 「指定ディレクトリのみでセキュリティ監査」 |

### ClaudeMixプロジェクトの方針

**すべてのスキルで `context: inline` を採用**

**理由**:

1. **フェーズ駆動型ワークフロー**: 全スキルが段階的確認を重視
2. **対話の重要性**: AskUserQuestionによる選択肢提示が頻繁
3. **編集の柔軟性**: ユーザーが途中で成果物を確認・修正できることが重要
4. **大規模調査の不要性**: プロジェクト規模が管理可能で、独立調査の必要がない

### 実装上の注意

**デフォルトは inline**:

```yaml
---
name: my-skill
description: ...
# context: inline ← 明示不要（デフォルト）
---
```

**fork を使う場合のみ明示**:

```yaml
---
name: deep-research
description: Research codebase thoroughly
context: fork
agent: Explore  # Explore, Plan, general-purpose から選択
---
```

## agent フィールドの判断基準（context: fork 時のみ）

**重要**: ClaudeMixプロジェクトでは現在使用していない（全スキルがinlineのため）。

| agent値 | デフォルトツール | 用途 |
| :--- | :--- | :--- |
| `Explore` | Read, Grep, Glob | 読み取り専用の大規模調査 |
| `Plan` | Read, Grep, Glob | 計画策定のための調査 |
| `general-purpose` | 全ツール | 汎用タスク（デフォルト） |

**カスタムエージェント**（`.claude/agents/`で定義）も指定可能だが、ClaudeMixでは不要と判断。

## ClaudeMixスキルの分類（全10スキル）

### ガイドライン提供型（1スキル）

| スキル名 | context | 用途 |
| :--- | :--- | :--- |
| architecture-guardian | inline | プロジェクト設計思想の参照、違反検出 |

### 対話型タスク実行（9スキル）

| スキル名 | context | フェーズ確認 | AskUserQuestion | 理由 |
| :--- | :--- | :--- | :--- | :--- |
| blog-planner | inline | ✅ 5段階 | ✅ | ステップごとの承認が必須 |
| blog-paywall-refactorer | inline | ✅ 5段階 | - | リファクタリング結果の確認が必要 |
| debugger | inline | ✅ 3段階 | ✅ | 修正案の選択が必要 |
| feature-revision | inline | ✅ 3フェーズ | ✅ | 各フェーズでユーザー確認必須 |
| generator-maintainer | inline | ✅ 検証フロー | - | テンプレート追加の確認が必要 |
| generator-operator | inline | - | ✅ | パラメータ不足時の確認が必要 |
| lp-manga | inline | ✅ 4フェーズ | ✅ | キャラクター.md等の編集を前提 |
| test-e2e-account | inline | - | - | エラー時のトラブルシュート対話 |
| skill-refactor | inline | ✅ 3フェーズ | ✅ | 分析→計画→実行の段階的確認 |

### 分類の示唆

**ClaudeMixでは以下の特性により、すべてのスキルでinlineが最適**:

- **90%のスキル**がフェーズごとの確認機能を持つ
- **70%のスキル**がAskUserQuestionで選択肢を提示
- **対話なしの完全自動実行スキルが存在しない**

この設計により、AIとユーザーの協調作業が円滑に進む。

## チェック項目

| # | チェック項目 | 判定 |
| :--- | :--- | :--- |
| 1 | 参照ルールに違反していないか | [ ] |
| 2 | scripts/ の追加が妥当か（必要性の判断） | [ ] |
| 3 | scripts/ がある場合、allowed-tools に Bash があるか | [ ] |
| 4 | 各層の責務が守られているか | [ ] |
| 5 | context フィールドの設定が適切か（inline/fork判断） | [ ] |
| 6 | context: fork の場合、agent フィールドが指定されているか | [ ] |
