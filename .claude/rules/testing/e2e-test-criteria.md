---
paths:
  - "tests/e2e/**/*.spec.ts"
---

# E2Eテスト設計基準

このルールは `tests/e2e/` 配下のすべてのE2Eテストファイルに適用されます。

## 目的

プロジェクトで実装されるE2E (End-to-End) テストの品質を担保し、一貫性を保つための最低基準を定義します。E2Eテストは、ユーザーの視点からアプリケーション全体の動作を保証する最後の砦です。

## Outside-In TDDとの関係

本基準は、**Outside-In TDD** の開発プロセスと密接に連携します。最初にE2Eテストで「システムの振る舞いのゴール」を定義し、そのゴールを達成するために内側の実装を進める際の指針となります。

---

## テスト設計の基本方針

### ユーザーシナリオ中心

テストは「ユーザーが何を達成したいか」というシナリオに基づいて設計します。技術的な実装の詳細ではなく、ユーザーの操作フローを検証します。

### Happy Path First

開発の初期段階では、まず最も重要で正常なシナリオ（ハッピーパス）をE2Eテストとして実装し、開発のゴールを明確にします。

### 段階的な詳細化

ハッピーパスのテストが成功した後、入力バリデーション、エラーハンドリング、境界値などの異常系テストを追加し、品質を段階的に向上させます。

---

## 階層別テスト基準

Outside-In TDDの考え方に従い、外側のレイヤーから内側のレイヤーへとテストの関心事を掘り下げていきます。

### commonセクションレベルのテスト

**目的**: ユーザーが特定のURLにアクセスした際の「第一印象」を保証します。ページが正しく描画され、ユーザーが次のアクションを起こせる状態にあることを確認します。

**最低基準**:

1. **ページ表示**: 対象のURLにアクセスした際、サーバーエラー（5xx系）やクライアントエラー（4xx系）が発生せず、ページが正常に表示されること (HTTPステータス 200)
2. **主要要素の存在**: ページの `<h1>` タグや `<title>` タグなど、その画面を識別するための最も重要な要素が表示されていること
3. **セクションの描画**: その画面を構成する主要な機能単位（セクション）がすべて描画されていること
   - 例: ユーザープロフィール画面であれば、「プロフィール情報セクション」「アクティビティ履歴セクション」などが表示されているかを確認します

### その他セクションレベルのテスト

**目的**: 画面を構成する特定の機能単位（例: ログインフォーム、商品一覧）が、ユーザーのアクションに対して期待通りに動作することを保証します。

**最低基準**:

1. **主要アクションの実行**: そのセクションが担う最も重要なユーザーアクション（フォームの入力と送信、ボタンのクリックなど）が最後まで成功すること
2. **結果の検証**: アクション実行後、期待される結果が得られることを確認します
   - 例: フォーム送信後に「成功しました」というメッセージが表示される、または別のページに正しく遷移する
3. **UIコンポーネントの存在**: そのセクションの機能を成立させるために不可欠なUIコンポーネント（入力フィールド、送信ボタン、データテーブルなど）が表示されていること

### UIコンポーネント (Component) レベルのテスト

**目的**: 個々のUI部品（ボタン、入力欄、ドロップダウンなど）のインタラクションと、それに応じた状態変化を保証します。E2Eテストでは、特に重要なコンポーネントの基本的な振る舞いを検証します。

**最低基準**:

1. **インタラクションの検証**: ユーザーの操作（クリック、入力など）に対して、コンポーネントが視覚的に期待通り反応すること
   - 例: クリックするとドロップダウンメニューが開く、タブを切り替えると表示内容が変わる
2. **バリデーションの検証**: 不正な値を入力してフォームを送信しようとした際に、適切なエラーメッセージが表示されること
3. **アクセシビリティの基本検証**: キーボードのTabキーで、主要なインタラクティブ要素（リンク、ボタン、入力欄）間をフォーカス移動できること

---

## テスト実装のヒント

### data-testidの活用

`getByTestId` を使用することで、CSSの変更に強い安定したテストを記述できます。

```typescript
// ✅ 推奨: data-testidを使用
await page.getByTestId('login-button').click()

// ⚠️ 注意: CSSセレクタは変更に弱い
await page.locator('.btn-primary').click()
```

### ユーザー中心のセレクタ

`getByRole`, `getByLabelText` など、ユーザーが要素をどのように認識するかに基づいたセレクタを優先的に使用します。

```typescript
// ✅ 推奨: ユーザー中心のセレクタ
await page.getByRole('button', { name: 'ログイン' }).click()
await page.getByLabelText('メールアドレス').fill('user@example.com')

// ⚠️ 注意: 実装詳細に依存
await page.locator('#submit-btn').click()
```

---

## AIエージェントへの指示

1. E2Eテストを生成する際は、必ずこの基準に従うこと
2. **Happy Path First**: まず正常系のシナリオを実装し、その後異常系を追加すること
3. **ユーザーシナリオ中心**: 技術的な実装詳細ではなく、ユーザーの操作フローを検証すること
4. **階層別の基準**: common/セクション/コンポーネントレベルの最低基準を満たすこと
5. **セレクタの優先順位**: `getByRole` > `getByLabelText` > `getByTestId` > CSSセレクタの順で優先すること
6. **アクセシビリティ**: キーボードナビゲーションのテストを含めること
7. Outside-In TDDのゴール設定として、E2Eテストを最初に実装すること
