---
paths:
  - "**/*.test.ts"
  - "**/*.test.tsx"
  - "**/*.spec.ts"
  - "**/*.spec.tsx"
---

# ユニットテストの最低基準（3大層分離アーキテクチャ）

このルールはすべてのユニットテストファイル（`*.test.{ts,tsx}`, `*.spec.{ts,tsx}`）に適用されます。

## 目的

**🎨UI層**、**🧠純粋ロジック層**、**🔌副作用層**の3つの層に分離されたアーキテクチャにおいて、各層の責務に応じたユニットテストの最低基準を定義します。

## Outside-In TDDとの関係

本プロジェクトでは、ユーザー視点の振る舞いを保証するE2Eテストで開発のゴールを定義し、そのゴールを達成するために各層のユニットテストを実装する **Outside-In TDD** を採用しています。

ユニットテストは、E2Eテストを補完し、各機能部品のロジックを網羅的に検証する役割を担います。

---

## 🧠 lib層 - 純粋ロジック層のテスト基準

**適用ファイル**: `app/lib/**/*.test.ts`, `app/lib/**/*.spec.ts`

### 目的

**副作用のない純粋関数**として、ビジネスロジック・計算・データ変換が確実性を持って動作することを保証します。

### 重要: カバレッジ100%必須

純粋ロジック層は**100%のテストカバレッジ**を必須とします。例外は認められません。

### 純粋性の保証テスト

**確認すべきこと**:
- 同じ入力に対して常に同じ出力を返す（決定論的であること）
- 外部状態を変更しない（副作用がないこと）
- 入力データを変更しない（イミュータブルであること）

### ビジネスロジックの完全テスト

**確認すべきこと**:
- **正常系**: 想定される全ての入力パターンで正しい結果を返すか
- **異常系・エッジケース**: null, undefined, 空値、境界値での適切な処理
- **境界値**: 最小値・最大値・ゼロ・負数での計算精度
- **全分岐パス**: if文、switch文、三項演算子の全てのパスを実行

### データ変換・バリデーションテスト

**確認すべきこと**:
- 型変換の正確性とエラーハンドリング
- バリデーションルールの完全実装
- データ構造の変換における情報損失の防止

---

## 🔌 data-io層 - 副作用層のテスト基準

**適用ファイル**: `app/data-io/**/*.test.ts`, `app/data-io/**/*.spec.ts`

### 目的

外部システムとの通信が正しく動作し、エラーケースも適切に処理されることを保証します。

### 正常系のテスト

**確認すべきこと**:
- 想定される典型的な入力値を渡した際に、期待される出力値が正確に返ってくるか
- lib層の純粋関数を正しく活用しているか

### 異常系・エッジケースのテスト

**確認すべきこと**:
- `null`, `undefined`, 空の配列 `[]`, 空のオブジェクト `{}` などを入力した場合に、関数がクラッシュせず、適切に処理するか
- 数値や文字列の境界値（0, -1, 非常に大きな値, 空文字など）を扱えるか
- ネットワークエラー、タイムアウト、APIエラーレスポンスなどの外部エラーを適切にハンドリングするか

### ビジネスロジックの境界値テスト

**確認すべきこと**:
- 計算ロジックが、入力値が0の場合や最大値の場合でも正しく機能するか
- 条件分岐（if文など）がある場合、全ての分岐パスを網羅するテストケースが存在するか

### モック化の要件

**確認すべきこと**:
- 外部依存（DB, API, ファイルI/O）はモック化してテストすること
- モックは実際の実装と同じインターフェースを持つこと

---

## 🎨 routes層 - UI層（Route）のテスト基準

**適用ファイル**: Routeコンポーネントのテストは**E2Eテストでカバーする**ことを推奨

### 注意

`app/routes` 配下にテストファイル (`*.test.tsx`) を置くと、ビルド時にエラーが発生する可能性があります。Routeコンポーネントのテストは、**E2Eテストでカバーする**か、テストファイルを別の専用ディレクトリに配置するなどの工夫が必要です。

### 目的（別ディレクトリでテストする場合）

**データフロー担当**として、適切なデータ処理（純粋ロジック層・副作用層）を呼び出し、適切なUI（Component）にデータを渡すことを保証します。

### loaderのテスト

**確認すべきこと**:
- リクエストのパラメータ（`params`, `request.url`）を正しく解釈し、適切な`data-io`関数を呼び出しているか
- `data-io`から受け取ったデータを、期待通りの形式（`json`）で返却しているか

### actionのテスト

**確認すべきこと**:
- フォームデータ（`FormData`）を正しく解析し、適切な`data-io`関数を呼び出しているか
- 処理成功時に、意図したページへリダイレクト（`redirect`）するか
- バリデーションエラー時に、エラー情報を含めて画面を再描画するか

### エラーハンドリングのテスト

**確認すべきこと**:
- 存在しないデータを要求された場合に404エラー（`new Response("Not Found", { status: 404 })`）を正しくスローするか

---

## 🎨 components層 - UI層（Component）のテスト基準

**適用ファイル**: `app/components/**/*.test.tsx`, `app/components/**/*.spec.tsx`

### 目的

**表示担当**として、propsを受け取りUIが仕様通りに描画され、ユーザーの操作に正しく反応することを保証します。

### レンダリングのテスト

**確認すべきこと**:
- 渡された`props`に基づいて、UIが正しく表示されるか
- データが存在する場合、空の場合、エラーの場合など、異なる状態で表示が切り替わるか

### インタラクションのテスト

**確認すべきこと**:
- ボタンのクリックやフォームの入力など、ユーザーのアクションによって期待されるイベントハンドラが呼び出されるか
- `@testing-library/user-event` の使用を推奨

### アクセシビリティのテスト

**確認すべきこと**:
- `getByRole` や `getByLabelText` など、アクセシビリティを意識したセレクタで要素を取得できるか

### E2Eテストとの役割分担

- **ユニットテストの責務**: コンポーネントの基本的なレンダリングと、イベントハンドラが呼び出されることの確認に集中します
- **E2Eテストの責務**: クリップボードAPI (`navigator.clipboard`) や複雑なキーボード操作など、**ブラウザ環境に強く依存するインタラクション**のテストはE2Eテストに任せます

---

## テスト実装の推奨手順

1. **仕様書確認**: 対象機能の機能設計書・画面仕様書・外部変数仕様書を読み返す
2. **テスト項目洗い出し**: 上記基準に基づいて、具体的にテストすべき項目を列挙する
3. **テストデータ準備**: 正常系・異常系・境界値のテストデータを用意する
4. **RED実装**: 仕様に沿った期待値を設定し、まず失敗するテストを書く
5. **GREEN実装**: テストが通る最小限の実装を行う
6. **REFACTOR**: テストと実装の両方をリファクタリングする

---

## テスト品質目標

### 大原則: NGを許容するテストは存在してはならない

TDDのレッドなど、開発中を除くテストの実施において、NGで放置することは許されません。

**理由**: 技術的負債の管理コストを限りなくゼロにするため。

### カバレッジ目標

- **lib層**: 100%必須
- **data-io層**: 80%以上
- **components層**: 主要なレンダリング・インタラクションをカバー
- **routes層**: E2Eテストでカバー

---

## AIエージェントへの指示

1. テストファイルを生成する際は、必ずこの基準に従うこと
2. lib層のテストでは100%カバレッジを必ず達成すること
3. 各層の責務に応じたテストのみを記述すること
4. モック化が必要な外部依存は適切にモック化すること
5. アクセシビリティを意識したセレクタ（`getByRole`, `getByLabelText`）を優先的に使用すること
6. 各層の基準を満たさないテストは、実装品質の低下につながるため、即座に修正すること
