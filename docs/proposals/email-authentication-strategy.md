# メール認証（マジックリンク / OTP）導入方針案

## 1. はじめに
本ドキュメントでは、ClaudeMixプロジェクトにおけるメール送受信を用いた認証機能（パスワードレス認証）の導入方針を提案します。

## 2. 導入の目的
- ユーザー体験（UX）の向上：パスワードの記憶や入力の手間を省く。
- セキュリティの向上：パスワード漏洩リスクの低減。
- 柔軟な認証手段の提供：Google OAuth以外の選択肢を強化。

## 3. 採用方針：Cloudflareネイティブ + 外部メールサービス
プロジェクトの「Cloudflare Pages + D1 + KV」というスタックを最大限に活かし、**自前実装（Cloudflareネイティブ）**による導入を推奨します。

### 比較検討

| 項目 | A. 自前実装 (Cloudflare + Resend) | B. Supabase Auth 導入 |
| :--- | :--- | :--- |
| **整合性** | **極めて高い**（既存のD1/KVスタックに適合） | 低い（D1とユーザー管理が重複） |
| **制御性** | 完全な制御が可能（UI/UXの微調整が容易） | 制限あり（提供元の仕様に依存） |
| **コスト** | 低（Resend無料枠: 3,000通/月） | 低（無料枠あり） |
| **実装工数** | 中（セキュリティ設計を自前で行う） | 低（マネージドサービス） |
| **ベンダーロックイン** | 低 | 高 |

**選定理由**:
既存のD1によるユーザー管理と整合性を保ち、プロジェクトのアーキテクチャ規約（3層分離）に則った実装を行うことで、長期的な保守性と拡張性を確保できるため。

## 4. 詳細設計（3層分離アーキテクチャ）

アーキテクチャ規約に基づき、以下の構造で実装します。

### 🧠 純粋ロジック層 (`app/lib/`)
- `auth/generateAuthToken.ts`: セキュアなランダムトークン（マジックリンク用）や6桁のコード（OTP用）を生成。
- `auth/validateTokenFormat.ts`: トークンの形式や有効期限の論理チェック。

### 🔌 副作用層 (`app/data-io/`)
- `auth/sendAuthEmail.server.ts`: Resend API 等を使用してメールを送信。
- `auth/tokenStore.server.ts`: Cloudflare KV を使用したトークンの保存（TTL設定による自動削除）と検証。
- `account/authentication/upsertUser.server.ts`: メールアドレスのみでユーザーを作成、または既存ユーザーを特定。

### 🎨 UI層 (`app/routes/`)
- `login.tsx`: 「メールでログイン」ボタンとフォームの追加。
- `auth.verify.tsx`: マジックリンクのクリックを受け取り、トークンを検証してセッションを開始。
- `auth.otp.tsx`: 6桁のコード入力画面（OTP採用時）。

## 5. 認証フロー（マジックリンクの場合）

1. **ユーザー**: `login.tsx` でメールアドレスを入力し「ログイン」をクリック。
2. **Action (Side Effect)**:
   - トークンを生成し、KVに保存（有効期限: 10分）。
   - Resend API を通じて、ログインURL（`https://.../auth/verify?token=xxx`）を送信。
3. **ユーザー**: メール内のリンクをクリック。
4. **Action (Side Effect)**:
   - `auth.verify.tsx` でトークンをKVから照合・削除。
   - D1にユーザーがいなければ新規作成。
   - セッションCookieを発行し、`/account` へリダイレクト。

## 6. セキュリティ上の考慮事項
- **トークンの単回使用**: 検証成功後にKVから即時削除。
- **有効期限**: 10分程度の短期間に設定。
- **レート制限**: 同一IPや同一メールアドレスからの連続送信をKVでカウントし制限。
- **列挙攻撃対策**: ユーザーの存在有無にかかわらず、送信完了画面を表示。

## 7. 実装ロードマップ
1. **フェーズ1**: 基盤実装（Resend連携、KVトークン管理、トークン生成ロジック）。
2. **フェーズ2**: ログイン画面への統合と検証用ルートの作成。
3. **フェーズ3**: パスワード認証とマジックリンク認証の共存（パスワード未設定ユーザーへの対応）。

## 8. 結論
自前実装（Option A）は、本プロジェクトの「MVPボイラープレート」としての純粋性を保ちつつ、高いカスタマイズ性と低コストを実現できる最適な選択肢です。
