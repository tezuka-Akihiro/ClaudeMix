# アーキテクチャ・マニフェスト: 目的駆動型・3大層分離アーキテクチャ

## 1. 原点回帰：アーキテクチャの真の目的

我々のアーキテクチャは、特定の層の数（例: 5層）を強制することが目的ではない。その核心的な目的は、以下の3つの原則を**「仕組み」としてコードベースに組み込む**ことにある。

1.  **テスト容易性の構造化 (Structural Testability)**
    > 「テストしやすいコードを書く」のではなく、「テストしにくいコードが書けない構造」を作る。

2.  **規約の自動強制 (Automated Enforcement of Conventions)**
    > 「規約を守る」のではなく、「規約違反をシステムが許さない」状態を作る。

3.  **開発プロセスの標準化 (Standardization of Development Process)**
    > 「テンプレートを使う」のではなく、「標準化されたプロセスが開発者を導く」体験を作る。

## 2. 核心ルール：「3大層分離」

上記の目的、特に「テスト容易性の構造化」を達成するために不可欠な最小限の構造は、**「3大層分離」**である。これが、我々のアーキテクチャにおける唯一の**絶対的な核心ルール**となる。

| 層の役割 | 配置ディレクトリ | 責務とテスト戦略 |
|:---|:---|:---|
| 🎨 **UI層** | `app/routes/`<br>`app/components/` | **関心事**: ユーザーへの表示とインタラクション。<br>**テスト**: `loader`/`action`の統合テスト、コンポーネントのレンダリング・操作テスト。 |
| 🧠 **純粋ロジック層** | `app/lib/` | **関心事**: 副作用のない純粋なビジネスロジック（計算、データ変換等）。<br>**テスト**: 入力と出力のみを検証する純粋なユニットテスト。**テストカバレッジ100%**を目指す。 |
| 🔌 **副作用層** | `app/data-io/` | **関心事**: 外部世界との通信（DBアクセス、APIコール等）。<br>**テスト**: 外部通信をモック化した上での入出力テスト。 |

**なぜこの3層か？**
-   **テスト容易性**: `純粋ロジック層`と`副作用層`を分離することで、テストで最も困難な「副作用」を容易にモック化できる。これにより、アプリケーションの頭脳であるビジネスロジックを、安定かつ網羅的にテストすることが可能になる。
-   **関心の分離**: 各層が持つ責任が明確になり、コードの見通しが良くなる。UIの変更がビジネスロジックに影響を与えにくくなるなど、メンテナンス性が向上する。

## 3. UI層の柔軟性：Remixベストプラクティスとの調和

核心である「3大層分離」さえ守られていれば、UI層（`routes`, `components`）の内部構造は、プロジェクトの規模や特性に応じて柔軟に選択できるべきである。

### 推奨ガイドライン：`{service}/{section}` パターン

-   **目的**: 大規模な機能や、複数の開発者が関わるサービスにおいて、関心の近いファイルを物理的に近くに配置（コロケーション）し、見通しを良くする。
-   **使い方**:
    -   サービス固有のコンポーネント: `app/components/{service}/{section}/`
    -   複数のサービスで共有されるコンポーネント: `app/components/flow-auditor/`
-   **位置づけ**: これは**強制ではなく推奨**。小規模な機能やプロトタイピングでは、Remixの標準的な `app/components/` 直下の構成でも良い。

~~~
app/
├── routes/
│   └── sales.tsx
│
├── components/
│   ├── shared/                # 汎用コンポーネント (ボタン、カード等)
│   │   └── Button.tsx
│   │
│   └── sales/                 # "sales"サービス固有のコンポーネント
│       ├── summary/           # "summary"セクション
│       │   └── SummaryChart.tsx
│       └── details/           # "details"セクション
│           └── DetailTable.tsx
│
├── lib/                       # 🧠 純粋ロジック層 (核心)
│   └── sales/
│       └── calculate-profit.ts
│
└── data-io/                   # 🔌 副作用層 (核心)
    └── sales/
        └── get-sales-data.ts
~~~

## 4. 自動化による規約の強制

このアーキテクチャを「人の注意力」から「仕組み」へと昇華させるため、以下の自動化を導入する。

1.  **ESLintによる核心ルールの強制**:
    -   `lib`, `data-io` から `react`, `@remix-run/*` への `import` を禁止。
    -   `components` から `routes` への `import` を禁止。
    -   `components` 内での `loader`/`action` の `export` を禁止。

2.  **対話型CLIによる開発プロセスの標準化**:
    -   `npm run new` を実行すると、「どの層のファイル？」「サービス名は？」などを質問。
    -   回答に基づき、TDDの原則に従って実装ファイルとテストファイルを適切な場所に自動生成する。

## 5. 結論

我々は「5層」という言葉を捨て、**「目的駆動型の3大層分離アーキテクチャ」**を正式に採用する。

これにより、プロジェクトの品質の根幹である**テスト容易性**は「仕組み」によって固く守りつつ、日々の開発で最も触れることの多い**UI層**では、Remixのベストプラクティスに沿った柔軟で生産性の高い開発を許容する。

このバランスこそが、「持続可能でスケーラブルな高品質ソフトウェア」を生み出すための最適解である。
