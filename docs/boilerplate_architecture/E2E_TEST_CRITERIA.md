# E2Eテスト設計基準

## 1. 概要

このドキュメントは、プロジェクトで実装されるE2E (End-to-End) テストの品質を担保し、一貫性を保つための最低基準を定義します。
E2Eテストは、ユーザーの視点からアプリケーション全体の動作を保証する最後の砦です。

本基準は、`TDD_WORK_FLOW.md` で定義されている **Outside-In TDD** の開発プロセスと密接に連携します。最初にE2Eテストで「システムの振る舞いのゴール」を定義し、そのゴールを達成するために内側の実装を進める際の指針となります。

## 2. テスト設計の基本方針

- **ユーザーシナリオ中心**: テストは「ユーザーが何を達成したいか」というシナリオに基づいて設計します。技術的な実装の詳細ではなく、ユーザーの操作フローを検証します。
- **Happy Path First**: 開発の初期段階では、まず最も重要で正常なシナリオ（ハッピーパス）をE2Eテストとして実装し、開発のゴールを明確にします。
- **段階的な詳細化**: ハッピーパスのテストが成功した後、入力バリデーション、エラーハンドリング、境界値などの異常系テストを追加し、品質を段階的に向上させます。

---

## 3. 階層別テスト基準

Outside-In TDDの考え方に従い、外側のレイヤーから内側のレイヤーへとテストの関心事を掘り下げていきます。

### 3.1. 画面 (Screen) レベルのテスト

**目的**: ユーザーが特定のURLにアクセスした際の「第一印象」を保証します。ページが正しく描画され、ユーザーが次のアクションを起こせる状態にあることを確認します。

**最低基準**:
1.  **ページ表示**: 対象のURLにアクセスした際、サーバーエラー（5xx系）やクライアントエラー（4xx系）が発生せず、ページが正常に表示されること (HTTPステータス 200)。
2.  **主要要素の存在**: ページの `<h1>` タグや `<title>` タグなど、その画面を識別するための最も重要な要素が表示されていること。
3.  **セクションの描画**: その画面を構成する主要な機能単位（セクション）がすべて描画されていること。
    -   例: ユーザープロフィール画面であれば、「プロフィール情報セクション」「アクティビティ履歴セクション」などが表示されているかを確認します。

### 3.2. セクション (Section) レベルのテスト

**目的**: 画面を構成する特定の機能単位（例: ログインフォーム、商品一覧）が、ユーザーのアクションに対して期待通りに動作することを保証します。

**最低基準**:
1.  **主要アクションの実行**: そのセクションが担う最も重要なユーザーアクション（フォームの入力と送信、ボタンのクリックなど）が最後まで成功すること。
2.  **結果の検証**: アクション実行後、期待される結果が得られることを確認します。
    -   例: フォーム送信後に「成功しました」というメッセージが表示される、または別のページに正しく遷移する。
3.  **UIコンポーネントの存在**: そのセクションの機能を成立させるために不可欠なUIコンポーネント（入力フィールド、送信ボタン、データテーブルなど）が表示されていること。

### 3.3. UIコンポーネント (Component) レベルのテスト

**目的**: 個々のUI部品（ボタン、入力欄、ドロップダウンなど）のインタラクションと、それに応じた状態変化を保証します。E2Eテストでは、特に重要なコンポーネントの基本的な振る舞いを検証します。

**最低基準**:
1.  **インタラクションの検証**: ユーザーの操作（クリック、入力など）に対して、コンポーネントが視覚的に期待通り反応すること。
    -   例: クリックするとドロップダウンメニューが開く、タブを切り替えると表示内容が変わる。
2.  **バリデーションの検証**: 不正な値を入力してフォームを送信しようとした際に、適切なエラーメッセージが表示されること。
3.  **アクセシビリティの基本検証**: キーボードのTabキーで、主要なインタラクティブ要素（リンク、ボタン、入力欄）間をフォーカス移動できること。

---

## 4. テスト実装のヒント

- **`data-testid` の活用**: `getByTestId` を使用することで、CSSの変更に強い安定したテストを記述できます。
- **ユーザー中心のセレクタ**: `getByRole`, `getByLabelText` など、ユーザーが要素をどのように認識するかに基づいたセレクタを優先的に使用します。

---

## 5. 高度なテスト戦略: モデルベーステスト (MCP)

**目的**: 従来のシナリオベースのテストでは発見が困難な、複雑な操作の組み合わせによって発生するエッジケースのバグを自動的に検出します。これはUIの堅牢性を保証するための補完的なアプローチです。

**適用フェーズ**: `TDD_WORK_FLOW.md` の `Phase 3: E2E拡張` で、主要機能のHappy Pathが完成した後に導入します。

**テスト対象**:
- 状態が複雑に変化するインタラクティブなコンポーネント（例: フィルター機能、複数ステップのフォーム）。
- 複数のユーザーアクションが絡み合うセクション。

**実装方法**:
1.  **モデル定義**: テスト対象の「状態(state)」と「アクション(action)」を定義します。
2.  **不変条件定義**: どの状態でも常に維持されるべきルール（例: 「合計金額はマイナスにならない」）を `invariant` として定義します。
3.  **MCP実行**: MCPがモデルに基づいて操作を自動生成・実行し、不変条件が破られる（バグが発見される）操作シーケンスを報告します。