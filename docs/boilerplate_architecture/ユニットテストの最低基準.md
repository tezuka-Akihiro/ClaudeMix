# ユニットテストの最低基準（3大層分離アーキテクチャ）

## 1. このドキュメントの目的

このドキュメントは、**🎨UI層**、**🧠純粋ロジック層**、**🔌副作用層**の3つの層に分離されたアーキテクチャにおいて、各層の責務に応じたユニットテストの最低基準を定義します。

テストを実装する前にこの基準を確認することで、品質の高いテストを効率的に作成することを目指します。

### E2Eテストとの関係

本プロジェクトでは、ユーザー視点の振る舞いを保証するE2Eテストで開発のゴールを定義し、そのゴールを達成するために各層のユニットテストを実装する **Outside-In TDD** を採用しています。

ユニットテストは、E2Eテストを補完し、各機能部品のロジックを網羅的に検証する役割を担います。

---

## 🔌 `data-io` - 副作用層のテスト基準

> **テスト設計の方針**: 機能設計書の処理フローを参考に、入力データ・出力データ・ビジネスルールで定義された仕様を網羅する

## 正常系のテスト

* **目的**: 関数が「期待通りに正しく動作する」ことを保証します。
* **確認すべきこと**:
  * 想定される典型的な入力値を渡した際に、期待される出力値が正確に返ってくるか。
  * **例 (`process-reports.ts`)**: 有効なテストレポートとコードメトリクスのJSONを入力として渡した際、仕様通りの構造を持つ `VisualNode` の配列が生成されることを確認する。

## 異常系・エッジケースのテスト

* **目的**: 関数が「予期せぬ入力で壊れない」ことを保証します。
* **確認すべきこと**:
  * `null`, `undefined`, 空の配列 `[]`, 空のオブジェクト `{}` などを入力した場合に、関数がクラッシュせず、適切に `null` を返したり、空の配列を返したり、あるいはエラーをスローするか。
  * 数値や文字列の境界値（0, -1, 非常に大きな値, 空文字など）を扱えるか。
  * **例 (`process-reports.ts`)**: `testResults` が空の配列の場合や、必須フィールドが欠けた不正な形式のJSONを入力した場合に、エラーを投げるか、または空の `VisualNode` 配列を返すかを確認する。

## ビジネスロジックの境界値テスト

* **目的**: 関数が「ビジネスルールや計算ロジックの境界で正しく振る舞う」ことを保証します。
* **確認すべきこと**:
  * 計算ロジック（例: 複雑性の算出）が、入力値が0の場合や最大値の場合でも正しく機能するか。
  * 条件分岐（if文など）がある場合、全ての分岐パスを網羅するテストケースが存在するか。
  * **例 (`process-reports.ts`)**: コードの行数が0の場合や、仕様上の最大値の場合に、`VisualNode` の `size` や `complexity` が期待通りに計算されるかを確認する。

---

## 🎨 `routes` - UI層（Route）のテスト基準

> **テスト設計の方針**: 機能設計書の技術要件セクションで定義されたloader/actionのフローを網羅する

* **目的**: **データフロー担当**として、適切なデータ処理（純粋ロジック層・副作用層）を呼び出し、適切なUI（Component）にデータを渡すことを保証します。

## `loader` のテスト

* **確認すべきこと**:
  * リクエストのパラメータ（`params`, `request.url`）を正しく解釈し、適切な`data-io`関数を呼び出しているか。
  * `data-io`から受け取ったデータを、期待通りの形式（`json`）で返却しているか。

## `action` のテスト

* **確認すべきこと**:
  * フォームデータ（`FormData`）を正しく解析し、適切な`data-io`関数を呼び出しているか。
  * 処理成功時に、意図したページへリダイレクト（`redirect`）するか。
  * バリデーションエラー時に、エラー情報を含めて画面を再描画するか。

## エラーハンドリングのテスト

* **確認すべきこと**:
  * 存在しないデータを要求された場合に404エラー（`new Response("Not Found", { status: 404 })`）を正しくスローするか。

## Remix特有の注意点

* **テストファイルの配置**: `app/routes` 配下にテストファイル (`*.test.tsx`) を置くと、ビルド時にエラーが発生する可能性があります。Routeコンポーネントのテストは、**E2Eテストでカバーする**か、テストファイルを別の専用ディレクトリに配置するなどの工夫が必要です。

---

## 🎨 `components` - UI層（Component）のテスト基準

> **テスト設計の方針**: 画面仕様書のレイアウト、インタラクション設計を参考に、UIの表示パターンや操作フローを網羅する

* **目的**: **表示担当**として、プロパティを受け取りUIが仕様通りに描画され、ユーザーの操作に正しく反応することを保証します。

## レンダリングのテスト

* **確認すべきこと**:
  * 渡された`props`に基づいて、UIが正しく表示されるか。
  * データが存在する場合、空の場合、エラーの場合など、異なる状態で表示が切り替わるか。

## インタラクションのテスト

* **確認すべきこと**:
  * ボタンのクリックやフォームの入力など、ユーザーのアクションによって期待されるイベントハンドラが呼び出されるか。（`@testing-library/user-event` を推奨）

## アクセシビリティのテスト

* **確認すべきこと**:
  * `getByRole` や `getByLabelText` など、アクセシビリティを意識したセレクタで要素を取得できるか。

## E2Eテストとの役割分担

* **ユニットテストの責務**: コンポーネントの基本的なレンダリングと、イベントハンドラが呼び出されることの確認に集中します。
* **E2Eテストの責務**: クリップボードAPI (`navigator.clipboard`) や複雑なキーボード操作など、**ブラウザ環境に強く依存するインタラクション**のテストはE2Eテストに任せます。ユニットテスト（JSDOM環境）でこれらを完全に模倣するのは困難かつ非効率なためです。

---

## 🧠 `lib` - 純粋ロジック層のテスト基準

> **テスト設計の方針**: 機能設計書の**純粋ロジック要件**を参考に、副作用のないビジネスロジックを検証する

* **目的**: **副作用のない純粋関数**として、ビジネスロジック・計算・データ変換が確実性を持って動作することを保証します。
* **重要**: **カバレッジ100%を目標**とし、全ての分岐・エッジケースを網羅します。

## 純粋性の保証テスト

* **確認すべきこと**:
  * 同じ入力に対して常に同じ出力を返す（決定論的であること）
  * 外部状態を変更しない（副作用がないこと）
  * 入力データを変更しない（イミュータブルであること）

## ビジネスロジックの完全テスト

* **確認すべきこと**:
  * 正常系: 想定される全ての入力パターンで正しい結果を返すか
  * 異常系・エッジケース: null, undefined, 空値、境界値での適切な処理
  * 境界値: 最小値・最大値・ゼロ・負数での計算精度
  * 全分岐パス: if文、switch文、三項演算子の全てのパスを実行

## データ変換・バリデーションテスト

* **確認すべきこと**:
  * 型変換の正確性とエラーハンドリング
  * バリデーションルールの完全実装
  * データ構造の変換における情報損失の防止

**重要**: 純粋ロジック層は最も予測可能でテストしやすい層のため、**100%のテストカバレッジ**を必須とします。

---

## テスト実装の推奨手順

1. **仕様書確認**: 対象機能の機能設計書・画面仕様書・外部変数仕様書を読み返す
2. **テスト項目洗い出し**: 上記基準に基づいて、具体的にテストすべき項目を列挙する
3. **テストデータ準備**: 正常系・異常系・境界値のテストデータを用意する
4. **RED実装**: 仕様に沿った期待値を設定し、まず失敗するテストを書く
5. **GREEN実装**: テストが通る最小限の実装を行う
6. **REFACTOR**: テストと実装の両方をリファクタリングする

**重要**: 各層のテスト基準を満たさないテストは、実装品質の低下につながります。

---

## テスト品質目標

大原則：NGを許容するテストは存在してはならない
TDDのレッドなど、開発中を除くテストの実施において、NGで放置することは許されません。

理由：技術的負債の管理コストを限りなくゼロにするため。

**アーキテクチャ統合テスト**: 各層間の連携が正しく動作することを、E2Eテストまたは統合テストで確認する。
