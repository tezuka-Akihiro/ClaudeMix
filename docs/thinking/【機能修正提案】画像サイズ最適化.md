# 【機能修正提案】画像サイズ最適化

- **サービス**: `blog`
- **セクション**: `common`, `posts`, `post-detail`
- **関連ドキュメント**:
  - `CloudMix 画像インフラ要件定義書.md`
  - `app/specs/blog/common-spec.yaml`
  - `app/components/blog/posts/PostCard.tsx`
  - `app/components/blog/post-detail/PostDetailSection.tsx`

---

## 1. 提案概要

画像インフラ要件定義に基づき、サムネイルおよび記事内画像のサイズ最適化（lg/sm）と、`srcset`を用いたレスポンシブな画像配信を実現します。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- 画像は単一のURL（`thumbnail.avif`など）で配信されている。
- デバイスサイズに関わらず同じサイズの画像が読み込まれる。
- 記事内画像の命名規則がシンプル（`1.avif`など）。

### 修正後 (To-Be)

- 画像は `lg` (1200px) と `sm` (600px) の2バリアントで提供される。
- `PostCard` および `PostDetailSection` で `srcset` を活用し、モバイル（767px以下）では `sm.avif` を、それ以上では `lg.avif` を読み込むように制御。
- 命名規則を `[filename].[size].avif` に統一。
  - サムネイル: `lg.avif` / `sm.avif`
  - 本文内画像: `1.lg.avif` 〜 `9.lg.avif`
- `buildThumbnailUrl` ロジックを更新し、バリアント対応のURLを生成可能にする。

## 3. 背景・目的

### 背景

- Lighthouseのパフォーマンススコアを維持・向上させるため、適切な画像サイズの配信が不可欠。
- `CloudMix 画像インフラ要件定義書.md` による標準化を実装に反映させる必要がある。

### 目的

- **Lighthouseスコア向上**: 無駄な通信量を削減し、LCP（Largest Contentful Paint）を改善。
- **インフラ整合性**: R2での運用ルールとフロントエンドの実装を同期。
- **UX向上**: モバイル環境での高速な画像表示。

## 4. 変更の妥当性 (Pros / Cons)

`@ArchitectureGuardian` の視点に基づき、この変更がプロジェクトの設計思想に合致するかを評価します。

Pros (利点):

- デバイスに最適化された画像配信により、データ通信量を削減できる（Performance原則）。
- `srcset` を用いることで、ブラウザが最適な画像を自動選択できる。
- 命名規則の統一により、アセット管理が簡素化される（SSOT原則）。

Cons (懸念点):

- R2側に複数のバリアント（lg/sm）を用意する必要がある（本タスクではR2作業は対象外だが、前提となる）。
- 実装がわずかに複雑化する（`srcset`の管理など）。

**総合評価**:
パフォーマンス最適化は本プロジェクトの重要目標（Lighthouse 95+）の一つであり、インフラ要件に合わせた実装変更は**極めて妥当**であると判断します。

## 5 設計フロー

以下の設計ドキュメントを上から順に確認し、編集内容を追記して。

### 🗾GUIDING_PRINCIPLES.md
- **変更内容**: 「2. 遵守すべきアーキテクチャ原則」または「パフォーマンス最適化」の項に、画像インフラ要件（lg/smバリアント）に基づくレスポンシブ画像配信の原則を追記。
- **目的**: Lighthouseスコア向上と帯域節約を設計原則として明文化する。

### 📚️func-spec.md
- **common/func-spec.md**:
  - `buildThumbnailUrl.ts` の仕様変更: 単一URLの返却から、バリアント（lg/sm）を含むURLセットの生成に対応。
- **posts/func-spec.md**:
  - `PostCard.tsx` の要件更新: `<img>` タグにおいて `srcset` および `sizes` 属性を必須とし、デバイスサイズに応じた画像選択（767px以下でsm）を行う。
- **post-detail/func-spec.md**:
  - `PostDetailSection.tsx` の要件更新: 記事トップのサムネイルに `srcset` を適用。
  - `markdownConverter.ts` および `generate-blog-posts.js` の画像レンダラー更新: 本文内画像（`*.lg.avif`）に対して自動的に `sm` バリアントの `srcset` を生成・付与する。

### 🖼️uiux-spec.md
- **common/uiux-spec.md**:
  - 「画像配信戦略」セクションを追加。
  - ブレークポイント 767px (mobile-max) を境界とした `sm` / `lg` の切り替えルールを定義。
  - `aspect-ratio: 1200 / 630` (2:1に近い比率) を維持し、CLSを防止。

### 📋️spec.yaml
- **app/specs/blog/common-spec.yaml**:
  - `r2_assets` を拡張し、バリアント情報を定義。
    ```yaml
    variants:
      lg: "lg" # サフィックス
      sm: "sm"
    ```
  - `thumbnail.filename` などの設定をバリアント対応の構造に整理。

### 🗂️file_list.md
- **影響範囲**:
  - `app/lib/blog/common/buildThumbnailUrl.ts` (ロジック変更)
  - `app/components/blog/posts/PostCard.tsx` (UI変更)
  - `app/components/blog/post-detail/PostDetailSection.tsx` (UI変更)
  - `app/lib/blog/post-detail/markdownConverter.ts` (マークダウン変換ロジック)
  - `scripts/prebuild/generate-blog-posts.js` (プレビルド変換ロジック)
  - `app/specs/blog/types.ts` (型定義の更新)

### 🧬data-flow-diagram.md
- サムネイル生成フローにおいて、`slug` から `lgUrl` と `smUrl` の両方を生成し、コンポーネントがそれを受け取って `srcset` を出力する流れに更新。

## 6 TDD_WORK_FLOW.md 簡易版

以下の全項目に対して、実際のパスと編集内容を1行で記載して。
完全な計画ではなく、大枠がわかればよい。
特に、新規ファイルに関して把握したい。

### 👁️e2e-screen-test
- `tests/e2e/blog/image-optimization.spec.ts`: 記事一覧と詳細で画像に `srcset` と `sizes` が付与されているか、モバイルサイズで `sm` が選択されるかを検証。

### 👁️e2e-section-test
- 変更なし（screen-testに集約）

### 🎨CSS実装 (layer2.css, layer3.ts, layer4.ts)
- 変更なし（`aspect-ratio` は既存実装を維持）

### 🪨route
- 変更なし

### 🚧components.test
- `app/components/blog/posts/PostCard.test.tsx`: `thumbnailUrl` が `lg`/`sm` のセットを受け取り、`srcset` を出力するかテスト。
- `app/components/blog/post-detail/PostDetailSection.test.tsx`: 同様に詳細画面のサムネイルをテスト。

### 🪨components
- `app/components/blog/posts/PostCard.tsx`: `img` タグに `srcset` と `sizes` を追加。
- `app/components/blog/post-detail/PostDetailSection.tsx`: 同上。

### 🚧logic.test
- `app/lib/blog/common/buildThumbnailUrl.test.ts`: バリアント（lg/sm）対応のURL生成ロジックをテスト。
- `app/lib/blog/post-detail/markdownConverter.test.ts`: 本文内画像の `srcset` 生成をテスト。

### 🪨logic
- `app/lib/blog/common/buildThumbnailUrl.ts`: `lg` および `sm` のURLを返すように変更。

### 🚧data-io.test
- `app/data-io/blog/posts/fetchPosts.server.test.ts`: バリアントURL取得の統合テスト。

### 🪨data-io
- `app/data-io/blog/posts/fetchPosts.server.ts`: `thumbnailUrl` をオブジェクト（lg/sm）として取得するように変更。

### その他
- `scripts/prebuild/generate-blog-posts.js`: プレビルド時の画像レンダリングに `srcset` 追加。
- `app/specs/blog/types.ts`: `thumbnailUrl` の型を `string | null` から `string | { lg: string; sm: string } | null` に拡張。
- `app/specs/blog/common-spec.yaml`: バリアント定義の追加。
