# 決定ログ: commonセクションによるページコンテナ実装の責務定義

**日付**: 2025-10-13
**最終更新**: 2025-10-16
**ステータス**: ✅ 決定済み・実装完了
**影響範囲**: 開発フロー全体、テンプレート生成システム

---

## 1. 背景と問題点

### 1.1. 従来の開発フローにおける欠落

従来の開発フローでは、以下の点が明確に定義されていた:

- ✅ 個別セクション(`design-flow`, `implementation-flow`等)の実装手順
- ✅ 各セクション内のコンポーネント実装手順
- ✅ TDDサイクルに基づくテスト→実装→リファクタの流れ

しかし、**以下の点が開発フローから抜け落ちていた**:

- ❌ 個別セクションを統合する**ページコンテナ**の実装手順
- ❌ ページコンテナの実装責任者(どのセクションが担当するか)
- ❌ ページコンテナのE2Eテストファイルの初期作成タイミング

### 1.2. 具体的な問題の発生状況

**問題例**: service-nameサービスの開発時

~~~
app/routes/service-name.tsx  ← このファイルの実装手順が不明確
├── DesignFlowSection        ← 明確に定義されている
├── ImplementationFlowSection ← 明確に定義されている
└── Header/Footer            ← commonセクションの責務と認識されていたが、
                                ページコンテナ自体の責務が不明確だった
~~~

この欠落により:

1. **暗黙的な知識への依存**: 開発者が「誰かがやる」と認識し、責任の所在が不明確
2. **品質のばらつき**: ページコンテナの構造が統一されない
3. **実装漏れのリスク**: E2Eテストファイルの初期作成が忘れられる
4. **フロー文書との不整合**: `TDD_WORK_FLOW.md` で既存ファイルへの追記を前提としているが、初期作成手順が存在しない

## 2. 決定事項

### 2.1. 主要決定

サービス全体のページレイアウトを定義する**ページコンテナの実装責務を、`common`セクションが担う**ことを正式なルールとして決定する。

### 2.2. `common`セクションの責務定義

`common`セクションは、以下の2つの主要な責務を持つ:

#### (1) ページコンテナの実装

各セクションを統合するルートファイル（例: `app/routes/{service-name}.tsx`）を実装する。

**具体的な成果物**:

- ルートファイル: `app/routes/{service-name}.tsx`
- E2Eテストファイル: `tests/e2e/screen/{service-name}.screen.spec.ts`
- レイアウト定義: 各セクションの配置順序、スタイリング

**実装例**:

~~~tsx
// app/routes/service-name.tsx
import { Header } from "~/components/service-name/common/Header";
import { Footer } from "~/components/service-name/common/Footer";
import { DesignFlowSection } from "~/components/service-name/design-flow/DesignFlowSection";
import { ImplementationFlowSection } from "~/components/service-name/implementation-flow/ImplementationFlowSection";

export default function FlowAuditor() {
  return (
    <div className="min-h-screen flex flex-col">
      <Header />
      <main className="flex-1">
        <DesignFlowSection />
        <ImplementationFlowSection />
      </main>
      <Footer />
    </div>
  );
}
~~~

#### (2) 共通コンポーネントの実装

ヘッダーやフッターなど、サービス全体で共有されるコンポーネントを実装する。

**具体的な成果物**:

- Header コンポーネント
- Footer コンポーネント
- その他の共通UI要素

### 2.3. 実装順序の明確化

**重要**: `common`セクションは**最優先で実装**される。

1. **Phase 1**: `common`セクションの実装(ページコンテナ + Header/Footer)
2. **Phase 2以降**: 個別セクション(`design-flow`, `implementation-flow`等)の実装

この順序により、個別セクション実装時には既にページコンテナとE2Eテストファイルが存在している状態となる。

## 3. 決定の根拠と理由

### 3.1. 責務の一致性

**ページコンテナは「サービス全体で共有される骨格」である**

- 個別セクションは特定の機能に特化している(例: `design-flow`はフロー設計のみ)
- ページコンテナは全セクションを統合し、サービス全体の構造を定義する
- これは`common`セクションの「サービス全体で共有されるもの」という責務と完全に一致

### 3.2. 実装順序の整合性

**「最初に骨格を作る」という開発原則との整合**

| 観点 | `common`セクションのルール | ページコンテナの役割 | 整合性 |
|:---|:---|:---|:---|
| 実装タイミング | 最優先実装 | アプリケーションの骨格 | ✅ 一致 |
| 依存関係 | 他セクションが依存 | 各セクションを配置 | ✅ 一致 |
| テスト基盤 | E2Eテストの土台 | E2Eテストの対象 | ✅ 一致 |

### 3.3. プロセスの完全性

**開発フローの抜け穴を埋める**

従来のフローでは、以下のような暗黙的な前提が存在していた:

- ❌ 「ページコンテナは誰かが作る」
- ❌ 「E2Eテストファイルは最初からある」

この決定により:

- ✅ ページコンテナの実装責任者が明確化(`common`セクション)
- ✅ E2Eテストファイルの初期作成タイミングが明確化(Phase 1)
- ✅ `TDD_WORK_FLOW.md`のフロー分岐が正当化される

### 3.4. 保守性の向上

**統一されたページ構造パターン**

`common`セクションがページコンテナを担当することで:

- すべてのサービスで統一されたページ構造が実現
- ページコンテナのベストプラクティスが蓄積
- 新規サービス開発時のテンプレート化が容易

## 4. 影響範囲

この決定に伴い、以下の主要なテンプレートファイルが更新された。

### 4.1. `docs/REQUIREMENTS_ANALYSIS_PIPE.md`

`common`セクションの特別ルールに、ページコンテナの実装責務が明記された。

~~~markdown
## 📌 共通セクション (`common`) の特別ルール

1. **最優先実装**: `common`セクションは、他のどのセクションよりも**先に実装**してください。
2. **責務範囲**:
    -   **ページコンテナの実装**: 各セクションを統合し、サービス全体のレイアウトを定義するルートファイル（例: `app/routes/service-name.tsx`）の実装を担当します。
    -   **共通コンポーネントの実装**: ヘッダーやフッターなど、サービス全体で共有されるコンポーネントの実装を担当します。
~~~

### 4.2. `scripts/generate/templates/workflow/TDD_WORK_FLOW.md`

`TDD_WORK_FLOW.md`のテンプレートが更新され、`common`セクションとそれ以外のセクションで手順が**条件分岐**するようになった。

#### 分岐ロジック

テンプレート生成スクリプトは、`project.toml`の`section_id`を判定し、適切な手順を生成する:

~~~javascript
// scripts/generate/templates/workflow/TDD_WORK_FLOW.md の生成ロジック
const isCommonSection = section_id === "common";

if (isCommonSection) {
  // Phase 1: ページコンテナとE2Eテストファイルを新規作成
  generateInitialSetupPhase();
} else {
  // Phase 1: 既存ファイルへのテスト追記
  generateIncrementalTestPhase();
}
~~~

#### 具体的な手順の違い

| フェーズ | `common`セクション | その他のセクション |
|:---|:---|:---|
| **Phase 1** | E2Eテストファイル**新規作成** | 既存E2Eテストファイルへ**追記** |
| **Phase 2.1** | ページコンテナ**新規作成** | セクションコンポーネント作成 |
| **前提条件** | なし(最初のセクション) | ページコンテナが実装済み |

**実装例の比較**:

**`common`セクションの場合**:

~~~markdown
## Phase 1: E2Eファースト

1. `tests/e2e/screen/service-name.screen.spec.ts` を新規作成
2. ページ全体の基本的な表示をテスト
~~~

**その他のセクションの場合**:

~~~markdown
## Phase 1: E2Eファースト

前提: `tests/e2e/screen/service-name.screen.spec.ts` は実装済み

1. 既存ファイルにテストケースを追記
2. 新しいセクションの表示をテスト
~~~

### 4.3. `scripts/project.toml`

`common`セクションの目的に、ページコンテナの責務が明記された。

~~~toml
[services.service-name.sections.common]
name = "Common Components"
abstract_purpose = "サービス全体のページレイアウトと、共有コンポーネント（ヘッダー、フッターなど）の設計・実装を管理する。"
specific_purpose = "サービス全体のページコンテナ（例: app/routes/service-name.tsx）のレイアウトを定義し、その中に配置されるヘッダーとフッターの機能とUIを実装する。"
~~~

## 5. 実装結果と成果

### 5.1. 具体的な成果物

この決定に基づき、以下のファイルが更新・実装された:

| カテゴリ | ファイル | 状態 |
|:---|:---|:---|
| **テンプレート** | `docs/REQUIREMENTS_ANALYSIS_PIPE.md` | ✅ 更新済み |
| **テンプレート** | `scripts/generate/templates/workflow/TDD_WORK_FLOW.md` | ✅ 更新済み |
| **設定** | `scripts/project.toml` | ✅ 更新済み |
| **実装例** | `app/routes/service-name.tsx` | ✅ 実装済み |
| **テスト例** | `tests/e2e/screen/service-name.screen.spec.ts` | ✅ 実装済み |

### 5.2. 開発プロセスへの影響

#### Before (改善前)

~~~
❌ 問題点:
- ページコンテナの実装責任者が不明確
- E2Eテストファイルの初期作成タイミングが不明確
- TDD_WORK_FLOW.mdに「既存ファイルへ追記」と書いてあるが、
  最初のファイルはどこで作るのか説明がない
~~~

#### After (改善後)

~~~
✅ 改善結果:
- commonセクションがページコンテナを担当することが明確化
- Phase 1でE2Eテストファイルを新規作成する手順が明記
- commonセクションと他セクションでフローが適切に分岐
- 開発者が迷わず実装を進められる
~~~

### 5.3. 品質向上の効果

1. **一貫性の向上**: すべてのサービスで統一されたページ構造パターン
2. **保守性の向上**: ページコンテナのベストプラクティスが`common`セクションに集約
3. **テスタビリティの向上**: E2Eテストの基盤が最初から整備される
4. **開発速度の向上**: 明確な手順により迷いが減少

### 5.4. 今後の展開

この決定は、以下のような将来的な改善の土台となる:

- **テンプレート化**: ページコンテナの標準テンプレート作成
- **自動生成**: `npm run generate` でのページコンテナ自動生成
- **ベストプラクティス集**: commonセクション実装ガイドの充実
- **品質チェック**: ページコンテナ構造のlintルール追加

## 6. 結論

この改善により、これまで暗黙的だったページコンテナの実装が開発フローに**正式かつ明示的**に組み込まれた。

**達成したこと**:

- ✅ 開発フローの抜け穴を完全に塞いだ
- ✅ 責任の所在を明確化した
- ✅ プロセスの完全性を確保した
- ✅ 品質と一貫性を向上させた

**開発者への影響**:

- より明確な手順に従って迷うことなく実装を進められる
- ページコンテナの実装品質が向上
- ボイラープレート全体の保守性が向上

この決定は、**ボイラープレートの開発フローをより堅牢で信頼性の高いものにする重要な一歩**である。
