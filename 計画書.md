# PageSpeed Insights API 統合計画書

## 1. 背景と目的

Lighthouseスキルのスコア確認フェーズは、現在オペレーターによる手動測定に依存しています。このプロセスを自動化し、オペレーターの負担を軽減するため、PageSpeed Insights (PSI) APIを導入します。これにより、デプロイ済みURLに対する信頼性の高いスコアを迅速かつ自動的に取得することが可能になります。

## 2. 基本方針

- **使用API**: Google公式の [PageSpeed Insights API v5](https://developers.google.com/speed/docs/insights/v5/get-started) を使用します。
- **実行環境**: 本番URLに対してリモートで実行します。
- **対象URL**: `https://claudemix.dev` （`wrangler.toml` の `vars` から取得）
- **測定対象**: 4ページ × `mobile` のみ（合計4回のAPIコール）
- **APIキー**: `.dev.vars` に設定済みの `PAGESPEED_API_KEY` を使用します。

## 3. APIキーの取り扱い

**ステータス**: ✅ 取得済み・設定済み (`.dev.vars`)

スクリプトは以下の優先順位でAPIキーを読み込みます。

1. **`process.env.PAGESPEED_API_KEY`**: CI/CD環境など、環境変数として設定されている場合。
2. **`.dev.vars` ファイル**: ローカル実行時、プロジェクトルートの `.dev.vars` ファイルを解析して `PAGESPEED_API_KEY` を取得します。
3. **キーなし**: 上記いずれにもキーが存在しない場合（フォールバック）。

## 4. 変更ファイル一覧

| ファイル | 操作 | 概要 |
| :--- | :--- | :--- |
| `scripts/psi-measure.mjs` | 新規作成 | PSI APIを呼び出し、スコアを測定・レポートするスクリプト。 |
| `docs/paths.md` | 編集 | PSIスクリプトが参照する `base_url` を追加。 |
| `prompts/01-measure.md` | 編集 | スコア測定をAPIによる自動取得に変更（手動フォールバックは維持）。 |
| `prompts/04-verify.md` | 編集 | push後の再測定をAPIによる自動実行フローに変更。 |
| `SKILL.md` | 編集 | フロー説明を更新し、APIキー設定の案内を追加。 |

## 5. 実装詳細

### 5.1. `scripts/psi-measure.mjs` (新規作成)

- **種別**: Node.jsスクリプト (ES Modules, `fetch` API使用, 追加依存なし)
- **動作フロー**:
  1. APIキーを読み込みます（`process.env` → `.dev.vars` 解析 → なし）。
  2. 対象ページリストをループ処理します。
  3. 各ページに対してPSI API v5を呼び出します (`strategy=mobile`)。
  4. レスポンスから4カテゴリのスコアを抽出します。
  5. 基準値 (`Performance: 95`, `Accessibility: 100`, `Best Practices: 100`, `SEO: 100`) と比較します。
  6. Markdownテーブル形式のサマリーを標準出力します。
  7. 詳細なJSONレスポンスを `reports/` ディレクトリに保存します（将来の分析用）。
  8. 全ページが基準をクリアすれば `exit 0`、未達があれば `exit 1` で終了します。
- **APIエンドポイント**:

  ```
  https://www.googleapis.com/pagespeedonline/v5/runPagespeed?url=<URL>&category=performance&category=accessibility&category=best-practices&category=seo&strategy=mobile&key=<API_KEY>
  ```

- **レート制限対策**:
  - **APIキーあり**: リクエスト間に5秒の待機時間を設けます。
  - **APIキーなし**: リクエスト間に30秒の待機時間を設けます（約2分で完了）。
- **出力フォーマット例**:

  ```markdown
  ## Lighthouse Score Report (via PageSpeed Insights API)

  | ページ                  | Performance | Accessibility | Best Practices | SEO    | 判定 |
  | ----------------------- | ----------- | ------------- | -------------- | ------ | ---- |
  | /blog                   | 97 ✅       | 100 ✅        | 100 ✅         | 100 ✅ | PASS |
  | /blog/about-claudemix   | 95 ✅       | 100 ✅        | 100 ✅         | 100 ✅ | PASS |
  | /login                  | 93 ❌       | 100 ✅        | 100 ✅         | 100 ✅ | FAIL |
  | /register               | 94 ❌       | 100 ✅        | 100 ✅         | 100 ✅ | FAIL |

  **結果: 2/4 ページが全基準をクリア**
  ```

### 5.2. `docs/paths.md` (編集)

- `base_url: https://claudemix.dev` を追加し、PSIスクリプトから参照できるようにします。

### 5.3. `prompts/01-measure.md` (編集)

- Phase 1のフローを「APIによる自動スコア取得」に変更します。
- API実行が失敗した場合（レート制限など）に、オペレーターへ手動測定を依頼するフォールバック手順を設けます。

### 5.4. `prompts/04-verify.md` (編集)

- `push`完了後、オペレーターにデプロイ完了を確認します。
- デプロイ完了後、`scripts/psi-measure.mjs` を実行して自動で再測定するフローに変更します。

### 5.5. `SKILL.md` (編集)

- 測定フローを「APIによる自動測定（手動フォールバックあり）」に更新します。
- 注意事項にAPIキーの確認方法（`.dev.vars`）を追記します。

## 6. 検証手順

1. `node scripts/psi-measure.mjs` を直接実行し、スコアレポートが正しく出力されることを確認します。
2. `/lighthouse` スキルを実行し、Phase 1がAPI経由で自動測定されることを確認します。
3. APIキーを設定しない状態でも、待機時間が長くなるフォールバック処理が正常に動作することを確認します。

## 7. TODOリスト

- [ ] `scripts/psi-measure.mjs` を新規作成する
- [ ] `docs/paths.md` に `base_url` を追加する
- [ ] `prompts/01-measure.md` をAPI自動取得フローに変更する
- [ ] `prompts/04-verify.md` を自動再測定フローに変更する
- [ ] `SKILL.md` をAPI統合フローに更新する
- [ ] 動作確認（スクリプト単体テスト、スキル統合テスト）を実施する
