# spec.yaml - 外部変数仕様書
# 実装・テスト・仕様書で共通参照するリテラル値定義

# ==========================================
# メタデータ
# ==========================================
metadata:
  feature_name: "account-authentication"
  slug: "authentication"
  created_date: "2025-12-23"
  last_updated: "2025-12-23"
  version: "1.0.0"

# ==========================================
# テンプレート定義（anchor定義専用セクション）
# ==========================================
_templates:
  # フィールド共通デフォルト
  _field_defaults: &field_defaults
    required: true

  # メールフィールドベース
  _email_field_base: &email_field_base
    <<: *field_defaults
    name: "email"
    label: "メールアドレス"
    type: "email"
    placeholder: "example@example.com"

  # パスワードフィールドベース
  _password_field_base: &password_field_base
    <<: *field_defaults
    name: "password"
    label: "パスワード"
    type: "password"

# ==========================================
# サーバー処理設定 (Loader/Action)
# ==========================================
server_io:
  loader:
    # 既にログイン済みの場合のリダイレクト先
    authenticated_redirect: "/account"

  action:
    # 認証成功時のデフォルトリダイレクト先
    default_redirect: "/account"

    # actionの種類
    intents:
      register: "register"
      login: "login"
      logout: "logout"

# ==========================================
# ルーティング設定
# ==========================================
routes:
  register:
    path: "/register"
    title: "会員登録"
  login:
    path: "/login"
    title: "ログイン"
    # リダイレクトURLパラメータ名
    redirect_param: "redirect-url"
  logout:
    path: "/logout"
    # ログアウト後のリダイレクト先
    redirect_after: "/login"
  forgot_password:
    path: "/forgot-password"
    title: "パスワードリセット"

# ==========================================
# フォーム設定
# ==========================================
forms:
  register:
    fields:
      email:
        <<: *email_field_base
        autocomplete: "email"
      password:
        <<: *password_field_base
        placeholder: "8文字以上、大文字・小文字・数字を含む"
        autocomplete: "new-password"
      password_confirm:
        <<: *field_defaults
        name: "passwordConfirm"
        label: "パスワード確認"
        type: "password"
        placeholder: "パスワードを再入力してください"
        autocomplete: "new-password"

    submit_button:
      label: "登録する"
      loading_label: "登録中..."

    links:
      login:
        label: "既にアカウントをお持ちの方はこちら"
        path: "/login"

  login:
    fields:
      email:
        <<: *email_field_base
        autocomplete: "email"
      password:
        <<: *password_field_base
        placeholder: "パスワードを入力してください"
        autocomplete: "current-password"

    submit_button:
      label: "ログイン"
      loading_label: "ログイン中..."

    links:
      register:
        label: "新規会員登録はこちら"
        path: "/register"

  forgot_password:
    title: "パスワードリセット"
    description: "登録時のメールアドレスを入力してください。\nパスワードリセット用のリンクをお送りします。"
    fields:
      email:
        <<: *email_field_base
        autocomplete: "email"

    submit_button:
      label: "リセットリンクを送信"
      loading_label: "送信中..."

    links:
      login:
        label: "ログインに戻る"
        path: "/login"

    success_message: "パスワードリセットのメールを送信しました。メールをご確認ください。"

# ==========================================
# バリデーション設定
# ==========================================
validation:
  email:
    error_messages:
      required: "メールアドレスを入力してください"
      invalid_format: "有効なメールアドレスを入力してください"
      already_exists: "このメールアドレスは既に登録されています"

  password:
    error_messages:
      required: "パスワードを入力してください"
      too_short: "パスワードは8文字以上で入力してください"
      too_long: "パスワードは128文字以下で入力してください"
      weak: "パスワードは大文字、小文字、数字を含む必要があります"

  password_confirm:
    error_messages:
      required: "パスワード確認を入力してください"
      mismatch: "パスワードが一致しません"

# ==========================================
# エラーメッセージ設定
# ==========================================
error_messages:
  authentication:
    # セキュリティ原則: 具体的な失敗理由を開示しない
    invalid_credentials: "メールアドレスまたはパスワードが正しくありません"
    account_locked: "アカウントがロックされています。しばらく時間をおいてから再度お試しください"
    session_creation_failed: "ログインに失敗しました。もう一度お試しください"

  registration:
    email_exists: "このメールアドレスは既に登録されています"
    creation_failed: "会員登録に失敗しました。もう一度お試しください"

  server:
    timeout: "処理がタイムアウトしました。もう一度お試しください"
    internal_error: "エラーが発生しました。しばらく時間をおいてから再度お試しください"

  password_reset:
    token_invalid: "トークンが無効です"
    token_verification_failed: "トークンの検証に失敗しました"
    token_expired: "トークンが無効または期限切れです"
    user_not_found: "ユーザーが見つかりません"
    update_failed: "パスワードの更新に失敗しました"

# ==========================================
# 成功メッセージ設定
# ==========================================
success_messages:
  registration:
    completed: "会員登録が完了しました"
  login:
    completed: "ログインしました"
  logout:
    completed: "ログアウトしました"

# ==========================================
# Flash Messages (URL parameter経由で表示)
# ==========================================
flash_messages:
  # セッション関連
  session-expired: "セッションの有効期限が切れました"
  unauthorized: "ログインが必要です"
  # ログアウト成功
  logout-success: "ログアウトしました"
  # パスワードリセット成功
  password-reset-success: "パスワードを再設定しました。新しいパスワードでログインしてください。"

# ==========================================
# セキュリティ設定
# ==========================================
security:
  # アカウントロック設定（将来実装）
  account_lock:
    enabled: false
    max_failed_attempts: 5
    lock_duration_seconds: 1800  # 30分

  # レート制限設定（将来実装）
  rate_limit:
    enabled: false
    max_requests_per_minute: 10

# ==========================================
# データベーススキーマ定義
# ==========================================
database:
  # usersテーブル定義
  users:
    table_name: "users"
    columns:
      id:
        type: "TEXT"
        constraints: "PRIMARY KEY"
        description: "ユーザーID（UUID）"
      email:
        type: "TEXT"
        constraints: "UNIQUE NOT NULL"
        description: "メールアドレス"
      password_hash:
        type: "TEXT"
        constraints: ""
        description: "ハッシュ化されたパスワード（OAuthのみの場合はNULL可）"
      oauth_id:
        type: "TEXT"
        constraints: ""
        description: "OAuthプロバイダー固有のユーザーID"
      oauth_provider:
        type: "TEXT"
        constraints: ""
        description: "OAuthプロバイダー名 (google等)"
      subscription_status:
        type: "TEXT"
        constraints: "NOT NULL"
        default: "'inactive'"
        description: "サブスクリプション状態: 'active', 'inactive'"
      created_at:
        type: "TEXT"
        constraints: "NOT NULL"
        description: "作成日時（ISO 8601形式）"
      updated_at:
        type: "TEXT"
        constraints: "NOT NULL"
        description: "更新日時（ISO 8601形式）"

    # インデックス定義
    indexes:
      - name: "idx_users_email"
        columns: ["email"]
        unique: true
      - name: "idx_users_oauth"
        columns: ["oauth_provider", "oauth_id"]
        unique: true

# ==========================================
# レスポンシブ設定
# ==========================================
responsive:
  # フォームコンテナ幅
  form_container:
    mobile: "100%"  # padding適用
    tablet: "480px"
    desktop: "480px"

# ==========================================
# アクセシビリティ設定
# ==========================================
accessibility:
  # ARIAラベル
  aria_labels:
    register_form: "会員登録フォーム"
    login_form: "ログインフォーム"
    email_field: "メールアドレス入力"
    password_field: "パスワード入力"
    password_confirm_field: "パスワード確認入力"
    submit_button: "フォーム送信"

  # エラーメッセージのaria-live設定
  error_announcement:
    aria_live: "assertive"
    aria_atomic: true

# ==========================================
# テスト設定
# ==========================================
test:
  # E2Eテスト用セレクタ
  selectors:
    register_form: "[data-testid='register-form']"
    login_form: "[data-testid='login-form']"
    email_input: "[data-testid='email-input']"
    password_input: "[data-testid='password-input']"
    password_confirm_input: "[data-testid='password-confirm-input']"
    submit_button: "[data-testid='submit-button']"
    error_message: "[data-testid='error-message']"
