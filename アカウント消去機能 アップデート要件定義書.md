# アカウント消去機能 アップデート要件定義書

## 1. 目的

ユーザー退会処理において、即時物理削除によるデータの不整合（Stripe Webhookのエラー等）を防ぎ、一定期間の「冬眠（論理削除）」を経て、個人情報を完全に抹消する自動化サイクルを構築する。

## 2. コア・コンセプト

- **「最小の努力で最大の結果」**: DB制約（Unique制約）を最大限活用し、複雑なコードを排す。
- **「構造的純粋さ」**: 30日経過後は、DBおよび外部サービス（Stripe）から個人情報を完全に排除する。
- **「優しい防衛」**: 間違えて退会したユーザーへの復旧手段を残しつつ、不正な再登録を防止する。

## 3. 機能要件

### ① 退会実行フェーズ（即時）

ユーザーが「退会ボタン」を押下した際の処理。

- **論理削除の実行**: `users` テーブルの `deleted_at` カラムに現在時刻を記録。
- **ログイン・アクセス遮断**: 全てのセッションを無効化し、以降のログインを拒否。
- **Stripeサブスクリプション停止**: 即時停止、または「期末キャンセル」を選択（ビジネスモデルに準拠）。
  - **重要**: `Customer` オブジェクトは削除せず保持（Webhookの受け皿として必要）。

### ② 冬眠フェーズ（1〜30日間）

データが「予約済み」として保持される期間。

- **再登録の制限**: 同一メールアドレスでの新規登録を試みた際、「退会手続き中です。復旧しますか？」等のメッセージを表示（または一律ブロック）。
- **Webhookの許容**: Stripeからの決済完了通知（按分計算の結果など）を、既存の `user_id` に正しく紐付けてログ出力。

### ③ 物理抹消フェーズ（31日目以降）

バッチ処理（Cronジョブ）によるクリーンアップ。

- **DB物理削除**: `deleted_at < NOW() - 30 days` のレコードを `DELETE`。
- **外部サービス連携解除**:
  - **Stripe**: `Customer` オブジェクトの削除リクエストを送信。
  - **メール配信ツール**: 配信リストからの完全削除。

## 4. データ構造（Schema設計案）

| カラム名 | 型 | 制約 | 備考 |
| :--- | :--- | :--- | :--- |
| `id` | UUID | PRIMARY KEY | 変更不可。再登録時は新IDを発行。 |
| `email` | String | UNIQUE | 冬眠中もUnique制約により重複登録を防止。 |
| `deleted_at` | DateTime | Nullable | NULL = アクティブ、値あり = 冬眠中。 |
| `stripe_customer_id` | String | Unique | 物理削除時にStripe APIを叩くキー。 |

## 5. Stripe連携の急所（記事の目玉）

- **按分（Apportionment）**: 退会実行時にStripe側で `proration_behavior: 'always'` を指定。冬眠期間中に最終的な差額決済が行われるため、DBにユーザーが残っている（冬眠中）ことで、決済ログが正しく着地できる。
- **べき等性の確保**: 物理削除後に遅れて届くWebhook（稀なケース）に対しては、404 ではなく 200 を返しつつ「対象ユーザー不在」をログに残すだけの「枯れた」設計にする。

## 6. 非機能要件

- **プライバシー保護**: 物理削除実行後は、いかなる手段（管理画面等）からも該当ユーザーを検索不可とする。
- **保守性**: バッチ処理の実行ログを残し、消去に失敗した場合はアラートを飛ばす。
