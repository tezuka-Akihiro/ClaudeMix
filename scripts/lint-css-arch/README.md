# CSS Architecture Linter (`lint-css-arch`)

## 1. 概要

このスクリプトは、`STYLING_CHARTER.md`で定義されたCSSアーキテクチャの規約を静的解析によって強制するためのLintツールです。

- **目的**: CSSとコンポーネント実装における規約違反を自動検出し、コードの品質と一貫性を維持します。
- **対象ファイル**:
  - Layer 1: `app/styles/globals.css`
  - Layer 2: `app/styles/{service}/layer2.css`
  - Layer 3: `app/styles/{service}/layer3.ts`
  - Layer 4: `app/styles/{service}/layer4.ts`
  - Layer 5: `app/components/{service}/**/*.tsx`
- **基本的な使い方**: `npm run lint:css-arch -- --service <サービス名>`

## 2. インストール

このスクリプトはプロジェクトに同梱されており、追加のインストールは不要です。

## 3. キーワードリスト (`keyword.json`)

このファイルは、各レイヤーのルールが参照するキーワードのリストを定義します。

- **パス**: `scripts/lint-css-arch/keyword.json`
- **責務**: ルールが使用する単語リストの提供。リストを「許可」と「禁止」のどちらで使うかは、各ルール実装に委ねられます。

### 設定内容

- **`layer1`**: Layer 1で禁止するキーワードのリスト。（例: `!important`）
- **`layer2`**: Layer 2で禁止するキーワードのリスト。（例: `display`, `margin`などのレイアウトプロパティ）
- **`layer3`**: Layer 3で禁止するキーワードのリスト。（例: `color`, `backgroundColor`などのスキンプロパティ）
- **`layer4`**: Layer 4で**許可**するキーワードのリスト。（例: `@keyframes`, `animation`などのアニメーション関連プロパティ）
- **`layer5`**: 将来的な拡張のために予約されています。Layer 5のルールは現在、`layer3.ts`から動的に許可リストを生成します。

## 4. ルール

### Layer 1: Foundation (`globals.css`)

- **責務**: デザインシステムの基盤となる原子値（色、スペース、フォントサイズなど）をCSS変数として定義します。
- **検証内容**:
  - `!important`の使用を禁止します。
  - CSS変数が他の変数を参照していないか（将来的に実装予定）。
  - `:root`スコープ外にスタイルが定義されていないか（将来的に実装予定）。

### Layer 2: Component Skin (`layer2.css`)

- **責務**: コンポーネントの「見た目」（スキン）を定義します。Layer 1の変数を参照して、具体的なコンポーネントのCSSクラスに色や背景を適用します。
- **検証内容**:
  - `keyword.json`の`layer2`リストに含まれるレイアウト関連プロパティの使用を禁止します。
  - `!important`の使用を禁止します。
  - **マジックナンバーの禁止**: すべての値は`var()`でLayer 1トークンを参照する必要があります。
    - ✅ 許可: `0`, `1`（単位なし、bool値として）
    - ✅ 許可: ショートハンド時の単位付き`0`（例: `margin: 0px 10px;`）
    - ❌ 禁止: 単一値の単位付き`0`（例: `margin: 0px;`）
    - ❌ 禁止: HEX色、px/rem/em値、%値など

### Layer 3: Component Structure (`layer3.ts`)

- **責務**: コンポーネントの「構造」（レイアウト）をTypeScriptのオブジェクトとして定義します。
- **検証内容**:
  - `keyword.json`の`layer3`リストに含まれるスキン関連プロパティの使用を禁止します。
  - `!important`の使用を禁止します。

### Layer 4: Structure Exceptions (`layer4.ts`)

- **責務**: アニメーション（`@keyframes`）や擬似要素など、Layer 3の構造定義の例外を扱います。
- **検証内容**:
  - `keyword.json`の`layer4`リストに含まれるキーワード以外の使用を禁止します。

### Layer 5: Implementation (`.tsx`, `.jsx`)

- **責務**: Reactコンポーネントを実装し、Layer 2-4で定義されたCSSクラスを適用します。
- **検証内容**:
  - Tailwind CSSのユーティリティクラス（`p-4`, `m-2`, `text-red-500`など）の直接使用を禁止します。

## 5. 使用方法

### Lintの実行

ターミナルで以下のコマンドを実行します。`--service`オプションは必須です。

```bash
npm run lint:css-arch -- --service <サービス名>
```

**例**:

```bash
npm run lint:css-arch -- --service service-name
```

### コマンドラインオプション

- `--service <name>`: (必須) 検査対象のサービス名を指定します。
- `--help`, `-h`: ヘルプメッセージを表示します。

### 結果の解釈

- **コンソール**: 違反があった場合、ファイルパス、行番号、違反内容、修正案のサマリーが表示されます。
- **レポートファイル**: より詳細な違反内容が`tests/lint/`ディレクトリにマークダウン形式で出力されます。

## 6. レポート

Lint実行後、以下のレポートファイルが`tests/lint/`に生成されます。

### `css-arch-layer-report.md`

- **対象**: Layer 1-4
- **目的**: CSSの定義層における違反を確認し、レイヤーを横断した修正方針を立てるために使用します。

### `impl-{component-name}.md`

- **対象**: Layer 5
- **目的**: Reactコンポーネント実装における違反をコンポーネント単位で確認し、修正するために使用します。
- **備考**: このレポートは違反が検出されたコンポーネントごとに個別のファイルとして生成されます。（例: `impl-Branch.md`）

## 7. AI連携

生成されたレポートファイルは、AI（例: Gemini, ChatGPT）との協調作業の起点として設計されています。

1. **レポートの共有**: レポートファイルの内容をAIに提供し、現状の規約違反を共有します。
2. **修正方針の議論**: 「この違反を修正したいが、既存のCSSクラスを流用できないか？」といった相談をAIに行います。
3. **修正コードの生成**: AIに具体的な修正コードを生成させ、レビューします。

## 8. トラブルシューティング

### 「対象ファイルなし」という警告が表示される

- **原因**: 指定されたサービスのレイヤーファイルが存在しない場合に表示されます。
- **対処法**: これはエラーではありません。開発途中でレイヤーがまだ作成されていない場合に表示される正常な警告です。
