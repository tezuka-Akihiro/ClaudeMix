#!/usr/bin/env node

/**
 * ãƒ—ãƒªãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: Spec YAMLãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒ³ãƒ‰ãƒ«ç”Ÿæˆ
 *
 * ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«å®Ÿè¡Œã•ã‚Œã€YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰
 * TypeScriptãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ã€‚Cloudflare Workersã§ã¯
 * ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ããªã„ãŸã‚ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’
 * ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
 */

import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';
import yaml from 'js-yaml';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.join(__dirname, '../..');

/**
 * Spec YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒãƒ³ãƒ‰ãƒ«ã™ã‚‹
 */
async function generateSpecs() {
  try {
    console.log('ğŸš€ Starting specs generation...');

    const specsDir = path.join(rootDir, 'app/specs');
    const outputPath = path.join(rootDir, 'app/generated/specs.ts');

    // 1. app/specsé…ä¸‹ã®ã™ã¹ã¦ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
    const specs = {};
    const sharedSpecs = {};
    const services = await fs.readdir(specsDir);

    for (const service of services) {
      const servicePath = path.join(specsDir, service);
      const stat = await fs.stat(servicePath);

      if (!stat.isDirectory()) continue;

      const files = await fs.readdir(servicePath);
      const yamlFiles = files.filter(file => file.endsWith('-spec.yaml'));

      for (const file of yamlFiles) {
        const specPath = path.join(servicePath, file);

        try {
          const yamlString = await fs.readFile(specPath, 'utf-8');
          const parsedSpec = yaml.load(yamlString);

          // sharedãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å ´åˆã¯åˆ¥ç®¡ç†
          if (service === 'shared') {
            const specName = file.replace('-spec.yaml', '').replace('project-', ''); // 'project-spec.yaml' -> 'project'
            sharedSpecs[specName] = parsedSpec;
            console.log(`   âœ… Loaded shared spec: ${specName}`);
          } else {
            const sectionName = file.replace('-spec.yaml', '');
            const featurePath = `${service}/${sectionName}`;
            specs[featurePath] = parsedSpec;
            console.log(`   âœ… Loaded spec: ${featurePath}`);
          }
        } catch (error) {
          console.error(`   âŒ Failed to load spec ${specPath}:`, error.message);
        }
      }
    }

    console.log(`ğŸ“ Found ${Object.keys(specs).length} section specs`);
    console.log(`ğŸ“ Found ${Object.keys(sharedSpecs).length} shared specs`);

    // 2. TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
    const tsContent = `// Auto-generated by scripts/prebuild/generate-specs.js
// Do not edit manually - this file is regenerated on every build

/**
 * Spec ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ç”Ÿæˆï¼‰
 *
 * ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ãƒ“ãƒ«ãƒ‰æ™‚ã«YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
 * Cloudflare Workersã§ã¯ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚¢ã‚¯ã‚»ã‚¹ãŒã§ããªã„ãŸã‚ã€
 * ãƒ“ãƒ«ãƒ‰æ™‚ã«ã™ã¹ã¦ã®specã‚’ãƒãƒ³ãƒ‰ãƒ«ã—ã¦ã„ã¾ã™ã€‚
 */

/**
 * ã‚»ã‚¯ã‚·ãƒ§ãƒ³specï¼ˆã‚µãƒ¼ãƒ“ã‚¹/ã‚»ã‚¯ã‚·ãƒ§ãƒ³å˜ä½ï¼‰
 */
const specs: Record<string, unknown> = ${JSON.stringify(specs, null, 2)};

/**
 * å…±é€šspecï¼ˆã‚µãƒ¼ãƒ“ã‚¹æ¨ªæ–­ï¼‰
 */
const sharedSpecs: Record<string, unknown> = ${JSON.stringify(sharedSpecs, null, 2)};

/**
 * ã‚»ã‚¯ã‚·ãƒ§ãƒ³specã‚’å–å¾—
 * @param featurePath 'blog/posts' ã®ã‚ˆã†ãªæ©Ÿèƒ½ãƒ‘ã‚¹
 * @returns ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ã®Specã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export function getSpec<T>(featurePath: string): T {
  if (!specs[featurePath]) {
    throw new Error(\`Spec not found for feature: \${featurePath}\`);
  }
  return specs[featurePath] as T;
}

/**
 * å…±é€šspecã‚’å–å¾—
 * @param specName 'validation', 'responsive', 'server', 'project' ã®ã„ãšã‚Œã‹
 * @returns ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ã®SharedSpecã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 */
export function getSharedSpec<T>(specName: string): T {
  if (!sharedSpecs[specName]) {
    throw new Error(\`Shared spec not found: \${specName}\`);
  }
  return sharedSpecs[specName] as T;
}

/**
 * èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®specæ©Ÿèƒ½ãƒ‘ã‚¹ã‚’å–å¾—
 */
export function getAllSpecPaths(): string[] {
  return Object.keys(specs);
}

/**
 * èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã™ã¹ã¦ã®å…±é€šspecåã‚’å–å¾—
 */
export function getAllSharedSpecNames(): string[] {
  return Object.keys(sharedSpecs);
}
`;

    // 3. å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
    const outputDir = path.dirname(outputPath);
    await fs.mkdir(outputDir, { recursive: true });

    // 4. ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›¸ãå‡ºã—
    await fs.writeFile(outputPath, tsContent, 'utf-8');
    console.log(`âœ… Generated ${outputPath}`);

    console.log('\nâœ¨ Specs generation completed successfully!');
    console.log(`\nğŸ“Š Summary:`);
    console.log(`   - Section specs: ${Object.keys(specs).length}`);
    console.log(`   - Shared specs: ${Object.keys(sharedSpecs).length}`);
  } catch (error) {
    console.error('âŒ Failed to generate specs:', error);
    process.exit(1);
  }
}

// ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
generateSpecs();
