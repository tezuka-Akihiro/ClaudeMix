# 【機能修正提案】サブスクリプション管理機能の実装と構造変更

- **サービス**: `account`
- **セクション**: `subscription`, `profile`
- **関連ドキュメント**:
  - `develop/account/subscription/func-spec.md`
  - `develop/account/subscription/uiux-spec.md`
  - `app/specs/account/subscription-spec.yaml`
  - `app/specs/account/profile-spec.yaml`

---

## 1. 提案概要

サブスクリプション管理を「プラン状態の表示」と「自動更新の制御」に分離し、購入済み期間のアクセス権を完全に保証する「権利全う型」のモデルへ移行します。また、Google認証情報のDB紐付けを強化し、決済不履行時の即時制限を実装します。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- サブスクリプション管理画面で「キャンセル」ボタンを押すと、即時または期間終了時の挙動が曖昧。
- ユーザー設定画面にはサブスクリプションの状態（アクティブ/未契約）のみが表示されている。
- `subscription_status` は 'active' か 'inactive' の簡易的な管理が中心。
- 決済不履行時の挙動が未定義または猶予期間がある可能性がある。
- Google認証の `sub` は `oauth_id` として保存されているが、名称が汎用的。

### 修正後 (To-Be)

- **権利の全う**: キャンセルは「自動更新の中断」として扱い、期間終了までアクセス権を維持。中途解約（即時停止）の概念を排除。
- **UIの役割分離**:
    - **サブスクリプション画面**: 「プラン状態の表示」に限定。プラン名、価格、`有効期限：YYYY/MM/DD（自動更新）` を表示。
    - **アカウント設定画面**: 「サブスクリプション状態」項目を追加し、自動更新のON/OFFを管理。
        - **自動更新ON時**: `[自動更新の中断に進む]` ボタンを表示。確認ダイアログで期間終了まで利用可能な旨を明示。
        - **自動更新OFF時**: `[自動更新を再開する]` ボタンを表示。次回決済日を明示（本日は決済されない旨も付記）。
- **プラン変更の制約**: 自動更新中断中はプラン変更ボタンを無効化。
- **ステータス管理と権限判定**:
    - Stripeの `subscription.status` をそのままDBに保存。
    - 権限判定は `status === 'active'` のみを真とする集約関数（Pure Logic層）で制御。
    - `past_due`（決済不履行）時は即座に制限。設定画面で「決済エラー」を明示。
- **DB紐付け**: Google認証の `sub` を `google_id` として扱う（既存の `oauth_id` を活用するか、必要に応じてエイリアス/カラム調整）。
- **バリデーション**: 自動更新ONの状態でのカード情報削除を禁止。

## 3. 背景・目的

### 背景

- サブスクリプションの解約時に「いつまで使えるのか」が不明確なのはユーザー体験を損なう。
- 自社DBでのステータス管理を簡略化しすぎると、Stripeとの同期ズレや複雑な状態管理が発生しやすい。
- 有料機能へのアクセス権限を厳格に管理する必要がある。

### 目的

- **目的1**: ユーザーに対する透明性の向上（期限と更新状態の明示による安心感の提供）。
- **目的2**: Stripeとの疎結合かつ厳格な同期の実現（SSoTとしてのStripeステータス尊重）。
- **目的3**: 安全な決済基盤の構築（意図しない課金防止と決済エラーへの迅速な対応）。

## 4. 変更の妥当性 (Pros / Cons)

Pros (利点):

- ユーザーの既得権（購入済み期間）を保証することで、信頼性が向上する。
- 自動更新の再開導線を設けることで、リテンション向上が期待できる。
- Stripeのステータスをそのまま保持するため、将来的なStripe側の機能拡張にも柔軟に対応できる。

Cons (懸念点):

- `past_due` 時の即時制限により、一時的なカードエラーでのユーザー離脱リスクがある。
- プラン変更時に「更新再開」を強いるため、ステップ数が増える（ただし整合性維持のため）。

**総合評価**:
ユーザーの権利を最大限に尊重しつつ、システム的にはStripeに寄り添ったシンプルな設計にするという方針は、メンテナンス性と信頼性の両面で**非常に妥当性が高い**と判断します。
