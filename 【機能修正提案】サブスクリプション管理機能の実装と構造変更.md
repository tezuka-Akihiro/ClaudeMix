# 【機能修正提案】サブスクリプション管理機能の実装と構造変更

- **サービス**: `account`
- **セクション**: `subscription`, `profile`
- **関連ドキュメント**:
  - `develop/account/subscription/func-spec.md`
  - `develop/account/subscription/uiux-spec.md`
  - `app/specs/account/subscription-spec.yaml`
  - `app/specs/account/profile-spec.yaml`

---

## 1. 提案概要

サブスクリプション管理を「プラン状態の表示」と「自動更新の制御」に分離し、購入済み期間のアクセス権を完全に保証する「権利全う型」のモデルへ移行します。また、Google認証情報のDB紐付けを強化し、決済不履行時の即時制限を実装します。

## 2. 変更内容 (As-Is / To-Be)

### 現状 (As-Is)

- サブスクリプション管理画面で「キャンセル」ボタンを押すと、即時または期間終了時の挙動が曖昧。
- ユーザー設定画面にはサブスクリプションの状態（アクティブ/未契約）のみが表示されている。
- `subscription_status` は 'active' か 'inactive' の簡易的な管理が中心。
- 決済不履行時の挙動が未定義または猶予期間がある可能性がある。
- Google認証の `sub` は `google_id` として保存されている（旧 `oauth_id` からリネーム）。

### 修正後 (To-Be)

- **権利の全う**: キャンセルは「自動更新の中断」として扱い、期間終了までアクセス権を維持。中途解約（即時停止）の概念を排除。
- **UIの役割分離**:
    - **サブスクリプション画面**: 「プラン状態の表示」に限定。プラン名、価格、`有効期限：YYYY/MM/DD（自動更新）` を表示。
    - **アカウント設定画面**: 「サブスクリプション状態」項目を追加し、自動更新のON/OFFを管理。
        - **自動更新ON時**: `[自動更新の中断に進む]` ボタンを表示。確認ダイアログで期間終了まで利用可能な旨を明示。
        - **自動更新OFF時**: `[自動更新を再開する]` ボタンを表示。次回決済日を明示（本日は決済されない旨も付記）。
- **プラン変更の制約**: 自動更新中断中はプラン変更ボタンを無効化。
- **ステータス管理と権限判定**:
    - Stripeの `subscription.status` をそのままDBに保存。
    - 権限判定は `status === 'active'` のみを真とする集約関数（Pure Logic層）で制御。
    - `past_due`（決済不履行）時は即座に制限。設定画面で「決済エラー」を明示。
- **DB紐付け**: Google認証の `sub` を `google_id` として扱う。
- **バリデーション**: 自動更新ONの状態でのカード情報削除を禁止。

## 3. 背景・目的

### 背景

- サブスクリプションの解約時に「いつまで使えるのか」が不明確なのはユーザー体験を損なう。
- 自社DBでのステータス管理を簡略化しすぎると、Stripeとの同期ズレや複雑な状態管理が発生しやすい。
- 有料機能へのアクセス権限を厳格に管理する必要がある。

### 目的

- **目的1**: ユーザーに対する透明性の向上（期限と更新状態の明示による安心感の提供）。
- **目的2**: Stripeとの疎結合かつ厳格な同期の実現（SSoTとしてのStripeステータス尊重）。
- **目的3**: 安全な決済基盤の構築（意図しない課金防止と決済エラーへの迅速な対応）。

## 4. 変更の妥当性 (Pros / Cons)

Pros (利点):

- ユーザーの既得権（購入済み期間）を保証することで、信頼性が向上する。
- 自動更新の再開導線を設けることで、リテンション向上が期待できる。
- Stripeのステータスをそのまま保持するため、将来的なStripe側の機能拡張にも柔軟に対応できる。

Cons (懸念点):

- `past_due` 時の即時制限により、一時的なカードエラーでのユーザー離脱リスクがある。
- プラン変更時に「更新再開」を強いるため、ステップ数が増える（ただし整合性維持のため）。

**総合評価**:
ユーザーの権利を最大限に尊重しつつ、システム的にはStripeに寄り添ったシンプルな設計にするという方針は、メンテナンス性と信頼性の両面で**非常に妥当性が高い**と判断します。

## 5 設計フロー

以下の設計ドキュメントを更新し、整合性を確保しました。

### 🗾GUIDING_PRINCIPLES.md
- 変更なし（既存の「3層分離」および「SSoT」原則に従う）。

### 📚️func-spec.md
- `develop/account/subscription/func-spec.md` を更新。
- 「権利の全う」核心思想を追記。
- `isSubscriptionAccessible` の判定ロジックを `status === 'active'` 限定に簡略化。
- `users` テーブルの `google_id` への変更を反映。

### 🖼️uiux-spec.md
- `develop/account/subscription/uiux-spec.md` を更新。
- サブスクリプション画面とアカウント設定画面の役割分離を定義。
- 自動更新の ON/OFF に伴うダイアログおよび注釈の文言を確定。

### 📋️spec.yaml
- `app/specs/account/subscription-spec.yaml`
    - 新しいステータスラベル（自動更新停止中）と、トグルボタン用のリテラルを追加。
- `app/specs/account/profile-spec.yaml`
    - 設定画面にサブスクリプションセクションを追加。

### 🗂️file_list.md
- `develop/account/subscription/file-list.md` を更新（大きな変更なし）。

### 🧬data-flow-diagram.md
- `develop/account/subscription/data-flow-diagram.md` を更新（ステータス同期フローの明確化）。

### 🛠️ DB スキーマ詳細
- `users.oauth_id` を `google_id` にリネーム。
- `users.subscription_status` および `subscriptions.status` に Stripe の生ステータスを格納することを明文化。

### 🧠 判定ロジックの集約
- `app/lib/account/subscription/isSubscriptionAccessible.ts` を SSoT とし、`status === 'active'` のみを真とする集約判定を実装。

### 🖼️ UI 状態遷移の動的制御
- 自動更新 ON/OFF と `current_period_end` の組み合わせによるボタン表示・活性/非活性制御の詳細を定義。

## 6 TDD_WORK_FLOW.md 簡易版

以下の手順で実装を進めています。

### 👁️e2e-screen-test
- `tests/e2e/account/subscription.spec.ts`: 設定画面での自動更新中断・再開フローのテスト。

### 👁️e2e-section-test
- 同上。

### 🎨CSS実装 (layer2.css, layer3.ts, layer4.ts)
- `app/styles/account/layer2-profile.css`: 設定画面の新セクション用スタイル調整。

### 🪨route
- `app/routes/account.subscription.tsx`: 表示専用への変更とプラン変更制限。
- `app/routes/account.settings.tsx`: `interrupt-renewal` / `resume-renewal` action の実装。
- `app/routes/api.webhooks.stripe.tsx`: 生ステータス同期の実装。

### 🚧components.test
- `app/components/account/profile/ProfileDisplay.test.tsx`: トグルボタンの表示切り替えテスト。

### 🪨components
- `app/components/account/profile/ProfileDisplay.tsx`: サブスクリプション設定項目の追加。

### 🚧logic.test
- `app/lib/account/subscription/isSubscriptionAccessible.test.ts`: 新しい判定ロジックの網羅テスト。

### 🪨logic
- `app/lib/account/subscription/isSubscriptionAccessible.ts`: 判定の厳格化。

### 🚧data-io.test
- `app/data-io/account/authentication/getUserByOAuth.server.test.ts`: `google_id` への変更対応。

### 🪨data-io
- `app/data-io/account/authentication/*.ts`: `oauth_id` -> `google_id` 置換。
- `app/data-io/account/subscription/*.ts`: SQLクエリの snake_case 対応とエイリアス修正。

### その他
- `migrations/update_subscription_schema.sql`: `oauth_id` -> `google_id` のリネームマイグレーション。
